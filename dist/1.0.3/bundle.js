!function(){function N(n,t){return t?require(n):n.slice?N[o(n)]:function(t,e){n(t={exports:{}}),N[o(e)]=t.exports};function o(t){return t.split("/").slice(-1).toString().replace(".js","")}}var s;"undefined"!=typeof module&&(s=module),N(function(t){String.random=function(t,e){var n="";for(t=t||24,e=e||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";0<t--;)n+=e.charAt(Math.floor(Math.random()*e.length));return n},String.match=function(t,e){var n,o;return"string"==typeof t&&(t===((e=(e="string"==typeof e?{"=":e}:e)||{})["="]||e["*"]||e[">"]||e["<"])||o===e["="]&&(n=e["*"]||e[">"],t.slice(0,(n||"").length)===n||o===e["*"]&&(o!==e[">"]&&o!==e["<"]?t>=e[">"]&&t<=e["<"]:o!==e[">"]&&t>=e[">"]||o!==e["<"]&&t<=e["<"])))},String.hash=function(t,e){if("string"==typeof t){if(e=e||0,t.length)for(var n=0,o=t.length;n<o;++n)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}};var e,n,o,r,i,a,s,u,c,f,p,l,h,y=Object.prototype.hasOwnProperty;Object.plain=function(t){return!!t&&(t instanceof Object&&t.constructor===Object||"Object"===Object.prototype.toString.call(t).match(/^\[object (\w+)\]$/)[1])},Object.empty=function(t,e){for(var n in t)if(y.call(t,n)&&(!e||-1==e.indexOf(n)))return!1;return!0},Object.keys=Object.keys||function(t){var e,n=[];for(e in t)y.call(t,e)&&n.push(e);return n},e=setTimeout,o=n=0,r=typeof setImmediate!=""+void 0&&setImmediate||e,e.hold=e.hold||9,e.poll=e.poll||function(t){e.hold>=+new Date-n&&o++<3333?t():r(function(){n=+new Date,t()},o=0)},l=setTimeout,a=l.turn=l.turn||function(t){1==s.push(t)&&u(f)},s=a.s=[],u=l.poll,c=0,f=function(){(i=s[c++])&&i(),c!=s.length&&99!=c||(s=a.s=s.slice(c),c=0),s.length&&u(f)},l=setTimeout,h=l.turn,(l.each=l.each||function(i,a,s,u){u=u||9,function t(e,n,o){if(n=(e=(i||[]).splice(0,u)).length){for(var r=0;r<n&&p===(o=a(e[r]));r++);if(p===o)return void h(t)}s&&s(o)}()})()})(N,"./shim"),N(function(t){t.exports=function t(e,n,o){if(!e)return{to:t};var r="function"==typeof n,e=(this.tag||(this.tag={}))[e]||r&&(this.tag[e]={tag:e,to:t._={next:function(t){var e;(e=this.to)&&e.next(t)}}});return r?(((r={off:t.off||(t.off=function(){if(this.next===t._.next)return!0;this===this.the.last&&(this.the.last=this.back),this.to.back=this.back,this.next=t._.next,this.back.to=this.to,this.the.last===this.the&&delete this.on.tag[this.the.tag]}),to:t._,next:n,the:e,on:this,as:o}).back=e.last||e).to=r,e.last=r):((e=e.to)&&void 0!==n&&e.next(n),e)}})(N,"./onto"),N(function(t){t.exports=function(t){return null===t||"string"==typeof t||"boolean"==typeof t||"number"==typeof t&&t!=1/0&&t!=-1/0&&t==t||!!t&&"string"==typeof t["#"]&&1===Object.keys(t).length&&t["#"]}})(N,"./valid"),N(function(t){function e(){var t=+new Date;return r=r<t?(n=0,t+e.drift):t+(n+=1)/o+e.drift}N("./shim");e.drift=0;var n=0,o=999,r=-1/0;e.is=function(t,e,n){t=e&&t&&t._&&t._[">"]||n;if(t)return"number"==typeof(t=t[e])?t:-1/0},e.ify=function(t,e,n,o,r){(t=t||{})._=t._||{},r&&(t._["#"]=r);r=t._[">"]||(t._[">"]={});return void 0!==e&&"_"!==e&&("number"==typeof n&&(r[e]=n),void 0!==o&&(t[e]=o)),t},t.exports=e})(N,"./state"),N(function(t){N("./shim"),t.exports=function(o){var r={s:{}},i=r.s,e=(o=o||{max:999,age:9e3},r.check=function(t){return!!i[t]&&e(t)},r.track=function(t){t=i[t]||(i[t]={});return t.was=r.now=+new Date,r.to||(r.to=setTimeout(r.drop,o.age+9)),t});return r.drop=function(n){r.to=null,r.now=+new Date;var t=Object.keys(i);console.STAT&&console.STAT(r.now,+new Date-r.now,"dup drop keys"),setTimeout.each(t,function(t){var e=i[t];e&&(n||o.age)>r.now-e.was||delete i[t]},0,99)},r}})(N,"./dup"),N(function(t){N("./onto"),t.exports=function(t,e){if(this.on){var n=(this.opt||{}).lack||9e3;if("function"!=typeof t){if(!t)return;var o=t["#"]||t,r=(this.tag||"")[o];return r?(e&&(r=this.on(o,e),clearTimeout(r.err),r.err=setTimeout(function(){r.off()},n)),!0):void 0}var i,o=e&&e["#"]||a(9);return t&&((i=this.on(o,t,e)).err=i.err||setTimeout(function(){i.off(),i.next({err:"Error: No ACK yet.",lack:!0})},n)),o}};var a=String.random||function(){return Math.random().toString(36).slice(2)}})(N,"./ask"),N(function(t){function u(t){return t instanceof u?(this._={$:this}).$:this instanceof u?u.create(this._={$:this,opt:t}):new u(t)}function m(t){if(t)if(t.out===m)this.to.next(t);else{var e,n,o,r=this.as,r=r.at||r,i=r.$,a=r.dup,s=t.DBG;if((o=t["#"])||(o=t["#"]=d(9)),!a.check(o)){if(a.track(o),o=t._,t._="function"==typeof o?o:function(){},t.$&&t.$===(t.$._||"").$||(t.$=i),t["@"]&&!t.put&&(o=(a=t)["@"]||"",(e=o._)?(e.acks=(e.acks||0)+1,(e.err=a.err)&&(a["@"]=e["#"],k(e)),e.ok=a.ok||e.ok,e.stop||e.crack||(e.crack=e.match&&e.match.push(function(){f(e)})),f(e)):(n=(n=(n=a.$)&&(n=n._)&&(n=n.root)&&n.dup).check(o))&&(a["@"]=n["#"]||a["@"])),!r.ask(t["@"],t)){if(s&&(s.u=+new Date),t.put)return void c(t);t.get&&u.on.get(t,i)}s&&(s.uc=+new Date),this.to.next(t),s&&(s.ua=+new Date),t.nts||t.NTS||(t.out=m,r.on("out",t),s&&(s.ue=+new Date))}}}function c(a){if(a){var s=a._||"",t=s.root=((s.$=a.$||"")._||"").root;if(a["@"]&&s.faith&&!s.miss)return a.out=m,void t.on("out",a);s.latch=t.hatch,s.match=t.hatch=[];var u,c,f,p,l,h,y,d,g,v=a.put,b=s.DBG=a.DBG,w=+new Date;e=e||w,v["#"]&&v["."]||(b&&(b.p=w),s["#"]=a["#"],s.msg=a,s.all=0,s.stun=1,u=Object.keys(v),console.STAT&&console.STAT(w,((b||s).pk=+new Date)-w,"put sort"),c=0,function t(e){if(f!=c){if(!(l=u[f=c]))return console.STAT&&console.STAT(w,((b||s).pd=+new Date)-w,"put"),void k(s);(h=v[l])?(g=h._)?l!==g["#"]?d=_+x(l)+"soul not same.":(y=g[">"])||(d=_+x(l)+"no state."):d=_+x(l)+"no meta.":d=_+x(l)+"no node.",p=Object.keys(h||{})}if(d)return a.err=s.err=d,void k(s);var n,o=0;for(e=e||0;e++<9&&(n=p[o++]);)if("_"!==n){var r=h[n],i=y[n];if(T===i){d=_+x(n)+"on"+x(l)+"no state.";break}if(!O(r)){d=_+x(n)+"on"+x(l)+"bad "+typeof r+x(r);break}!function t(e,n,o,r,i){var a,s=i._||"",u=s.root,c=u.graph;var f=c[o]||B,p=E(f,n,1),f=f[n];var l=s.DBG;!(a=console.STAT)||c[o]&&f||(a.has=(a.has||0)+1);c=A();if(c<r)return setTimeout(function(){t(e,n,o,r,i)},(a=r-c)>j?j:a),void(console.STAT&&console.STAT((l||s).Hf=+new Date,a,"future"));if(r<p&&!s.miss)return;if(!s.faith&&r===p&&(e===f||S(e)<=S(f))&&!s.miss)return;s.stun++;var h=i["#"]+s.all++,c={toString:function(){return h},_:s};c.toJSON=c.toString;u.dup.track(c)["#"]=i["#"];l&&(l.ph=l.ph||+new Date);u.on("put",{"#":c,"@":i["@"],put:{"#":o,".":n,":":e,">":r},ok:i.ok,_:s})}(r,n,l,i,a),++$}(p=p.slice(o)).length?D(t):(++c,p=null,t(e))}())}}function n(t){(n=(t._||"").DBG)&&(n.pa=+new Date,n.pm=n.pm||+new Date);var e,n=this.as,o=n.graph,r=t._,i=t.put,a=i["#"],s=i["."],u=i[":"],i=i[">"];t["#"];(e=r.msg)&&(e=e.put)&&(e=e[a])&&g(e,s,i,u,a),o[a]=g(o[a],s,i,u,a),(e=(n.next||"")[a])&&e.on("in",t),k(r),this.to.next(t)}function k(t,e){var n,o;t.stop||!t.err&&0<--t.stun||(t.stop=1,(n=t.root)&&((o=t.match).end=1,o===n.hatch&&(!(o=t.latch)||o.end?delete n.hatch:n.hatch=o),t.hatch&&t.hatch(),setTimeout.each(t.match,function(t){t&&t()}),!(e=t.msg)||t.err||e.err||(e.out=m,t.root.on("out",e),r())))}function f(t){t&&t.root&&(t.stun||t.acks!==t.all||t.root.on("in",{"@":t["#"],err:t.err,ok:t.err?T:t.ok||{"":1}}))}var e,_,x,S,j,A,$,r;function a(t,a){var s=+new Date,e=t._||{},u=e.DBG=t.DBG,c=t["#"],f=d(9),p=Object.keys(a||"").sort(),l=((a||"")._||"")["#"],h=(p.length,t.$._.root),y=a===h.graph[l];console.STAT&&console.STAT(s,((u||e).gk=+new Date)-s,"got keys"),a&&function t(){s=+new Date;for(var e,n,o,r=0,i={};r<9&&(e=p[r++]);)g(i,e,E(a,e),a[e],l);p=p.slice(r),(n={})[l]=i,i=n,y&&((o=function(){}).ram=o.faith=!0),n=p.length,console.STAT&&console.STAT(s,-(s-(s=+new Date)),"got copied some"),u&&(u.ga=+new Date),h.on("in",{"@":c,"#":f,put:i,"%":n?f=d(9):T,$:h.$,_:o,DBG:u}),console.STAT&&console.STAT(s,+new Date-s,"got in"),n&&setTimeout.turn(t)}(),a||h.on("in",{"@":t["#"]})}u.is=function(t){return t instanceof u||t&&t._&&t===t._.$||!1},u.version=.202,(u.chain=u.prototype).toJSON=function(){},N("./shim"),u.valid=N("./valid"),u.state=N("./state"),u.on=N("./onto"),u.dup=N("./dup"),u.ask=N("./ask"),u.create=function(t){t.root=t.root||t,t.graph=t.graph||{},t.on=t.on||u.on,t.ask=t.ask||u.ask,t.dup=t.dup||u.dup();var e=t.$.opt(t.opt);return t.once||(t.on("in",m,t),t.on("out",m,t),t.on("put",n,t),u.on("create",t),t.on("create",t)),t.once=1,e},u.on.put=c,_="Error: Invalid graph!",x=function(t){return" '"+(""+t).slice(0,9)+"...' "},S=JSON.stringify,j=2147483647,A=u.state,$=0,r=function(){999<$&&1<$/-(e-(e=+new Date))&&(u.window&&console.log("Syncing  more than 1K records per second"),r=function(){$=0})},u.on.get=function(t,e){var e=e._,n=t.get,o=n["#"],r=e.graph[o],n=n["."],i=((e.next||(e.next={}))[o],(t._||{}).DBG=t.DBG);if(i&&(i.g=+new Date),!r)return e.on("get",t);if(n){if("string"!=typeof n||T===r[n])return e.on("get",t);r=g({},n,E(r,n),r[n],o)}r&&a(t,r),e.on("get",t)},u.on.get.ack=a,u.chain.opt=function(n){n=n||{};var o=this._,t=n.peers||n;return Object.plain(n)||(n={}),Object.plain(o.opt)||(o.opt=n),"string"==typeof t&&(t=[t]),Object.plain(o.opt.peers)||(o.opt.peers={}),t instanceof Array&&(n.peers={},t.forEach(function(t){var e={};e.id=e.url=t,n.peers[t]=o.opt.peers[t]=o.opt.peers[t]||e})),i(n,function t(e){var n=this[e];this&&this.hasOwnProperty(e)||"string"==typeof n||Object.empty(n)?this[e]=n:(!n||n.constructor===Object||n instanceof Array)&&i(n,t)}),o.opt.from=n,u.on("opt",o),o.opt.uuid=o.opt.uuid||function(t){return u.state().toString(36).replace(".","")+String.random(t||12)},this};var T,o,i=function(t,e){Object.keys(t).forEach(e,t)},d=String.random,D=setTimeout.turn,O=u.valid,E=u.state.is,g=u.state.ify,B={};(u.log=function(){return u.log.off||o.log.apply(o,arguments),[].slice.call(arguments).join(" ")}).once=function(t,e,n){return(n=u.log.once)[t]=n[t]||0,n[t]++||u.log(e)},"undefined"!=typeof window&&((window.Database=u).window=window);try{void 0!==s&&(s.exports=u)}catch(t){}((t.exports=u).window||{}).console=(u.window||{}).console||{log:function(){}},(o=console).only=function(t,e){return o.only.i&&t===o.only.i&&o.only.i++&&(o.log.apply(o,arguments)||e)}})(N,"./root"),N(function(t){N("./root").chain.back=function(t,e){if(-1===(t=t||1)||1/0===t)return this._.root.$;if(1===t)return(this._.back||this._).$;var n=this._;if((t="string"==typeof t?t.split("."):t)instanceof Array){for(var o=0,r=t.length,i=n;o<r;o++)i=(i||s)[t[o]];return void 0!==i?e?this:i:(i=n.back)?i.$.back(t,e):void 0}if("function"!=typeof t)return"number"==typeof t?(n.back||n).$.back(t-1):this;for(var a,i={back:n};(i=i.back)&&void 0===(a=t(i,e)););return a};var s={}})(N,"./back"),N(function(t){var i=N("./root");function p(t,e){if(e=e||this.as||t.$._,(!t.$$||this===i.on)&&t.put&&!e.soul){var t=t.put||"",n=t["="]||t[":"],o=e.root,t=o.$.get(t["#"]).get(t["."])._;if("string"!=typeof(n=d(n)))this===i.on&&((t.echo||(t.echo={}))[e.id]=e);else if(!(t.echo||(t.echo={}))[e.id]||(o.pass||"")[e.id]){if(r=o.pass){if(r[n+e.id])return;r[n+e.id]=1}((t.echo||(t.echo={}))[e.id]=e).has&&(e.link=n);var r,o=o.$.get(t.link=n)._;(o.echo||(o.echo={}))[t.id]=t,((r=e.ask||"")[""]||e.lex)&&o.on("out",{get:{"#":n}}),setTimeout.each(Object.keys(r),function(t,e){t&&(e=r[t])&&e.on("out",{get:{"#":n,".":t}})},0,99)}}}function l(t,n){var o,e,r=t.put||"",r=h!==r["="]?r["="]:r[":"],i=n.root;h===r?n.soul&&h!==n.put||(e=(t.$$||t.$||"")._||"",t["@"]&&(h!==e.put||h!==n.put)||((o=n.link||t.linked)&&delete(i.$.get(o)._.echo||"")[n.id],n.has&&(n.link=null),n.put=h,setTimeout.each(Object.keys(n.next||""),function(t,e){(e=n.next[t])&&(o&&delete(i.$.get(o).get(t)._.echo||"")[e.id],e.on("in",{get:t,put:h,$:e.$}))},0,99))):n.soul||t.$$||(o=d(r),e=t.$._||"",(o!==e.link&&(!n.has||e.link)||(i.pass||"")[n.id]&&"string"!=typeof o)&&(delete(e.echo||"")[n.id],l({get:n.get,put:h,$:t.$,linked:t.linked=t.linked||e.link},n)))}function a(t,e){var n=this.as,o=n.$._,n=(o.root,n.get||""),r=(t.put||"")[n["#"]]||"";!t.put||"string"==typeof n["."]&&h===r[n["."]]?h===o.put&&(o.soul||o.has)&&(o.ack=(o.ack||0)+1,o.on("in",{get:o.get,put:o.put=h,$:o.$,"@":t["@"]})):((t._||{}).miss=1,i.on.put(t))}i.chain.chain=function(t){var e=this,n=e._,t=new(t||e).constructor(e),o=t._;return o.root=n=n.root,o.id=++n.once,o.back=e._,o.on=i.on,o.on("in",i.on.in,o),o.on("out",i.on.out,o),t},i.on.out=function(t){var e,n,o=this.as,r=o.back,i=o.root;if(t.$||(t.$=o.$),this.to.next(t),!o.err){if(e=t.get){if(i.pass&&(i.pass[o.id]=o),o.lex&&Object.keys(o.lex).forEach(function(t){n[t]=o.lex[t]},n=t.get=t.get||{}),e["#"]||o.soul){if(e["#"]=e["#"]||o.soul,t["#"]||(t["#"]=s(9)),r=i.$.get(e["#"])._,e=e["."]){if(u(r.put,e)&&(n=r.ask&&r.ask[e],(r.ask||(r.ask={}))[e]=r.$.get(e)._,r.on("in",{get:e,put:{"#":r.soul,".":e,":":r.put[e],">":g(i.graph[r.soul],e)}}),n))return}else{if(n=r.ask&&r.ask[""],(r.ask||(r.ask={}))[""]=r,h!==r.put&&(r.on("in",r),n))return;t.$=r.$}return i.ask(a,t),i.on("in",t)}if(e["."])return o.get?(t={get:{".":o.get},$:o.$},(r.ask||(r.ask={}))[o.get]=t.$._):t={get:o.lex?t.get:{},$:o.$},r.on("out",t);if(((o.ask||(o.ask={}))[""]=o).get)return e["."]=o.get,(r.ask||(r.ask={}))[o.get]=t.$._,r.on("out",t)}return r.on("out",t)}o.on("in",{put:o.put=h,$:o.$})},i.on.in=function(e,n){var o,t,r=(n=n||this.as).root,i=(e.$||(e.$=n.$)||"")._||y,a=e.put||"",s=a["#"],u=a["."],c=h!==a["="]?a["="]:a[":"],f=a[">"]||-1/0;if(h!==e.put&&(h===a["#"]||h===a["."]||h===a[":"]&&h===a["="]||h===a[">"]))return d(a)?void n.on("in",{$:i.back.$,put:{"#":s=i.back.soul,".":u=i.has||i.get,"=":a,">":g(i.back.put,u)},via:e}):(s=((a||"")._||"")["#"])?(o=n.root.$.get(s),setTimeout.each(Object.keys(a).sort(),function(t){"_"!=t&&h!==(f=g(a,t))&&n.on("in",{$:o,put:{"#":s,".":t,"=":a[t],">":f},VIA:e})})):void console.log("chain not yet supported for",a,"...",e,n);(e.seen||"")[n.id]||(((e.seen||(e.seen=function(){}))[n.id]=n)!==i&&(Object.keys(e).forEach(function(t){a[t]=e[t]},a={}),a.get=n.get||a.get,n.soul||n.has?i.soul&&(a.$=n.$,a.$$=a.$$||i.$):a.$$$=a.$$$||n.$,e=a),l(e,n),(n.soul||e.$$)&&f>=g(r.graph[s],u)&&((a=r.$.get(s)._).put=v(a.put,u,f,c,s)),!i.soul&&f>=g(r.graph[s],u)&&(t=(r.$.get(s)._.next||"")[u])&&(t.put=c,"string"==typeof(a=d(c))&&(t.put=r.$.get(a)._.put||c)),this.to&&this.to.next(e),n.any&&setTimeout.each(Object.keys(n.any),function(t){(t=n.any[t])&&t(e)},0,99),n.echo&&setTimeout.each(Object.keys(n.echo),function(t){(t=n.echo[t])&&t.on("in",e)},0,99),((e.$$||"")._||i).soul&&(t=n.next)&&(t=t[u])&&(a={},Object.keys(e).forEach(function(t){a[t]=e[t]}),a.$=(e.$$||e.$).get(a.get=u),delete a.$$,delete a.$$$,t.on("in",a)),p(e,n))},i.on.link=p,i.on.unlink=l;var h,y={},s=String.random,d=i.valid,u=function(t,e){return t&&Object.prototype.hasOwnProperty.call(t,e)},e=i.state,g=e.is,v=e.ify})(N,"./chain"),N(function(t){var d=N("./root");function i(t){var e=this.at||this.on;if(!t||e.soul||e.has)return this.off();if(t=(t=(t=t.$||t)._||t).id)return e.map,!!(e=this.seen||(this.seen={}))[t]||void(e[t]=!0)}d.chain.get=function(t,e,n){var o;if("string"==typeof t){if(0==t.length)return(r=this.chain())._.err={err:d.log("0 length key",t)},e&&e.call(r,r._.err),r;var r=(r=(r=((f=this._).next||a)[t])?r:t&&function(t,e){var n=e._,o=n.next,r=e.chain()._;o=o||(n.next={});o[r.get=t]=r,e===n.root.$?r.soul=t:(n.soul||n.has)&&(r.has=t);return r}(t,this))&&r.$}else{if("function"==typeof t){if(!0===e)return function(t,e,n){var a,s=t._,u=0;if(a=s.soul||s.link)return e(a,n,s);if(s.jam)return s.jam.push([e,n]);s.jam=[[e,n]],t.get(function(t,e){if(!(g===t.put&&!s.root.opt.super&&(a=Object.keys(s.root.opt.peers).length)&&++u<=a)){e.rid(t);var n=(n=t.$)&&n._||{},o=0;for(a=s.jam,delete s.jam;i=a[o++];){var r=i[0],i=i[1];r&&r(n.link||n.soul||d.valid(t.put)||((t.put||{})._||{})["#"],i,t,e)}}},{out:{get:{".":!0}}})}(this,t,n),this;var c,f=(r=this)._,p=e||{},l=f.root,h=(p.at=f,p.ok=t,{});function y(e,t,n){if(!y.stun&&(!(o=l.pass)||o[c])){var o,r=e.$._,i=(e.$$||"")._,a=(i||r).put,s=!r.has&&!r.soul,u={};if(!s&&g!==a||(a=g===((o=e.put)||"")["="]?g===(o||"")[":"]?o:o[":"]:o["="]),"string"==typeof(o=d.valid(a))&&(a=g===(o=l.$.get(o)._.put)?p.not?g:a:o),!p.not||g!==a){if(g===p.stun){if((o=l.stun)&&o.on&&(f.$.back(function(t){if(o.on(""+t.id,u={}),(u.run||0)<y.id)return u}),u.run||o.on(""+r.id,u={}),!u.run&&i&&o.on(""+i.id,u={}),y.id>u.run&&(u.stun&&!u.stun.end||(u.stun=o.on("stun"),u.stun=u.stun&&u.stun.last),u.stun&&!u.stun.end)))return void((u.stun.add||(u.stun.add={}))[c]=function(){y(e,t,1)});if(g===a&&(n=0),(o=l.hatch)&&!o.end&&g===p.hatch&&!n)return void(h[r.$._.id]||(h[r.$._.id]=1,o.push(function(){y(e,t,1)})));h={}}if(l.pass){if(l.pass[c+r.id])return;l.pass[c+r.id]=1}p.on?p.ok.call(r.$,a,r.get,e,t||y):p.v2020?p.ok(e,t||y):(Object.keys(e).forEach(function(t){o[t]=e[t]},o={}),(e=o).put=a,p.ok.call(p.as,e,t||y))}}}return(((y.at=f).any||(f.any={}))[c=String.random(7)]=y).off=function(){y.stun=1,f.any&&delete f.any[c]},y.rid=i,y.id=p.run||++l.once,o=l.pass,(l.pass={})[c]=1,p.out=p.out||{get:{}},f.on("out",p.out),l.pass=o,r}if("number"==typeof t)return this.get(""+t,e,n);if("string"==typeof(o=s(t)))return this.get(o,e,n);(o=this.get.next)&&(r=o(this,t))}return r?e&&"function"==typeof e&&r.get(e,n):((r=this.chain())._.err={err:d.log("Invalid get request",t)},e&&e.call(r,r._.err)),r};var g,a={},s=d.valid})(N,"./get"),N(function(t){var v=N("./root");function b(e,t){var n,o,r;t&&(t=(t._||"").id||t,n=e.root.stun||(e.root.stun={on:v.on}),o={},e.stun||(e.stun=n.on("stun",function(){})),(r=n.on(""+t))&&r.the.last.next(o),o.run>=e.run||n.on(""+t,function(t){if(e.stun.end)return this.off(),void this.to.next(t);t.run=t.run||e.run,t.stun=t.stun||e.stun}))}function w(e){var n,t,o,r,i;e.err?w.end(e.stun,e.root):e.todo.length||e.end||!Object.empty(e.wait)||(e.end=1,t=e.$.back(-1)._,n=t.root,t=t.ask(function(t){n.on("ack",t),t.err&&!t.lack&&v.log(t),++o>(e.acks||0)&&this.off(),e.ack&&e.ack(t,this)},e.opt),o=0,r=e.stun,(i=function(){r&&(w.end(r,n),setTimeout.each(Object.keys(r=r.add||""),function(t){(t=r[t])&&t()}))}).hatch=i,e.ack&&!e.ok&&(e.ok=e.acks||9),e.via._.on("out",{put:e.out=e.graph,ok:e.ok&&{"@":e.ok+1},opt:e.opt,"#":t,_:i}))}v.chain.put=function(t,e,d){var n,o,r=this,i=r._,a=i.root,g=((d=d||{}).root=i.root,d.run||(d.run=a.once),b(d,i.id),d.ack=d.ack||e,d.via=d.via||r,d.data=d.data||t,d.soul||(d.soul=i.soul||"string"==typeof e&&e),d.state=d.state||v.state());return"function"==typeof t?t(function(t){d.data=t,r.put(void 0,void 0,d)}):d.soul?(d.$=a.$.get(d.soul),d.todo=[{it:d.data,ref:d.$}],d.turn=d.turn||s,d.ran=d.ran||w,function t(){var e,n,r,i,a,o,s,u=d.todo,c=u.pop(),f=c.it;c.ref&&c.ref._.id;if(b(d,c.ref),(i=c.todo)&&(f=f[n=i.pop()],i.length&&u.push(c)),n&&(u.path||(u.path=[])).push(n),!(e=m(f))&&!(a=v.is(f))){if(!Object.plain(f))return void w.err(d,"Invalid data: "+((o=f)&&(s=o.constructor)&&s.name||typeof o)+" at "+(d.via.back(function(t){t.get&&i.push(t.get)},i=[])||i.join("."))+"."+(u.path||[]).join("."));for(var p=d.seen||(d.seen=[]),l=p.length;l--;)if(f===(i=p[l]).it){e=f=i.link;break}}if(n&&e)c.node=k(c.node,n,g,f);else{if(!d.seen)return void w.err(d,"Data at root of graph must be a node (an object).");d.seen.push(r={it:f,link:{},todo:a?[]:Object.keys(f).sort().reverse(),path:(u.path||[]).slice(),up:c}),c.node=k(c.node,n,g,r.link),!a&&r.todo.length&&u.push(r);var h=d.seen.length;function y(t,e){var n=r.link["#"],o=(e&&(e.off(),e.rid(t)),n||t.soul||(i=(t.$$||t.$)._||"").soul||i.link||((i=i.put||"")._||"")["#"]||i["#"]||((i=t.put||"")&&t.$$?i:i["="]||i[":"]||"")["#"]);n||b(d,t.$),o||c.link["#"]?(o||(o=[],(t.$$||t.$).back(function(t){if(i=t.soul||t.link)return o.push(i);o.push(t.get)}),o=o.reverse().join("/")),r.link["#"]=o,a||(((d.graph||(d.graph={}))[o]=r.node||(r.node={_:{}}))._["#"]=o),delete d.wait[h],r.wait&&setTimeout.each(r.wait,function(t){t&&t()}),d.ran(d)):(c.wait||(c.wait=[])).push(function(){y(t,e)})}(d.wait||(d.wait={}))[h]="",i=(r.ref=a?f:n?c.ref.get(n):c.ref)._,(i=f&&(f._||"")["#"]||i.soul||i.link)?y({soul:i}):r.ref.get(y,{run:d.run,v2020:1,out:{get:{".":" "}}})}if(!u.length)return d.ran(d);d.turn(t)}()):(i=(n=d).via._,n.via=n.via.back(function(t){if(t.soul||!t.get)return t.$;o=n.data,(n.data={})[t.get]=o}),n.via&&n.via._.soul||(n.via=i.root.$.get(((n.data||"")._||"")["#"]||i.$.back("opt.uuid")())),n.via.put(n.data,n.ack,n)),r},w.end=function(t,e){t.end=n,t.the.to===t&&t===t.the.last&&delete e.stun,t.off()},w.err=function(t,e){(t.ack||n).call(t,t.out={err:t.err=v.log(e)}),t.ran(t)};var n=function(){},s=setTimeout.turn,m=v.valid,k=v.state.ify})(N,"./put"),N(function(t){var e=N("./root");N("./chain"),N("./back"),N("./put"),N("./get"),t.exports=e})(N,"./index"),N(function(t){var d=N("./index");d.chain.on=function(t,e,n,o){var r=this._;r.root;if("string"==typeof t)return e?(o=r.on(t,e,n||r,o),n&&n.$&&(n.subs||(n.subs=[])).push(o),this):r.on(t);n=e;(n=!0===n?{change:!0}:n||{}).not=1,n.on=1;return this.get(t,n),this},d.chain.once=function(c,f){if(f=f||{},!c)return(n=(t=this).chain())._.nix=t.once(function(t,e){n._.on("in",this._)}),n._.lex=t._.lex,n;var t,n,p,l=this._,h=l.root,y=(l.put,String.random(7));return this.get(function(e,n,o,r){var i=this,a=i._,s=a.one||(a.one={});function u(t){a.has||a.soul||(a={put:e,get:n}),void 0===(p=a.put)&&(p=((o.$$||"")._||"").put),"string"!=typeof d.valid(p)||void 0!==(p=h.$.get(p)._.put)||t?r.stun||""!==s[y]&&(s[y]="",(l.soul||l.has)&&r.off(),c.call(i,p,a.get),clearTimeout(s[y])):s[y]=setTimeout(function(){u(1)},f.wait||99)}r.stun||""!==s[y]&&(!0===(p=d.valid(e))?u():"string"!=typeof p&&(clearTimeout((l.one||"")[y]),clearTimeout(s[y]),s[y]=setTimeout(u,f.wait||99)))},{on:1}),this},d.chain.off=function(){var n,t=this._,o=t.back;if(o)return t.ack=0,(n=o.next)&&n[t.get]&&delete n[t.get],(n=o.ask)&&delete n[t.get],(n=o.put)&&delete n[t.get],(n=t.soul)&&delete o.root.graph[n],(n=t.map)&&Object.keys(n).forEach(function(t,e){(e=n[t]).link&&o.root.$.get(e.link).off()}),(n=t.next)&&Object.keys(n).forEach(function(t,e){n[t].$.off()}),t.on("off",{}),this}})(N,"./on"),N(function(t){var s=N("./index"),o=s.chain.get.next;function u(t){this.to.next(t);var e=this.as,n=t.$._,o=t.put;!n.soul&&!t.$$||(n=e.lex)&&!String.match(t.get||(o||"")["."],n["."]||n["#"]||n)||s.on.link(t,e)}s.chain.get.next=function(t,e){var n;return Object.plain(e)?(n=((n=e["#"])||"")["="]||n)?t.get(n):((n=t.chain()._).lex=e,t.on("in",function(t){String.match(t.get||(t.put||"")["."],e["."]||e["#"]||e)&&n.on("in",t),this.to.next(t)}),n.$):(o||c)(t,e)},s.chain.map=function(i,t,e){var n,a,o=this,r=o._;return Object.plain(i)&&(n=i["."]?i:{".":i},i=void 0),i?(a=o.chain(),o.map().on(function(t,e,n,o){o=(i||c).call(this,t,e,n,o);if(void 0!==o){if(t===o)return a._.on("in",n);if(s.is(o))return a._.on("in",o._);var r={};Object.keys(n.put).forEach(function(t){r[t]=n.put[t]},r),r["="]=o,a._.on("in",{get:e,put:r})}})):(a=r.each)||((r.each=a=o.chain())._.lex=n||a._.lex||r.lex,a._.nix=o.back("nix"),o.on("in",u,a._)),a};var c=function(){}})(N,"./map"),N(function(t){var s=N("./index");s.chain.set=function(t,r,e){var n,i,a=this,o=a.back(-1);return r=r||function(){},(e=e||{}).item=e.item||t,(n=((t||"")._||"")["#"])&&((t={})["#"]=n),"string"==typeof(i=s.valid(t))?a.get(n=i).put(t,r,e):s.is(t)?(a.put(function(o){t.get(function(t,e,n){if(!t)return r.call(a,{err:s.log('Only a node can be linked. Not "'+n.put+'"!')});(i={})[t]={"#":t},o(i)},!0)}),t):(Object.plain(t)&&(t=o.get(n=a.back("opt.uuid")()).put(t)),a.get(n||o.back("opt.uuid")(7)).put(t,r,e))}})(N,"./set"),N(function(t){N("./shim");function e(){}var s=JSON.parseAsync||function(t,e,n){var o=+new Date;try{e(void 0,JSON.parse(t,n),_.sucks(+new Date-o))}catch(t){e(t)}},_=JSON.stringifyAsync||function(t,e,n,o){var r=+new Date;try{e(void 0,JSON.stringify(t,n,o),_.sucks(+new Date-r))}catch(t){e(t)}};_.sucks=function(t){99<t&&(console.log("JSON blocking CPU detected"),_.sucks=e)};var x;try{t.exports=function(u){var l,h=function(){},y=u.opt||{},d=(y.log=y.log||console.log,y.gap=y.gap||y.wait||0,y.max=y.max||.3*(y.memory?999*y.memory*999:3e8),y.pack=y.pack||.01*y.max*.01,y.puff=y.puff||9,setTimeout.turn||setTimeout),g=u.dup,v=g.check,b=g.track,r=(new Date,h.hear=function(t,a){if(t){if(y.max<=t.length)return h.say({dam:"!",err:"Message too big"},a);h===this&&(r.d+=t.length||0,++r.c);var e,n=a.SH=+new Date,o=t[0];if("["===o)return s(t,function(t,r){if(t||!r)return h.say({dam:"!",err:"JSON parse error"},a);console.STAT&&console.STAT(+new Date,r.length,"# on hear batch");var i=y.puff;!function t(){for(var e,n=+new Date,o=0;o<i&&(e=r[o++]);)h.hear(e,a);r=r.slice(o),console.STAT&&console.STAT(n,+new Date-n,"hear loop"),m(a),r.length&&d(t,0)}()}),void(t="");if("{"===o||(t["#"]||Object.plain(t))&&(e=t)){if(e)return r.one(e,a,n);s(t,function(t,e){if(t||!e)return h.say({dam:"!",err:"JSON parse error"},a);r.one(e,a,n)})}}}),w=(r.one=function(t,e,n){var o,r,i,a,s;if(t.DBG&&(t.DBG=s={DBG:t.DBG}),s&&(s.h=n),s&&(s.hp=+new Date),(o=t["#"])||(o=t["#"]=String.random(9)),!((i=v(o))||(r=t["##"])&&(i=t["@"]||t.get&&o)&&g.check(a=i+r))){if((t._=function(){}).via=h.leap=e,(i=t["><"])&&"string"==typeof i&&i.slice(0,99).split(",").forEach(function(t){this[t]=1},t._.yo={}),i=t.dam)return(i=h.hear[i])&&i(t,e,u),void b(o);(i=t.ok)&&(t._.near=i["/"]);n=+new Date;s&&(s.is=n),e.SI=o,u.on("in",h.last=t),s&&(s.hd=+new Date),console.STAT&&console.STAT(n,+new Date-n,t.get?"msg get":t.put?"msg put":"msg"),(i=b(o)).via=e,t.get&&(i.it=t),a&&b(a),h.leap=h.last=null}},r.c=r.d=0);function t(t,e){var n;return e instanceof Object?(Object.keys(e).sort().forEach(o,{to:n={},on:e}),n):e}function o(t){this.to[t]=this.on[t]}function m(t){var e=t.batch,n="string"==typeof e;if(n&&(e+="]"),t.batch=t.tail=null,e&&(n?!(e.length<3):e.length)){if(!n)try{e=1===e.length?e[0]:JSON.stringify(e)}catch(t){return y.log("JSON stringify error",t)}e&&k(e,t)}}function k(e,n){try{var t=n.wire;n.say?n.say(e):t.send&&t.send(e),h.say.d+=e.length||0,++h.say.c}catch(t){(n.queue=n.queue||[]).push(e)}}h.hash=function(o,r){var i,a,s,u=+new Date;_(o.put,function t(e,n){n=(a=a||(s=n||"")).slice(0,32768);i=String.hash(n,i),(a=a.slice(32768))?d(t,0):(console.STAT&&console.STAT(u,+new Date-u,"say json+hash"),o._.$put=s,o["##"]=i,h.say(o,r),delete o._.$put)},t)},h.say=function(i,t){var e;if((e=this)&&(e=e.to)&&e.next&&e.next(i),!i)return!1;var n,a,s=i["@"],u=i._||(i._=function(){}),o=i.DBG,r=+new Date;if(u.y=u.y||r,t||o&&(o.y=r),(n=i["#"])||(n=i["#"]=String.random(9)),l||b(n),i["##"]||x===i.put||u.via||!s){if(!(t=!t&&s?(e=g.s[s])&&(e.via||(e=e.it)&&(e=e._)&&e.via)||(e=h.last)&&s===e["#"]&&h.leap:t)&&s)return g.s[s]?void 0:(console.STAT&&console.STAT(+new Date,++w,"total no peer to ack to"),!1);if(!t&&h.way)return h.way(i);if(o&&(o.yh=+new Date),a=u.raw){if(o&&(o.yr=+new Date),!t||!t.id){if(!Object.plain(t||y.peers))return!1;var r=+new Date,c=(y.puff,y.peers),f=Object.keys(t||y.peers||{});return console.STAT&&console.STAT(r,+new Date-r,"peer keys"),void function t(){for(var e,n=+new Date,o=(l=1,u.raw),r=(u.raw=a,0);r<9&&(e=(f||"")[r++]);)(e=c[e])&&h.say(i,e);u.raw=o,l=0,f=f.slice(r),console.STAT&&console.STAT(n,+new Date-n,"say loop"),f.length&&(d(t,0),s&&b(s))}()}if(!t.wire&&h.wire&&h.wire(t),n!==t.last){if(t.last=n,t===u.via)return!1;if((e=u.yo)&&(e[t.url]||e[t.pid]||e[t.id]))return!1;if(console.STAT&&console.STAT(r,((o||u).yp=+new Date)-(u.y||r),"say prep"),!l&&s&&b(s),t.batch){if(t.tail=(e=t.tail||0)+a.length,t.tail<=y.pack)return void(t.batch+=(e?",":"")+a);m(t)}t.batch="[";var p=+new Date;setTimeout(function(){console.STAT&&console.STAT(p,+new Date-p,"0ms TO"),m(t)},y.gap),k(a,t),console.STAT&&s===t.SI&&console.STAT(r,+new Date-t.SH,"say ack")}}else h.raw(i,t)}else h.hash(i,t)},h.say.c=h.say.d=0,h.raw=function(n,o){if(!n)return"";var r,i=n._||{};if(s=i.raw)return s;if("string"==typeof n)return n;var t=n["##"],e=n["@"];if(t&&e){if(!i.via&&v(e+t))return!1;if((s=(g.s[e]||"").it)||(s=h.last)&&e===s["#"]){if(t===s["##"])return!1;s["##"]||(s["##"]=t)}}if(!n.dam&&!n["@"]){var a,s,u=0,c=[];for(a in s=y.peers){var f=s[a];if(c.push(f.url||f.pid||f.id),6<++u)break}1<u&&(n["><"]=c.join())}if(n.put&&(s=n.ok)&&(n.ok={"@":(s["@"]||1)-1,"/":s["/"]==n._.near?h.near:s["/"]}),r=i.$put)return s={},Object.keys(n).forEach(function(t){s[t]=n[t]}),s.put=":])([:",void _(s,function(t,e){t||(t=+new Date,s=e.indexOf('"put":":])([:"'),p(x,e=e.slice(0,s+6)+r+e.slice(s+14)),console.STAT&&console.STAT(t,+new Date-t,"say slice"))});function p(t,e){t||(i.raw=e,h.say(n,o))}_(n,p)},h.near=0,h.hi=function(e){var t;e.wire?(e.id?y.peers[e.url||e.id]=e:(t=e.id=e.id||String.random(9),h.say({dam:"?",pid:u.opt.pid},y.peers[t]=e),delete g.s[e.last]),e.met||(h.near++,e.met=+new Date,u.on("hi",e)),t=e.queue,e.queue=[],setTimeout.each(t||[],function(t){k(t,e)},0,9)):h.wire(e.length?{url:e,id:e}:e)},h.bye=function(t){t.met&&--h.near,delete t.met,u.on("bye",t);var e=+new Date;e-=t.met||e,h.bye.time=((h.bye.time||e)+e)/2},h.hear["!"]=function(t,e){y.log("Error:",t.err)},h.hear["?"]=function(t,e){t.pid&&(e.pid||(e.pid=t.pid),t["@"])||(h.say({dam:"?",pid:y.pid,"@":t["#"]},e),delete g.s[e.last])},h.hear.mob=function(t,e){!t.peers||(t=(t=Object.keys(t.peers))[Math.floor(Math.random()*t.length)])&&(h.bye(e),h.hi(t))},u.on("create",function(t){t.opt.pid=t.opt.pid||String.random(9),this.to.next(t),t.on("out",h.say)}),u.on("bye",function(t,e){t=y.peers[t.id||t]||t,this.to.next(t),t.bye?t.bye():(e=t.wire)&&e.close&&e.close(),delete y.peers[t.id],t.wire=null});var i={};return u.on("bye",function(t,e){this.to.next(t),(e=console.STAT)&&(e.peers=h.near),(e=t.url)&&(i[e]=!0,setTimeout(function(){delete i[e]},y.lack||9e3))}),u.on("hi",function(e,n){this.to.next(e),(n=console.STAT)&&(n.peers=h.near),(n=e.url)&&i[n]&&(delete i[n],y.super||setTimeout.each(Object.keys(u.next),function(t){u.next[t];(n={})[t]=u.graph[t],n=String.hash(n),h.say({"##":n,get:{"#":t}},e)}))}),h}}catch(t){}})(N,"./mesh"),N(function(t){var s=N("./index");s.Mesh=N("./mesh"),s.on("opt",function(t){var o,e,n,r;function i(e){try{if(!e||!e.url)return n&&n(e);var t=e.url.replace(/^http/,"ws"),n=e.wire=new o.WebSocket(t);return n.onclose=function(){o.mesh.bye(e),a(e)},n.onerror=function(t){a(e)},n.onopen=function(){o.mesh.hi(e)},n.onmessage=function(t){t&&o.mesh.hear(t.data||t,e)},n}catch(t){}}function a(e){clearTimeout(e.defer),!o.peers[e.url]||r&&e.retry<=0||(e.retry=(e.retry||o.retry+1||60)-(-e.tried+(e.tried=+new Date)<4*n?1:0),e.defer=setTimeout(function t(){if(r&&r.hidden)return setTimeout(t,n);i(e)},n))}this.to.next(t),t.once||!1!==(o=t.opt).WebSocket&&(e=s.window||{},(e=o.WebSocket||e.WebSocket||e.webkitWebSocket||e.mozWebSocket)&&(o.WebSocket=e,(e=o.mesh=o.mesh||s.Mesh(t)).wire||o.wire,e.wire=o.wire=i,setTimeout(function(){o.super||t.on("out",{dam:"hi"})},1),n=1998,r=""+void 0!=typeof document&&document))})})(N,"./websocket"),N(function(t){if("undefined"!=typeof Database){var r;try{r=(Database.window||function(){}).localStorage}catch(t){}r||(Database.log("No localStorage exists to persist data to"),r={setItem:function(t,e){this[t]=e},removeItem:function(t){delete this[t]},getItem:function(t){return this[t]}});JSON.parseAsync;var i=JSON.stringifyAsync||function(t,e,n,o){try{e(void 0,JSON.stringify(t,n,o))}catch(t){e(t)}};Database.on("create",function e(a){this.to.next(a);var s,u,c,f,o=a.opt,p=(a.graph,[]);if(!1!==o.localStorage){o.prefix=o.file||"db/";try{s=e[o.prefix]=e[o.prefix]||JSON.parse(c=r.getItem(o.prefix))||{}}catch(t){s=e[o.prefix]={}}c=(c||"").length,a.on("get",function(t){this.to.next(t);var e,n,o=t.get;o&&(e=o["#"])&&((n=s[e]||void 0)&&(o=o["."])&&!Object.plain(o)&&(n=Database.state.ify({},o,Database.state.is(n,o),n[o],e)),Database.on.get.ack(t,n))}),a.on("put",function(t){this.to.next(t);var e=t.put,n=e["#"],o=e["."],r=t["#"],i=t.ok||"";s[n]=Database.state.ify(s[n],o,e[">"],e[":"],n),f&&4999880<c?a.on("in",{"@":r,err:"localStorage max"}):(t["@"]||t._.via&&!(Math.random()<i["@"]/i["/"])||p.push(r),u=u||setTimeout(l,9+c/333))})}function l(){var n;!p.length&&((setTimeout.turn||"").s||"").length?setTimeout(l,99):(n=p,clearTimeout(u),u=!1,p=[],i(s,function(e,t){try{e||r.setItem(o.prefix,t)}catch(t){e=f=t||"localStorage failure"}e&&a.on("localStorage:error",{err:e,get:o.prefix,put:s}),c=t.length,setTimeout.each(n,function(t){a.on("in",{"@":t,err:e,ok:0})},0,99)}))}})}})(N,"./localStorage")}(),function(){var p,e,l,h,s,n,o,r,u,i,a,c,f,y,d,g,t,v,b,w,m,k,_,x,S;function j(t,e){w(this,e)&&void 0!==this[e]||(this[e]=t)}function A(t,e){var n=this.n;if(!n||!(e===n||v(n)&&w(n,e)))return void 0!==e||void 0}function $(t,e){if(2===arguments.length)return $.r=$.r||{},void($.r[t]=e);$.r=$.r||[],$.r.push(t)}function T(t,e){return!this.id&&e==n&&r(t)?void(this.id=t):this.id=!1}function D(t,e){if(e!==u._)return!s.is(t)||void(this.cb&&this.cb.call(this.as,t,e,this.n,this.s))}function O(t,e){var n,o=this.o;o.map?void 0===(n=o.map.call(this.as,t,""+e,o.node))?b(o.node,e):o.node&&(o.node[e]=n):s.is(t)&&(o.node[e]=t)}function E(t,e){y!==e&&c.ify(this.o,e,this.s)}function B(t,e){if(!t||e!==u.soul(t)||!u.is(t,this.fn,this.as))return!0;this.cb&&(N.n=t,N.as=this.as,this.cb.call(N.as,t,e,N))}function N(t){t&&u.is(N.n,t,N.as)}function C(t,e){var n;return(n=function(t,e){var n,o=t.seen,r=o.length;for(;r--;)if(n=o[r],e.obj===n.obj)return n;o.push(e)}(t,e))?n:(e.env=t,e.soul=I,u.ify(e.obj,U,e)&&(e.link=e.link||s.link.ify(u.soul(e.node)),e.obj!==t.shell&&(t.graph[s.link.is(e.link)]=e.node)),e)}function U(t,e,n){var o,r,i=this,a=i.env;if(u._===e&&w(t,s.link._))return n._;if(o=J(t,e,n,i,a)){if(e||(i.node=i.node||n||{},w(t,u._)&&u.soul(t)&&(i.node._=x(t._)),i.node=u.soul.ify(i.node,s.link.is(i.link)),i.link=i.link||s.link.ify(u.soul(i.node))),(r=a.map)&&(r.call(a.as||{},t,e,n,i),w(n,e))){if(t=n[e],S===t)return void b(n,e);if(!(o=J(t,e,n,i,a)))return}return e?!0===o?t:(r=C(a,{obj:t,path:i.path.concat(e)})).node?r.link:void 0:i.node}}function I(t){var e=this,n=s.link.is(e.link),o=e.env.graph;e.link=e.link||s.link.ify(t),e.link[s.link._]=t,e.node&&e.node[u._]&&(e.node[u._][s.link._]=t),w(o,n)&&(o[t]=o[n],b(o,n))}function J(t,e,n,o,r){var i;return!!s.is(t)||(v(t)?1:(i=r.invalid)?J(t=i.call(r.as||{},t,e,n),e,n,o,r):(r.err="Invalid value at '"+o.path.concat(e).join(".")+"'",void(p.list.is(t)&&r.err)))}function P(t,e){var n,o;u._===e?m(t,s.link._)||(this.obj[e]=x(t)):(n=s.link.is(t))?(o=this.opt.seen[n])?this.obj[e]=o:this.obj[e]=this.opt.seen[n]=d.to(this.graph,n,this.opt):this.obj[e]=t}""+S!=typeof Database&&((p=Database).fn=p.fn||{is:function(t){return!!t&&"function"==typeof t}},p.bi=p.bi||{is:function(t){return t instanceof Boolean||"boolean"==typeof t}},p.num=p.num||{is:function(t){return!h(t)&&(0<=t-parseFloat(t)+1||1/0===t||-1/0===t)}},p.text=p.text||{is:function(t){return"string"==typeof t}},p.text.ify=p.text.ify||function(t){return p.text.is(t)?t:"undefined"!=typeof JSON?JSON.stringify(t):t&&t.toString?t.toString():t},p.text.random=p.text.random||function(t,e){var n="";for(t=t||24,e=e||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";0<t;)n+=e.charAt(Math.floor(Math.random()*e.length)),t--;return n},p.text.match=p.text.match||function(t,e){var n,o;return"string"==typeof t&&(t===((e=(e="string"==typeof e?{"=":e}:e)||{})["="]||e["*"]||e[">"]||e["<"])||o===e["="]&&(n=e["*"]||e[">"]||e["<"],t.slice(0,(n||"").length)===n||o===e["*"]&&(o!==e[">"]&&o!==e["<"]?t>=e[">"]&&t<=e["<"]:o!==e[">"]&&t>=e[">"]||o!==e["<"]&&t<=e["<"])))},p.text.hash=p.text.hash||function(t,e){if("string"==typeof t){if(e=e||0,t.length)for(var n=0,o=t.length;n<o;++n)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}},p.list=p.list||{is:function(t){return t instanceof Array}},p.list.slit=p.list.slit||Array.prototype.slice,p.list.sort=p.list.sort||function(n){return function(t,e){return t&&e?(t=t[n])<(e=e[n])?-1:e<t?1:0:0}},p.list.map=p.list.map||function(t,e,n){return _(t,e,n)},p.list.index=1,p.obj=p.boj||{is:function(t){return!!t&&(t instanceof Object&&t.constructor===Object||"Object"===Object.prototype.toString.call(t).match(/^\[object (\w+)\]$/)[1])}},p.obj.put=p.obj.put||function(t,e,n){return(t||{})[e]=n,t},p.obj.has=p.obj.has||function(t,e){return t&&Object.prototype.hasOwnProperty.call(t,e)},p.obj.del=p.obj.del||function(t,e){if(t)return t[e]=null,delete t[e],t},p.obj.as=p.obj.as||function(t,e,n,o){return t[e]=t[e]||(o===n?{}:n)},p.obj.ify=p.obj.ify||function(e){if(!v(e))try{e=JSON.parse(e)}catch(t){e={}}return e},p.obj.to=p.obj.to||function(t,e){return _(t,j,e=e||{}),e},p.obj.copy=p.obj.copy||function(t){return t&&JSON.parse(JSON.stringify(t))},p.obj.empty=p.obj.empty||function(t,e){return!t||!_(t,A,{n:e})},l=Object.keys,Object.keys=Object.keys||function(t){return e(t,function(t,e,n){n(e)})},p.obj.map=e=p.obj.map||function(t,e,n){var o,r,i,a,s,u=0,c="function"==typeof e;if($.r=o,l&&v(t)&&(a=l(t),s=!0),n=n||{},h(t)||a)for(r=(a||t).length;u<r;u++){var f=u+p.list.index;if(c){if((i=s?e.call(n,t[a[u]],a[u],$):e.call(n,t[u],f,$))!==o)return i}else if(e===t[s?a[u]:u])return a?a[u]:f}else for(u in t)if(c){if(w(t,u)&&(i=n?e.call(n,t[u],u,$):e(t[u],u,$))!==o)return i}else if(e===t[u])return u;return c?$.r:p.list.index?0:-1},p.time=p.time||{},p.time.is=p.time.is||function(t){return t?t instanceof Date:+(new Date).getTime()},g=p.fn.is,h=p.list.is,v=(t=p.obj).is,w=t.has,_=t.map,(s={is:function(t){return t!==S&&(null===t||t!==1/0&&(!!(r(t)||o(t)||f(t))||(s.link.is(t)||!1)))}}).link=s.rel={_:"#"},s.link.is=function(t){if(t&&t[n]&&!t._&&v(t)){var e={};if(_(t,T,e),e.id)return e.id}return!1},s.link.ify=function(t){return k({},n,t)},p.obj.has._=".",n=s.link._,o=p.bi.is,f=p.num.is,r=p.text.is,t=p.obj,v=t.is,k=t.put,_=t.map,p.val=p.val||s,(u={_:"_"}).soul=function(t,e){return t&&t._&&t._[e||a]},u.soul.ify=function(t,e){return e="string"==typeof e?{soul:e}:e||{},(t=t||{})._=t._||{},t._[a]=e.soul||t._[a]||i(),t},u.soul._=s.link._,u.is=function(t,e,n){var o;return!!v(t)&&(!!(o=u.soul(t))&&!_(t,D,{as:n,cb:e,s:o,n:t}))},u.ify=function(t,e,n){return e?"string"==typeof e?e={soul:e}:"function"==typeof e&&(e={map:e}):e={},e.map&&(e.node=e.map.call(n,t,S,e.node||{})),(e.node=u.soul.ify(e.node||{},e))&&_(t,O,{o:e,as:n}),e.node},v=(t=p.obj).is,b=t.del,_=t.map,i=p.text.random,a=u.soul._,p.node=p.node||u,(c=p.state).lex=function(){return c().toString(36).replace(".","")},c.to=function(t,e,n){var o=(t||{})[e];return v(o)&&(o=x(o)),c.ify(n,e,c.is(t,e),o,u.soul(t))},c.map=function(r,i,a){var t=v(t=r||i)?t:null;return r=g(r=r||i)?r:null,t&&!r?(i=f(i)?i:c(),t[y]=t[y]||{},_(t,E,{o:t,s:i}),t):(a=a||v(i)?i:void 0,i=f(i)?i:c(),function(t,e,n,o){if(!r)return E.call({o:n,s:i},t,e),t;r.call(a||this||{},t,e,n,o),w(n,e)&&void 0===n[e]||E.call({o:n,s:i},t,e)})},(t=p.obj).as,w=t.has,v=t.is,_=t.map,x=t.copy,f=p.num.is,g=p.fn.is,y=u._,d={is:function(t,e,n,o){return!(!t||!v(t)||m(t))&&!_(t,B,{cb:e,fn:n,as:o})},ify:function(t,e,n){t={path:[],obj:t};return e?"string"==typeof e?e={soul:e}:"function"==typeof e&&(e.map=e):e={},"string"==typeof n&&(e.soul=e.soul||n,n=S),e.soul&&(t.link=s.link.ify(e.soul)),e.shell=(n||{}).shell,e.graph=e.graph||{},e.seen=e.seen||[],e.as=e.as||n,C(e,t),e.root=t.node,e.graph},node:function(t){var e=u.soul(t);if(e)return k({},e,t)},to:function(t,e,n){var o;if(t)return o={},_(t[e],P,{obj:o,graph:t,opt:n=n||{seen:{}}}),o}},g=p.fn.is,v=(t=p.obj).is,b=t.del,w=t.has,m=t.empty,k=t.put,_=t.map,x=t.copy,p.graph=p.graph||d)}(),function(){function r(n,t){return t?require(n):n.slice?r[o(n)]:function(t,e){n(t={exports:{}}),r[o(e)]=t.exports};function o(t){return t.split("/").slice(-1).toString().replace(".js","")}}var n;"undefined"!=typeof module&&(n=module),r(function(t){"undefined"!=typeof window&&(t.window=window);var e=(t.window||t).Connection||function(){};(e.window=t.window)&&(e.window.Connection=e);try{void 0!==n&&(n.exports=e)}catch(t){}t.exports=e})(r,"./root"),r(function(t){var e=r("./root"),u=(e.window||"").Database||r("./database",1);if(!((u.Connection=e).Database=u).window)try{r("./lib/connection",1)}catch(t){}u.on("opt",function(t){var n,o,e,r,i,a,s;(n=t).connection||(o=n.opt,e=o.peers,!1===o.connection||"undefined"!=typeof process&&"false"==""+(process.env||"").Connection||u.window&&(n.connection={},a=JSON.parse((localStorage||"")[(o.file||"")+"connection/"]||null)||{},Object.keys(a.peers||"").forEach(function(t){(r=e[i=t]=e[i]||{}).id=r.url=i}),(r=e[i="https://gun-rs.iris.to/gun"]=e[i]||{}).id=r.url=i,(s=o.mesh=o.mesh||u.Mesh(n)).way=function(t){if(n.$===t.$||(t._||"").via)s.say(t,o.peers);else{var e=(t.$||"")._;if(e){if(t.get){if(e.connection)return;e.connection={}}s.say(t,o.peers)}else s.say(t,o.peers)}})),this.to.next(t)});t.exports=e})(r,"./connection")}(),function(){function w(n,t){return t?require(n):n.slice?w[o(n)]:function(t,e){n(t={exports:{}}),w[o(e)]=t.exports};function o(t){return t.split("/").slice(-1).toString().replace(".js","")}}var s;"undefined"!=typeof module&&(s=module),w(function(t){"undefined"!=typeof window&&(t.window=window);var e=(t.window||t).Encryption||{};(e.window=t.window)&&(e.window.Encryption=e);try{void 0+""!=typeof s&&(s.exports=e)}catch(t){}t.exports=e})(w,"./root"),w(function(t){var e=w("./root");try{e.window&&location.protocol.indexOf("s")<0&&location.host.indexOf("localhost")<0&&!/^127\.\d+\.\d+\.\d+$/.test(location.hostname)&&location.protocol.indexOf("file:")<0&&(location.protocol="https:")}catch(t){}})(w,"./https"),w(function(t){if(void 0+""==typeof btoa){if(void 0+""==typeof Buffer)try{global.Buffer=w("buffer",1).Buffer}catch(t){}global.btoa=function(t){return Buffer.from(t,"binary").toString("base64")},global.atob=function(t){return Buffer.from(t,"base64").toString("binary")}}})(w,"./base64"),w(function(t){function e(){}w("./base64"),Object.assign(e,{from:Array.from}),(e.prototype=Object.create(Array.prototype)).toString=function(t,n,e){n=n||0;var o=this.length;if("hex"!==(t=t||"utf8"))return"utf8"===t?Array.from({length:(e||o)-n},(t,e)=>String.fromCharCode(this[e+n])).join(""):"base64"===t?btoa(this):void 0;{const r=new Uint8Array(this);return[...Array((e&&e+1||o)-n).keys()].map(t=>r[t+n].toString(16).padStart(2,"0")).join("")}},t.exports=e})(w,"./array"),w(function(t){w("./base64");var u=w("./array");function e(...t){return e.from(...t)}e.prototype=Object.create(Array.prototype),Object.assign(e,{from(){if(!Object.keys(arguments).length||null==arguments[0])throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");const n=arguments[0];let t;if("string"==typeof n){var e=arguments[1]||"utf8";if("hex"===e){var o=n.match(/([\da-fA-F]{2})/g).map(t=>parseInt(t,16));if(!o||!o.length)throw new TypeError("Invalid first argument for type 'hex'.");t=u.from(o)}else if("utf8"===e||"binary"===e){const r=n.length,i=new Uint16Array(r);Array.from({length:r},(t,e)=>i[e]=n.charCodeAt(e)),t=u.from(i)}else if("base64"===e){const a=atob(n),r=a.length,s=new Uint8Array(r);Array.from({length:r},(t,e)=>s[e]=a.charCodeAt(e)),t=u.from(s)}else"binary"===e?t=u.from(n):console.info("Unknown encoding: "+e);return t}n.byteLength;const r=n.byteLength||n.length;if(r){let t;return n instanceof ArrayBuffer&&(t=new Uint8Array(n)),u.from(t||n)}},alloc(t,e=0){return u.from(new Uint8Array(Array.from({length:t},()=>e)))},allocUnsafe(t){return u.from(new Uint8Array(Array.from({length:t})))},concat(t){if(Array.isArray(t))return u.from(t.reduce((t,e)=>t.concat(Array.from(e)),[]));throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.")}}),e.prototype.from=e.from,e.prototype.toString=u.prototype.toString,t.exports=e})(w,"./buffer"),w(function(t){var e=w("./root");const n={Buffer:w("./buffer")};var o={};if(JSON.parseAsync=JSON.parseAsync||function(t,e,n){try{e(void 0,JSON.parse(t,n))}catch(t){e(t)}},JSON.stringifyAsync=JSON.stringifyAsync||function(t,e,n,o){try{e(void 0,JSON.stringify(t,n,o))}catch(t){e(t)}},n.parse=function(t,e){return new Promise(function(n,o){JSON.parseAsync(t,function(t,e){t?o(t):n(e)},e)})},n.stringify=function(t,e,r){return new Promise(function(n,o){JSON.stringifyAsync(t,function(t,e){t?o(t):n(e)},e,r)})},e.window&&(n.crypto=window.crypto||window.msCrypto,n.subtle=(n.crypto||o).subtle||(n.crypto||o).webkitSubtle,n.TextEncoder=window.TextEncoder,n.TextDecoder=window.TextDecoder,n.random=t=>n.Buffer.from(n.crypto.getRandomValues(new Uint8Array(n.Buffer.alloc(t))))),n.TextDecoder||({TextEncoder:e,TextDecoder:o}=w((void 0+""==typeof s?".":"")+"./lib/text-encoding",1),n.TextDecoder=o,n.TextEncoder=e),!n.crypto)try{var r=w("crypto",1);Object.assign(n,{crypto:r,random:t=>n.Buffer.from(r.randomBytes(t))});const i=w("@peculiar/webcrypto",1)["Crypto"];n.ossl=n.subtle=new i({directory:"ossl"}).subtle}catch(t){}t.exports=n})(w,"./shim"),w(function(t){var e=w("./root"),n=w("./shim"),o={pbkdf2:{hash:{name:"SHA-256"},iter:1e5,ks:64},ecdsa:{pair:{name:"ECDSA",namedCurve:"P-256"},sign:{name:"ECDSA",hash:{name:"SHA-256"}}},ecdh:{name:"ECDH",namedCurve:"P-256"},jwk:function(t,e){t={kty:"EC",crv:"P-256",x:(t=t.split("."))[0],y:t[1],ext:!0};return t.key_ops=e?["sign"]:["verify"],e&&(t.d=e),t},keyToJwk:function(t){const e=t.toString("base64");return{kty:"oct",k:e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"}},recall:{validity:43200,hook:function(t){return t}},check:function(t){return"string"==typeof t&&"SEA{"===t.slice(0,4)},parse:async function(t){try{var e="string"==typeof t;return e&&"SEA{"===t.slice(0,4)&&(t=t.slice(3)),e?await n.parse(t):t}catch(t){}return t}};e.opt=o,t.exports=o})(w,"./settings"),w(function(t){var n=w("./shim");t.exports=async function(t,e){t="string"==typeof t?t:await n.stringify(t),e=await n.subtle.digest({name:e||"SHA-256"},(new n.TextEncoder).encode(t));return n.Buffer.from(e)}})(w,"./sha256"),w(function(t){var e=w("./shim"),n=e.subtle;const o=e.ossl||n;t.exports=t=>o.digest({name:"SHA-1"},new ArrayBuffer(t))})(w,"./sha1"),w(function(t){var c=w("./root"),f=w("./shim"),p=w("./settings"),l=w("./sha256");c.work=c.work||(async(t,e,n,o)=>{try{var r=(e||{}).epub||e;if(o=o||{},r instanceof Function&&(n=r,r=void 0),t="string"==typeof t?t:await f.stringify(t),"sha"===(o.name||"").toLowerCase().slice(0,3)){var i=f.Buffer.from(await l(t,o.name),"binary").toString(o.encode||"base64");if(n)try{n(i)}catch(t){console.log(t)}return i}var r=r||f.random(9),a=await(f.ossl||f.subtle).importKey("raw",(new f.TextEncoder).encode(t),{name:o.name||"PBKDF2"},!1,["deriveBits"]),s=await(f.ossl||f.subtle).deriveBits({name:o.name||"PBKDF2",iterations:o.iterations||p.pbkdf2.iter,salt:(new f.TextEncoder).encode(o.salt||r),hash:o.hash||p.pbkdf2.hash},a,o.length||8*p.pbkdf2.ks),u=(t=f.random(t.length),f.Buffer.from(s,"binary").toString(o.encode||"base64"));if(n)try{n(u)}catch(t){console.log(t)}return u}catch(t){if(console.log(t),c.err=t,c.throw)throw t;return void(n&&n())}}),t.exports=c.work})(w,"./work"),w(function(t){var a=w("./root"),s=w("./shim");w("./settings");a.name=a.name||(async(e,t)=>{try{if(e)try{e()}catch(t){console.log(t)}return}catch(t){if(console.log(t),a.err=t,a.throw)throw t;return void(e&&e())}}),a.pair=a.pair||(async(e,t)=>{try{var n=s.ossl||s.subtle,o=await s.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async t=>{var e={},t=(e.priv=(await s.subtle.exportKey("jwk",t.privateKey)).d,await s.subtle.exportKey("jwk",t.publicKey));return e.pub=t.x+"."+t.y,e});try{var r=await n.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async t=>{var e={},t=(e.epriv=(await n.exportKey("jwk",t.privateKey)).d,await n.exportKey("jwk",t.publicKey));return e.epub=t.x+"."+t.y,e})}catch(t){if(a.window)throw t;if("Error: ECDH is not a supported algorithm"!=t)throw t;console.log("Ignoring ECDH...")}var r=r||{},i={pub:o.pub,priv:o.priv,epub:r.epub,epriv:r.epriv};if(e)try{e(i)}catch(t){console.log(t)}return i}catch(t){if(console.log(t),a.err=t,a.throw)throw t;return void(e&&e())}}),t.exports=a.pair})(w,"./pair"),w(function(t){var l=w("./root"),h=w("./shim"),y=w("./settings"),d=w("./sha256");l.sign=l.sign||(async(t,e,n,o)=>{try{if(o=o||{},!(e||o).priv){if(!l.I)throw"No signing key";e=await l.I(null,{what:t,how:"sign",why:o.why})}if(void 0===t)throw"`undefined` not allowed";var r=await y.parse(t),i=o.check=o.check||r;if(l.verify&&(l.opt.check(i)||i&&i.s&&i.m)&&void 0!==await l.verify(i,e)){var a=await y.parse(i);if(o.raw||(a="SEA"+await h.stringify(a)),n)try{n(a)}catch(t){console.log(t)}}else{var s=e.pub,u=e.priv,c=y.jwk(s,u),f=await d(r),p=await(h.ossl||h.subtle).importKey("jwk",c,{name:"ECDSA",namedCurve:"P-256"},!1,["sign"]).then(t=>(h.ossl||h.subtle).sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new Uint8Array(f))),a={m:r,s:h.Buffer.from(p,"binary").toString(o.encode||"base64")};if(o.raw||(a="SEA"+await h.stringify(a)),n)try{n(a)}catch(t){console.log(t)}}return a}catch(t){if(console.log(t),l.err=t,l.throw)throw t;return void(n&&n())}}),t.exports=l.sign})(w,"./sign"),w(function(t){var h=w("./root"),y=w("./shim"),d=w("./settings"),g=w("./sha256"),n=(h.verify=h.verify||(async(e,n,o,r)=>{try{var t=await d.parse(e);if(!1===n){var i=await d.parse(t.m);if(o)try{o(i)}catch(t){console.log(t)}return i}r=r||{};var a,s,u,c=n.pub||n,f=h.opt.slow_leak?await h.opt.slow_leak(c):await(y.ossl||y.subtle).importKey("jwk",d.jwk(c),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),p=await g(t.m);try{if(a=y.Buffer.from(t.s,r.encode||"base64"),s=new Uint8Array(a),!(u=await(y.ossl||y.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},f,s,new Uint8Array(p))))throw"Signature did not match"}catch(t){if(h.opt.fallback)return await h.opt.fall_verify(e,n,o,r)}var l=u?await d.parse(t.m):void 0;if(o)try{o(l)}catch(t){console.log(t)}return l}catch(t){if(console.log(t),h.err=t,h.throw)throw t;return void(o&&o())}}),t.exports=h.verify,{}),f=(h.opt.slow_leak=t=>{var e;return n[t]||(e=d.jwk(t),n[t]=(y.ossl||y.subtle).importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])),n[t]},h.opt);h.opt.fall_verify=async function(t,e,n,o,r){if(r===h.opt.fallback)throw"Signature did not match";r=r||1;var i,a,s,u=t||"",c=(t=h.opt.unpack(t)||t,await d.parse(t)),e=e.pub||e,e=await h.opt.slow_leak(e),r=r<=h.opt.fallback?y.Buffer.from(await y.subtle.digest({name:"SHA-256"},(new y.TextEncoder).encode(await d.parse(c.m)))):await g(c.m);try{if(i=y.Buffer.from(c.s,o.encode||"base64"),a=new Uint8Array(i),!(s=await(y.ossl||y.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},e,a,new Uint8Array(r))))throw"Signature did not match"}catch(t){try{i=y.Buffer.from(c.s,"utf8"),a=new Uint8Array(i),s=await(y.ossl||y.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},e,a,new Uint8Array(r))}catch(t){if(!s)throw"Signature did not match"}}o=s?await d.parse(c.m):void 0;if(f.fall_soul=u["#"],f.fall_key=u["."],f.fall_val=t,f.fall_state=u[">"],n)try{n(o)}catch(t){console.log(t)}return o},h.opt.fallback=2})(w,"./verify"),w(function(t){var o=w("./shim"),r=w("./settings"),i=w("./sha256");t.exports=async(t,e,n)=>{t+=(e||o.random(8)).toString("utf8"),e=o.Buffer.from(await i(t),"binary"),t=r.keyToJwk(e);return o.subtle.importKey("jwk",t,{name:"AES-GCM"},!1,["encrypt","decrypt"])}})(w,"./aeskey"),w(function(t){var c=w("./root"),f=w("./shim"),p=(w("./settings"),w("./aeskey"));c.encrypt=c.encrypt||(async(t,e,n,o)=>{try{o=o||{};var r=(e||o).epriv||e;if(void 0===t)throw"`undefined` not allowed";if(!r){if(!c.I)throw"No encryption key";r=(e=await c.I(null,{what:t,how:"encrypt",why:o.why})).epriv||e}var i="string"==typeof t?t:await f.stringify(t),a={s:f.random(9),iv:f.random(15)},s=await p(r,a.s,o).then(t=>f.subtle.encrypt({name:o.name||"AES-GCM",iv:new Uint8Array(a.iv)},t,(new f.TextEncoder).encode(i))),u={ct:f.Buffer.from(s,"binary").toString(o.encode||"base64"),iv:a.iv.toString(o.encode||"base64"),s:a.s.toString(o.encode||"base64")};if(o.raw||(u="SEA"+await f.stringify(u)),n)try{n(u)}catch(t){console.log(t)}return u}catch(t){if(console.log(t),c.err=t,c.throw)throw t;return void(n&&n())}}),t.exports=c.encrypt})(w,"./encrypt"),w(function(t){var p=w("./root"),l=w("./shim"),h=w("./settings"),y=w("./aeskey");p.decrypt=p.decrypt||(async(e,n,o,r)=>{try{r=r||{};var t=(n||r).epriv||n;if(!t){if(!p.I)throw"No decryption key.";t=(n=await p.I(null,{what:e,how:"decrypt",why:r.why})).epriv||n}var i=await h.parse(e);try{var a=l.Buffer.from(i.s,r.encode||"base64"),s=l.Buffer.from(i.iv,r.encode||"base64"),u=l.Buffer.from(i.ct,r.encode||"base64"),c=await y(t,a,r).then(t=>l.subtle.decrypt({name:r.name||"AES-GCM",iv:new Uint8Array(s),tagLength:128},t,new Uint8Array(u)))}catch(t){if("utf8"===r.encode)throw"Could not decrypt";if(p.opt.fallback)return r.encode="utf8",await p.decrypt(e,n,o,r)}var f=await h.parse(new l.TextDecoder("utf8").decode(c));if(o)try{o(f)}catch(t){console.log(t)}return f}catch(t){if(console.log(t),p.err=t,p.throw)throw t;return void(o&&o())}}),t.exports=p.decrypt})(w,"./decrypt"),w(function(t){var l=w("./root"),h=w("./shim"),y=(w("./settings"),l.secret=l.secret||(async(t,e,n,o)=>{try{if(o=o||{},!e||!e.epriv||!e.epub){if(!l.I)throw"No secret mix";e=await l.I(null,{what:t,how:"secret",why:o.why})}var r=t.epub||t,i=e.epub,a=e.epriv,s=h.ossl||h.subtle,u=y(r),c=Object.assign({public:await s.importKey(...u,!0,[])},{name:"ECDH",namedCurve:"P-256"}),f=y(i,a),p=await s.importKey(...f,!1,["deriveBits"]).then(async t=>{t=await s.deriveBits(c,t,256),t=new Uint8Array(t),t=await s.importKey("raw",t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return s.exportKey("jwk",t).then(({k:t})=>t)});if(n)try{n(p)}catch(t){console.log(t)}return p}catch(t){if(console.log(t),l.err=t,l.throw)throw t;return void(n&&n())}}),(t,e)=>{var[t,n]=t.split(".");return["jwk",Object.assign(e?{d:e}:{},{x:t,y:n,kty:"EC",crv:"P-256",ext:!0}),{name:"ECDH",namedCurve:"P-256"}]});t.exports=l.secret})(w,"./secret"),w(function(t){var h=w("./root");h.certify=h.certify||(async(t,e={},n,o,r={})=>{try{if(!(t=(()=>{var e=[];if(t){if(("string"==typeof t||Array.isArray(t))&&-1<t.indexOf("*"))return"*";if("string"==typeof t)return t;if(Array.isArray(t)){if(1===t.length&&t[0])return"object"==typeof t[0]&&t[0].pub?t[0].pub:"string"==typeof t[0]?t[0]:null;t.map(t=>{"string"==typeof t?e.push(t):"object"==typeof t&&t.pub&&e.push(t.pub)})}return"object"==typeof t&&t.pub?t.pub:0<e.length?e:null}})()))return console.log("No certificant found");var i=!r.expiry||"number"!=typeof r.expiry&&"string"!=typeof r.expiry?null:parseFloat(r.expiry),a=(e||{}).read?e.read:null,s=(e||{}).write?e.write:"string"==typeof e||Array.isArray(e)||e["+"]||e["#"]||e["."]||e["="]||e["*"]||e[">"]||e["<"]?e:null,u=(r||{}).block||(r||{}).blacklist||(r||{}).ban||{},c=u.read&&("string"==typeof u.read||(u.read||{})["#"])?u.read:null,f="string"==typeof u?u:u.write&&("string"==typeof u.write||u.write["#"])?u.write:null;if(!a&&!s)return console.log("No policy found");var p=JSON.stringify({c:t,...i?{e:i}:{},...a?{r:a}:{},...s?{w:s}:{},...c?{rb:c}:{},...f?{wb:f}:{}}),l=await h.sign(p,n,null,{raw:1});if(r.raw||(l="SEA"+JSON.stringify(l)),o)try{o(l)}catch(t){console.log(t)}return l}catch(t){if(h.err=t,h.throw)throw t;return void(o&&o())}}),t.exports=h.certify})(w,"./certify"),w(function(t){var i=w("./shim"),e=w("./root");e.work=w("./work"),e.sign=w("./sign"),e.verify=w("./verify"),e.encrypt=w("./encrypt"),e.decrypt=w("./decrypt"),e.certify=w("./certify"),e.random=e.random||i.random,e.Buffer=e.Buffer||w("./buffer"),e.keyid=e.keyid||(async t=>{try{var e=i.Buffer.concat(t.replace(/-/g,"+").replace(/_/g,"/").split(".").map(t=>i.Buffer.from(t,"base64"))),n=i.Buffer.concat([i.Buffer.from([153,e.length/256,e.length%256]),e]),o=await sha1hash(n);const r=i.Buffer.from(o,"binary");return r.toString("hex",r.length-8)}catch(t){throw console.log(t),t}}),((e.window||{}).Database||{}).Encryption=e,t.exports=e})(w,"./encryption"),w(function(t){var e,n=w("./encryption");function i(t){this._={$:this}}function o(){}function a(){return e.state().toString(36).replace(".","")}e=n.window?n.window.Database||{chain:{}}:w((void 0+""==typeof s?".":"")+"./database",1),n.Database=e,o.prototype=e.chain,(i.prototype=new o).constructor=i,e.chain.user=function(t){var e,o,r=this.back(-1);return t?(t=n.opt.pub((t._||"")["#"])||t,r.get("~"+t)):((t=r.back("user"))||(e=r=r._,o=r.opt.uuid||a,(e=(t=r.user=this.chain(new i))._).opt={},e.opt.uuid=function(t){var e=o(),n=r.user;return(n=n&&n.is)&&(n=n.pub)&&(e="~"+n+"/"+e,t&&t.call&&t(null,e)),e}),t)},(e.User=i).Database=e,i.Encryption=e.Encryption=n,t.exports=i})(w,"./user"),w(function(t){(""+void 0!=typeof window?window.Database||{chain:{}}:w((""+void 0==typeof s?".":"")+"./database",1)).chain.then=function(t,n){var o=this,e=new Promise(function(t,e){o.once(t,n)});return t?e.then(t):e}})(w,"./then"),w(function(t){var e=w("./user"),p=e.Encryption,l=e.Database,h=function(){};e.prototype.create=function(...t){var e,r="object"==typeof t[0]&&(t[0].pub||t[0].epub)?t[0]:"object"==typeof t[1]&&(t[1].pub||t[1].epub)?t[1]:null,i=r&&(r.pub||r.epub)?r.pub:"string"==typeof t[0]?t[0]:null,a=r&&(r.pub||r.epub)?r:i&&"string"==typeof t[1]?t[1]:null,s=t.filter(t=>"function"==typeof t)[0]||null,n=t&&1<t.length&&"object"==typeof t[t.length-1]?t[t.length-1]:{},u=this,c=u._,o=u.back(-1),s=s||h,n=n||{};if(!1!==n.check&&(i||(e="No user."),e=(a||"").length<8?"Password too short":e))return s({err:l.log(e)}),u;if(c.ing)return(s||h)({err:l.log("User is already being created or authenticated"),wait:!0}),u;c.ing=!0;var f={a:function(t){if((f.pubs=t)&&!n.already)return t={err:l.log("User already created")},c.ing=!1,(s||h)(t),void u.leave();f.salt=String.random(64),p.work(a,f.salt,f.b)},b:function(t){f.proof=t,r?f.c(r):p.pair(f.c)},c:function(t){var e;f.pair=t||{},(e=c.root.user)&&(e._.encryption=t,e.is={pub:t.pub,epub:t.epub,alias:i}),f.data={pub:t.pub},f.d()},d:function(){f.data.alias=i,f.e()},e:function(){f.data.epub=f.pair.epub,p.encrypt({priv:f.pair.priv,epriv:f.pair.epriv},f.proof,f.f,{raw:1})},f:function(t){f.data.auth=JSON.stringify({ek:t,s:f.salt}),f.g(f.data.auth)},g:function(t){f.data.auth=f.data.auth||t,o.get(t="~"+f.pair.pub).put(f.data).on(f.h);var e={};e[t]={"#":t},o.get("~@"+i).put(e).get(t).on(f.i)},h:function(t,e,n,o){o.off(),f.h.ok=1,f.i()},i:function(t,e,n,o){o&&(f.i.ok=1,o.off()),f.h.ok&&f.i.ok&&(c.ing=!1,s({ok:0,pub:f.pair.pub}),h===s&&(r?u.auth(r):u.auth(i,a)))}};return o.get("~@"+i).once(f.a),u},e.prototype.leave=function(t,e){var n=this.back(-1)._.user;if(n&&(delete n.is,delete n._.is,delete n._.encryption),p.window)try{var o={};delete(o=window.sessionStorage).recall,delete o.pair}catch(t){}return this}})(w,"./create"),w(function(t){var e=w("./user"),y=e.Encryption,n=e.Database,d=function(){};function g(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}return e}e.prototype.auth=function(...t){var e="object"==typeof t[0]&&(t[0].pub||t[0].epub)?t[0]:"object"==typeof t[1]&&(t[1].pub||t[1].epub)?t[1]:null,i=e||"string"!=typeof t[0]?null:t[0],a=!i&&(!e||e.priv&&e.epriv)||"string"!=typeof t[1]?null:t[1],s=t.filter(t=>"function"==typeof t)[0]||null,u=t&&1<t.length&&"object"==typeof t[t.length-1]?t[t.length-1]:{},c=this,f=c._,p=c.back(-1);if(f.ing)return(s||d)({err:n.log("User is already being created or authenticated"),wait:!0}),c;f.ing=!0;var l,h={a:function(e){return e?e.pub?h.name?h.f(e):void h.c((h.data=e).auth):(n=[],Object.keys(e).forEach(function(t){"_"!=t&&n.push(e[t])}),h.b(n)):h.b();var n},b:function(t){t=(h.list=(h.list||[]).concat(t||[])).shift();if(l===t)return h.name?h.err("User account is not published for dApps to access"):h.err("Wrong user or password");p.get(t).once(h.a)},c:function(t){return l===t?h.b():"string"==typeof t?h.c(g(t)):void y.work(a,(h.auth=t).s,h.d,h.enc)},d:function(t){y.decrypt(h.auth.ek,t,h.e,h.enc)},e:function(t){if(l===t)return h.enc?(h.enc=null,h.b()):(h.enc={encode:"utf8"},h.c(h.auth));h.half=t,h.f(h.data)},f:function(t){var e=h.half||{},n=h.data||{};h.g(h.lol={pub:t.pub||n.pub,epub:t.epub||n.epub,priv:t.priv||e.priv,epriv:t.epriv||e.epriv})},g:function(t){if(!t||!t.pub||!t.epub)return h.b();h.pair=t;var e=p._.user,n=e._,o=(n.tag,n.opt);(n=e._=p.get("~"+t.pub)._).opt=o,e.is={pub:t.pub,epub:t.epub,alias:i||t.pub},n.encryption=h.pair,f.ing=!1;try{a&&l==(g(f.root.graph["~"+t.pub].auth)||"")[":"]&&(u.shuffle=u.change=a)}catch(t){}if(u.change?h.z():(s||d)(n),y.window&&(c.back("user")._.opt||u).remember)try{var r={};(r=window.sessionStorage).recall=!0,r.pair=JSON.stringify(t)}catch(t){}try{p._.tag.auth?p._.on("auth",n):setTimeout(function(){p._.on("auth",n)},1)}catch(t){}},h:function(t){return t?(i=(i=t.alias)||(t.alias="~"+e.pub),t.auth?(e=null,void h.c((h.data=t).auth)):h.g(e)):h.b()},z:function(){h.salt=String.random(64),y.work(u.change,h.salt,h.y)},y:function(t){y.encrypt({priv:h.pair.priv,epriv:h.pair.epriv},t,h.x,{raw:1})},x:function(t){h.w(JSON.stringify({ek:t,s:h.salt}))},w:function(t){var e;u.shuffle&&(e={},Object.keys(h.data).forEach(function(t){e[t]=h.data[t]}),delete e._,e.auth=t,p.get("~"+h.pair.pub).put(e)),p.get("~"+h.pair.pub).get("auth").put(t,s||d)},err:function(t){t={err:n.log(t||"User cannot be found")};f.ing=!1,(s||d)(t)},plugin:function(t){if(!(h.name=t))return h.err();var e=[t];"~"!==t[0]&&(e[1]="~"+t,e[2]="~@"+t),h.b(e)}};return e?e.priv&&e.epriv?h.g(e):p.get("~"+e.pub).once(h.h):i?p.get("~@"+i).once(h.a):a||y.name(h.plugin),c}})(w,"./auth"),w(function(t){var e=w("./user"),r=e.Encryption;e.Database;e.prototype.recall=function(t,e){var n=this.back(-1);if((t=t||{})&&t.sessionStorage&&r.window)try{var o;(o=window.sessionStorage)&&(n._.opt.remember=!0,(this.back("user")._.opt||t).remember=!0,(o.recall||o.pair)&&n.user().auth(JSON.parse(o.pair),e))}catch(t){}return this}})(w,"./recall"),w(function(t){var e=w("./user"),c=e.Encryption,n=e.Database;e.prototype.pair=function(){var t,o=this;try{t=new Proxy({DANGER:"☠"},{get:function(t,e,n){if(o.is&&(o._||"").encryption)return o._.encryption[e]}})}catch(t){}return t},e.prototype.delete=async function(t,e,n){this.back(-1);var o=this.back("user");try{o.auth(t,e,function(t){(o.is||{}).pub;o.map().once(function(){this.put(null)}),o.leave(),(n||function(){})({ok:0})})}catch(t){}return this},e.prototype.alive=async function(){var e=this.back(-1);try{return await authRecall(e),e._.user._}catch(t){e="No session!";throw n.log(e),{err:e}}},e.prototype.trust=async function(t){n.is(t)&&t.get("pub").get((t,e)=>{console.log(t,e)}),t.get("trust").get(path).put(theirPubkey)},e.prototype.grant=function(r,i){var a=this.back(-1).user(),s=a._.encryption,u="";return this.back(function(t){t.is||(u+=t.get||"")}),async function(){var t=await a.get("grant").get(s.pub).get(u).then(),e=((t=await c.decrypt(t,s))||(t=c.random(16).toString(),o=await c.encrypt(t,s),a.get("grant").get(s.pub).get(u).put(o)),r.get("pub").then()),n=r.get("epub").then(),e=await e,n=await n,n=await c.secret(n,s),o=await c.encrypt(t,n);a.get("grant").get(e).get(u).put(o,i)}(),this},e.prototype.secret=function(n,o){var r=this,i=r.back(-1).user(),a=i.pair(),s="";return r.back(function(t){t.is||(s+=t.get||"")}),async function(){var t,e=await i.get("trust").get(a.pub).get(s).then();(e=await c.decrypt(e,a))||(e=c.random(16).toString(),t=await c.encrypt(e,a),i.get("trust").get(a.pub).get(s).put(t)),t=await c.encrypt(n,e),r.put(t,o)}(),r},t.exports=e})(w,"./share"),w(function(t){var y,d=w("./encryption"),g=w("./settings"),v=""+y!=typeof window?window.Database||{on:function(){}}:w((""+y==typeof s?".":"")+"./database",1);function p(e){var t,n,o=this,r=o.as,i=e.put,a=i["#"],s=i["."],u=i[":"],c=i[">"],f=e["#"];a&&s&&((e._||"").faith&&(r.opt||"").faith&&"function"==typeof e._?d.opt.pack(i,function(t){d.verify(t,!1,function(t){i["="]=d.opt.unpack(t),o.to.next(e)})}):(n=function(t){r.on("in",{"@":f,err:e.err=t})},(e._||"").DBG&&((e._||"").DBG.c=+new Date),0<=a.indexOf("<?")&&(t=parseFloat(a.split("<?")[1]||""))&&c<v.state()-1e3*t?(t=e._)&&t.stun&&t.stun--:"~@"===a?p.alias(o,e,u,s,a,r,n):"~@"===a.slice(0,2)?p.pubs(o,e,u,s,a,r,n):(t=d.opt.pub(a))?p.pub(o,e,u,s,a,r,n,r.user||"",t):0<=a.indexOf("#")?p.hash(o,e,u,s,a,r,n):p.any(o,e,u,s,a,r,n,r.user||"")))}v.on("opt",function(t){t.encryption||(t.encryption={own:{}},t.on("put",p,t)),this.to.next(t)}),p.hash=function(e,n,t,o,r,i,a){d.work(t,null,function(t){if(t&&t===o.split("#").slice(-1)[0])return e.to.next(n);a("Data hash not same as hash")},{name:"SHA-256"})},p.alias=function(t,e,n,o,r,i,a){return n?"~@"+o===b(n)?t.to.next(e):void a("Alias not same"):a("Data must exist")},p.pubs=function(t,e,n,o,r,i,a){return n?o===b(n)?t.to.next(e):void a("Alias not same"):a("Alias must exist")},p.pub=async function(a,s,n,u,c,o,f,r,p){var i;const l=await g.parse(n)||{},h=(t,r,i)=>{if(t.m&&t.s&&r&&p)return d.verify(t,p,e=>{if(y!==e&&y!==e.e&&s.put[">"]&&s.put[">"]>parseFloat(e.e))return f("Certificate expired.");if(y!==e&&e.c&&e.w&&(e.c===r||-1<e.c.indexOf("*"))){let t=-1<c.indexOf("/")?c.replace(c.substring(0,c.indexOf("/")+1),""):"";var n;String.match=String.match||v.text.match;for(const o of Array.isArray(e.w)?e.w:"object"==typeof e.w||"string"==typeof e.w?[e.w]:[])if(String.match(t,o["#"])&&String.match(u,o["."])||!o["."]&&String.match(t,o["#"])||!o["#"]&&String.match(u,o["."])||String.match(t?t+"/"+u:u,o["#"]||o))return o["+"]&&-1<o["+"].indexOf("*")&&t&&-1==t.indexOf(r)&&-1==u.indexOf(r)?f(`Path "${t}" or key "${u}" must contain string "${r}"`):e.wb&&("string"==typeof e.wb||(e.wb||{})["#"])?(n=a.as.root.$.back(-1),(n="string"==typeof e.wb&&"~"!==e.wb.slice(0,1)?n.get("~"+p):n).get(e.wb).get(r).once(t=>!t||1!==t&&!0!==t?i(e):f(`Certificant ${r} blocked`))):i(e);return f("Certificate verification fail.")}})};if("pub"===u&&"~"+p===c)return n===p?a.to.next(s):f("Account not same");(i=r.is)&&i.pub&&!l["*"]&&!l["+"]&&(p===i.pub||p!==i.pub&&((s._.msg||{}).opt||{}).cert)?d.opt.pack(s.put,t=>{d.sign(t,r._.encryption,async function(t){if(y===t)return f(d.err||"Signature fail");if(s.put[":"]={":":i=d.opt.unpack(t.m),"~":t.s},s.put["="]=i,p===r.is.pub)return(i=b(n))&&((o.encryption.own[i]=o.encryption.own[i]||{})[p]=1),void JSON.stringifyAsync(s.put[":"],function(t,e){return t?f(t||"Stringify error"):(s.put[":"]=e,a.to.next(s))});if(p!==r.is.pub&&((s._.msg||{}).opt||{}).cert){const e=await g.parse(s._.msg.opt.cert);e&&e.m&&e.s&&h(e,r.is.pub,t=>{s.put[":"]["+"]=e,s.put[":"]["*"]=r.is.pub,JSON.stringifyAsync(s.put[":"],function(t,e){return t?f(t||"Stringify error"):(s.put[":"]=e,a.to.next(s))})})}},{raw:1})}):d.opt.pack(s.put,t=>{d.verify(t,l["*"]||p,function(e){var t;return e=d.opt.unpack(e),y===e?f("Unverified data"):((t=b(e))&&p===d.opt.pub(t)&&((o.encryption.own[t]=o.encryption.own[t]||{})[p]=1),l["+"]&&l["+"].m&&l["+"].s&&l["*"]?void h(l["+"],l["*"],t=>(s.put["="]=e,a.to.next(s))):(s.put["="]=e,a.to.next(s)))})})},p.any=function(e,t,n,o,r,i,a,s){if(i.opt.secure)return a("Soul missing public key at '"+o+"'");i.on("secure",function(t){if(this.off(),!i.opt.secure)return e.to.next(t);a("Data cannot be changed")}).on.on("secure",t)};var n=v.valid,b=function(t,e){return"string"==typeof(e=n(t))&&e},e=((v.state||"").ify,/[^\w_-]/),r=(d.opt.pub=function(t){if((t=t&&((t=t.split("~"))&&t[1]))&&(t=t.split(e).slice(0,2))&&2==t.length&&"@"!==(t[0]||"")[0])return t=t.slice(0,2).join(".")},d.opt.stringy=function(t){},d.opt.pack=function(o,r,i,a,s){var t,e;if(d.opt.check(o))return r(o);o&&o["#"]&&o["."]&&o[">"]&&(t=o[":"],e=1),JSON.parseAsync(e?t:o,function(t,e){var n=y!==(e||"")[":"]&&(e||"")["~"];r(n?{m:{"#":s||o["#"],".":i||o["."],":":(e||"")[":"],">":o[">"]||v.state.is(a,i)},s:n}:o)})},d.opt),i=(d.opt.unpack=function(t,e,n){if(y!==t){if(t&&y!==(o=t[":"]))return o;if(e=e||r.fall_key,!n&&r.fall_val&&((n={})[e]=r.fall_val),e&&n){if(t===n[e])return t;if(!d.opt.check(n[e]))return t;var o=n&&n._&&n._["#"]||r.fall_soul,n=v.state.is(n,e)||r.fall_state;return t&&4===t.length&&o===t[0]&&e===t[1]&&i(n)===i(t[3])?t[2]:n<d.opt.shuffle_attack?t:void 0}}},d.opt.shuffle_attack=15463296e5,Math.floor)})(w,"./index")}();