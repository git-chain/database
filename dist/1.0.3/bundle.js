!function(){function S(n,t){return t?require(n):n.slice?S[r(n)]:function(t,e){n(t={exports:{}}),S[r(e)]=t.exports};function r(t){return t.split("/").slice(-1).toString().replace(".js","")}}var e;"undefined"!=typeof module&&(e=module),S(function(t){String.random=function(t,e){var n="";for(t=t||24,e=e||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";0<t--;)n+=e.charAt(Math.floor(Math.random()*e.length));return n},String.match=function(t,e){var n,r;return"string"==typeof t&&(t===((e=(e="string"==typeof e?{"=":e}:e)||{})["="]||e["*"]||e[">"]||e["<"])||r===e["="]&&(n=e["*"]||e[">"],t.slice(0,(n||"").length)===n||r===e["*"]&&(r!==e[">"]&&r!==e["<"]?t>=e[">"]&&t<=e["<"]:r!==e[">"]&&t>=e[">"]||r!==e["<"]&&t<=e["<"])))},String.hash=function(t,e){if("string"==typeof t){if(e=e||0,!t.length)return e;for(var n=0,r=t.length;n<r;++n)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}};var e,n,r,o,i,a,s,u,c,f,p,l,h,d=Object.prototype.hasOwnProperty;Object.plain=function(t){return!!t&&(t instanceof Object&&t.constructor===Object||"Object"===Object.prototype.toString.call(t).match(/^\[object (\w+)\]$/)[1])},Object.empty=function(t,e){for(var n in t)if(d.call(t,n)&&(!e||-1==e.indexOf(n)))return!1;return!0},Object.keys=Object.keys||function(t){var e,n=[];for(e in t)d.call(t,e)&&n.push(e);return n},e=setTimeout,r=n=0,o=typeof setImmediate!=""+void 0&&setImmediate||e,e.hold=e.hold||9,e.poll=e.poll||function(t){e.hold>=+new Date-n&&r++<3333?t():o(function(){n=+new Date,t()},r=0)},l=setTimeout,s=(a=l.turn=l.turn||function(t){1==s.push(t)&&u(f)}).s=[],u=l.poll,c=0,f=function(){(i=s[c++])&&i(),c!=s.length&&99!=c||(s=a.s=s.slice(c),c=0),s.length&&u(f)},l=setTimeout,h=l.turn,(l.each=l.each||function(i,a,s,u){u=u||9,function t(e,n,r){if(n=(e=(i||[]).splice(0,u)).length){for(var o=0;o<n&&p===(r=a(e[o]));o++);if(p===r)return void h(t)}s&&s(r)}()})()})(S,"./shim"),S(function(t){t.exports=function t(e,n,r){if(!e)return{to:t};var o="function"==typeof n,e=(this.tag||(this.tag={}))[e]||o&&(this.tag[e]={tag:e,to:t._={next:function(t){var e;(e=this.to)&&e.next(t)}}});if(o){r={off:t.off||(t.off=function(){if(this.next===t._.next)return!0;this===this.the.last&&(this.the.last=this.back),this.to.back=this.back,this.next=t._.next,this.back.to=this.to,this.the.last===this.the&&delete this.on.tag[this.the.tag]}),to:t._,next:n,the:e,on:this,as:r};return(r.back=e.last||e).to=r,e.last=r}return(e=e.to)&&void 0!==n&&e.next(n),e}})(S,"./onto"),S(function(t){t.exports=function(t){return null===t||"string"==typeof t||"boolean"==typeof t||"number"==typeof t&&t!=1/0&&t!=-1/0&&t==t||!!t&&"string"==typeof t["#"]&&1===Object.keys(t).length&&t["#"]}})(S,"./valid"),S(function(t){function e(){var t=+new Date;return o=o<t?(n=0,t+e.drift):t+(n+=1)/r+e.drift}S("./shim");e.drift=0;var n=0,r=999,o=-1/0;e.is=function(t,e,n){n=e&&t&&t._&&t._[">"]||n;if(n)return"number"==typeof(n=n[e])?n:-1/0},e.ify=function(t,e,n,r,o){(t=t||{})._=t._||{},o&&(t._["#"]=o);o=t._[">"]||(t._[">"]={});return void 0!==e&&"_"!==e&&("number"==typeof n&&(o[e]=n),void 0!==r&&(t[e]=r)),t},t.exports=e})(S,"./state"),S(function(t){S("./shim"),t.exports=function(r){var o={s:{}},i=o.s;r=r||{max:999,age:9e3},o.check=function(t){return!!i[t]&&e(t)};var e=o.track=function(t){t=i[t]||(i[t]={});return t.was=o.now=+new Date,o.to||(o.to=setTimeout(o.drop,r.age+9)),t};return o.drop=function(n){o.to=null,o.now=+new Date;var t=Object.keys(i);console.STAT&&console.STAT(o.now,+new Date-o.now,"dup drop keys"),setTimeout.each(t,function(t){var e=i[t];e&&(n||r.age)>o.now-e.was||delete i[t]},0,99)},o}})(S,"./dup"),S(function(t){S("./onto"),t.exports=function(t,e){if(this.on){var n=(this.opt||{}).lack||9e3;if("function"!=typeof t){if(!t)return;var r=t["#"]||t,o=(this.tag||"")[r];return o?(e&&(o=this.on(r,e),clearTimeout(o.err),o.err=setTimeout(function(){o.off()},n)),!0):void 0}r=e&&e["#"]||a(9);if(!t)return r;var i=this.on(r,t,e);return i.err=i.err||setTimeout(function(){i.off(),i.next({err:"Error: No ACK yet.",lack:!0})},n),r}};var a=String.random||function(){return Math.random().toString(36).slice(2)}})(S,"./ask"),S(function(t){function f(t){return t instanceof f?(this._={$:this}).$:this instanceof f?f.create(this._={$:this,opt:t}):new f(t)}function a(t,a){var s=+new Date,e=t._||{},u=e.DBG=t.DBG,c=t["#"],f=y(9),p=Object.keys(a||"").sort(),l=((a||"")._||"")["#"],h=(p.length,t.$._.root),d=a===h.graph[l];console.STAT&&console.STAT(s,((u||e).gk=+new Date)-s,"got keys"),a&&function t(){s=+new Date;for(var e,n,r,o=0,i={};o<9&&(e=p[o++]);)g(i,e,E(a,e),a[e],l);p=p.slice(o),(n={})[l]=i,i=n,d&&((r=function(){}).ram=r.faith=!0),n=p.length,console.STAT&&console.STAT(s,-(s-(s=+new Date)),"got copied some"),u&&(u.ga=+new Date),h.on("in",{"@":c,"#":f,put:i,"%":n?f=y(9):T,$:h.$,_:r,DBG:u}),console.STAT&&console.STAT(s,+new Date-s,"got in"),n&&setTimeout.turn(t)}(),a||h.on("in",{"@":t["#"]})}f.is=function(t){return t instanceof f||t&&t._&&t===t._.$||!1},f.version=.202,(f.chain=f.prototype).toJSON=function(){},S("./shim"),f.valid=S("./valid"),f.state=S("./state"),f.on=S("./onto"),f.dup=S("./dup"),f.ask=S("./ask"),function(){function m(t){if(t)if(t.out!==m){var e,n,r=this.as,o=r.at||r,i=o.$,a=o.dup,s=t.DBG;if((n=t["#"])||(n=t["#"]=y(9)),!a.check(n)){if(a.track(n),n=t._,t._="function"==typeof n?n:function(){},t.$&&t.$===(t.$._||"").$||(t.$=i),t["@"]&&!t.put&&(a=(r=t)["@"]||"",(e=a._)?(e.acks=(e.acks||0)+1,(e.err=r.err)&&(r["@"]=e["#"],k(e)),e.ok=r.ok||e.ok,e.stop||e.crack||(e.crack=e.match&&e.match.push(function(){c(e)})),c(e)):(n=(n=(n=r.$)&&(n=n._)&&(n=n.root)&&n.dup).check(a))&&(r["@"]=n["#"]||r["@"])),!o.ask(t["@"],t)){if(s&&(s.u=+new Date),t.put)return void u(t);t.get&&f.on.get(t,i)}s&&(s.uc=+new Date),this.to.next(t),s&&(s.ua=+new Date),t.nts||t.NTS||(t.out=m,o.on("out",t),s&&(s.ue=+new Date))}}else this.to.next(t)}function u(a){if(a){var s=a._||"",t=s.root=((s.$=a.$||"")._||"").root;if(a["@"]&&s.faith&&!s.miss)return a.out=m,void t.on("out",a);s.latch=t.hatch,s.match=t.hatch=[];var u,c,f,p,l,h,d,y,g,v=a.put,b=s.DBG=a.DBG,w=+new Date;e=e||w,v["#"]&&v["."]||(b&&(b.p=w),s["#"]=a["#"],s.msg=a,s.all=0,s.stun=1,u=Object.keys(v),console.STAT&&console.STAT(w,((b||s).pk=+new Date)-w,"put sort"),c=0,function t(e){if(f!=c){if(!(l=u[f=c]))return console.STAT&&console.STAT(w,((b||s).pd=+new Date)-w,"put"),void k(s);(h=v[l])?(g=h._)?l!==g["#"]?y=_+x(l)+"soul not same.":(d=g[">"])||(y=_+x(l)+"no state."):y=_+x(l)+"no meta.":y=_+x(l)+"no node.",p=Object.keys(h||{})}if(y)return a.err=s.err=y,void k(s);var n,r=0;for(e=e||0;e++<9&&(n=p[r++]);)if("_"!==n){var o=h[n],i=d[n];if(T===i){y=_+x(n)+"on"+x(l)+"no state.";break}if(!O(o)){y=_+x(n)+"on"+x(l)+"bad "+typeof o+x(o);break}!function t(e,n,r,o,i){var a=i._||"",s=a.root,u=s.graph;var c=u[r]||B,f=E(c,n,1),p=c[n];var l=a.DBG;(c=console.STAT)&&(u[r]&&p||(c.has=(c.has||0)+1));u=A();if(u<o)return setTimeout(function(){t(e,n,r,o,i)},(c=o-u)>j?j:c),void(console.STAT&&console.STAT((l||a).Hf=+new Date,c,"future"));if(o<f&&!a.miss)return;if(!a.faith&&o===f&&(e===p||S(e)<=S(p))&&!a.miss)return;a.stun++;var h=i["#"]+a.all++,p={toString:function(){return h},_:a};p.toJSON=p.toString;s.dup.track(p)["#"]=i["#"];l&&(l.ph=l.ph||+new Date);s.on("put",{"#":p,"@":i["@"],put:{"#":r,".":n,":":e,">":o},ok:i.ok,_:a})}(o,n,l,i,a),++$}(p=p.slice(r)).length?D(t):(++c,p=null,t(e))}())}}function n(t){(u=(t._||"").DBG)&&(u.pa=+new Date,u.pm=u.pm||+new Date);var e=this.as,n=e.graph,r=t._,o=t.put,i=o["#"],a=o["."],s=o[":"],u=o[">"];t["#"];(o=r.msg)&&(o=o.put)&&(o=o[i])&&g(o,a,u,s,i),n[i]=g(n[i],a,u,s,i),(o=(e.next||"")[i])&&o.on("in",t),k(r),this.to.next(t)}function k(t,e){var n,r;t.stop||!t.err&&0<--t.stun||(t.stop=1,(n=t.root)&&((r=t.match).end=1,r===n.hatch&&(!(r=t.latch)||r.end?delete n.hatch:n.hatch=r),t.hatch&&t.hatch(),setTimeout.each(t.match,function(t){t&&t()}),!(e=t.msg)||t.err||e.err||(e.out=m,t.root.on("out",e),o())))}function c(t){t&&t.root&&(t.stun||t.acks!==t.all||t.root.on("in",{"@":t["#"],err:t.err,ok:t.err?T:t.ok||{"":1}}))}f.create=function(t){t.root=t.root||t,t.graph=t.graph||{},t.on=t.on||f.on,t.ask=t.ask||f.ask,t.dup=t.dup||f.dup();var e=t.$.opt(t.opt);return t.once||(t.on("in",m,t),t.on("out",m,t),t.on("put",n,t),f.on("create",t),t.on("create",t)),t.once=1,e},f.on.put=u;var e,_="Error: Invalid graph!",x=function(t){return" '"+(""+t).slice(0,9)+"...' "},S=JSON.stringify,j=2147483647,A=f.state,$=0,o=function(){999<$&&1<$/-(e-(e=+new Date))&&(f.window&&console.log("Syncing  more than 1K records per second"),o=function(){$=0})}}(),f.on.get=function(t,e){var n=e._,r=t.get,o=r["#"],i=n.graph[o],e=r["."],r=((n.next||(n.next={}))[o],(t._||{}).DBG=t.DBG);if(r&&(r.g=+new Date),!i)return n.on("get",t);if(e){if("string"!=typeof e||T===i[e])return n.on("get",t);i=g({},e,E(i,e),i[e],o)}i&&a(t,i),n.on("get",t)},f.on.get.ack=a,f.chain.opt=function(n){n=n||{};var r=this._,t=n.peers||n;return Object.plain(n)||(n={}),Object.plain(r.opt)||(r.opt=n),"string"==typeof t&&(t=[t]),Object.plain(r.opt.peers)||(r.opt.peers={}),t instanceof Array&&(n.peers={},t.forEach(function(t){var e={};e.id=e.url=t,n.peers[t]=r.opt.peers[t]=r.opt.peers[t]||e})),o(n,function t(e){var n=this[e];this&&this.hasOwnProperty(e)||"string"==typeof n||Object.empty(n)?this[e]=n:(!n||n.constructor===Object||n instanceof Array)&&o(n,t)}),r.opt.from=n,f.on("opt",r),r.opt.uuid=r.opt.uuid||function(t){return f.state().toString(36).replace(".","")+String.random(t||12)},this};var T,n,o=function(t,e){Object.keys(t).forEach(e,t)},y=String.random,D=setTimeout.turn,O=f.valid,E=f.state.is,g=f.state.ify,B={};(f.log=function(){return f.log.off||n.log.apply(n,arguments),[].slice.call(arguments).join(" ")}).once=function(t,e,n){return(n=f.log.once)[t]=n[t]||0,n[t]++||f.log(e)},"undefined"!=typeof window&&((window.Database=f).window=window);try{void 0!==e&&(e.exports=f)}catch(t){}((t.exports=f).window||{}).console=(f.window||{}).console||{log:function(){}},(n=console).only=function(t,e){return n.only.i&&t===n.only.i&&n.only.i++&&(n.log.apply(n,arguments)||e)}})(S,"./root"),S(function(t){S("./root").chain.back=function(t,e){if(-1===(t=t||1)||1/0===t)return this._.root.$;if(1===t)return(this._.back||this._).$;var n=this._;if((t="string"==typeof t?t.split("."):t)instanceof Array){for(var r=0,o=t.length,i=n;r<o;r++)i=(i||s)[t[r]];return void 0!==i?e?this:i:(i=n.back)?i.$.back(t,e):void 0}if("function"!=typeof t)return"number"==typeof t?(n.back||n).$.back(t-1):this;for(var a,i={back:n};(i=i.back)&&void 0===(a=t(i,e)););return a};var s={}})(S,"./back"),S(function(t){var i=S("./root");function p(t,e){if(e=e||this.as||t.$._,(!t.$$||this===i.on)&&t.put&&!e.soul){var n=t.put||"",r=n["="]||n[":"],t=e.root,n=t.$.get(n["#"]).get(n["."])._;if("string"==typeof(r=y(r))){if(!(n.echo||(n.echo={}))[e.id]||(t.pass||"")[e.id]){if(o=t.pass){if(o[r+e.id])return;o[r+e.id]=1}((n.echo||(n.echo={}))[e.id]=e).has&&(e.link=r);var o,t=t.$.get(n.link=r)._;(t.echo||(t.echo={}))[n.id]=n,((o=e.ask||"")[""]||e.lex)&&t.on("out",{get:{"#":r}}),setTimeout.each(Object.keys(o),function(t,e){t&&(e=o[t])&&e.on("out",{get:{"#":r,".":t}})},0,99)}}else this===i.on&&((n.echo||(n.echo={}))[e.id]=e)}}function l(t,n){var r,e,o=t.put||"",o=h!==o["="]?o["="]:o[":"],i=n.root;if(h===o)return n.soul&&h!==n.put?void 0:(e=(t.$$||t.$||"")._||"",!t["@"]||h===e.put&&h===n.put?((r=n.link||t.linked)&&delete(i.$.get(r)._.echo||"")[n.id],n.has&&(n.link=null),n.put=h,void setTimeout.each(Object.keys(n.next||""),function(t,e){(e=n.next[t])&&(r&&delete(i.$.get(r).get(t)._.echo||"")[e.id],e.on("in",{get:t,put:h,$:e.$}))},0,99)):void 0);n.soul||t.$$||(r=y(o),e=t.$._||"",(r!==e.link&&(!n.has||e.link)||(i.pass||"")[n.id]&&"string"!=typeof r)&&(delete(e.echo||"")[n.id],l({get:n.get,put:h,$:t.$,linked:t.linked=t.linked||e.link},n)))}function a(t,e){var n=this.as,r=n.$._,o=(r.root,n.get||""),n=(t.put||"")[o["#"]]||"";if(!t.put||"string"==typeof o["."]&&h===n[o["."]])return h===r.put&&(r.soul||r.has)?(r.ack=(r.ack||0)+1,void r.on("in",{get:r.get,put:r.put=h,$:r.$,"@":t["@"]})):void 0;(t._||{}).miss=1,i.on.put(t)}i.chain.chain=function(t){var e=this,n=e._,r=new(t||e).constructor(e),t=r._;return t.root=n=n.root,t.id=++n.once,t.back=e._,t.on=i.on,t.on("in",i.on.in,t),t.on("out",i.on.out,t),r},i.on.out=function(t){var e,n,r=this.as,o=r.back,i=r.root;if(t.$||(t.$=r.$),this.to.next(t),!r.err){if(e=t.get){if(i.pass&&(i.pass[r.id]=r),r.lex&&Object.keys(r.lex).forEach(function(t){n[t]=r.lex[t]},n=t.get=t.get||{}),e["#"]||r.soul){if(e["#"]=e["#"]||r.soul,t["#"]||(t["#"]=s(9)),o=i.$.get(e["#"])._,e=e["."]){if(u(o.put,e)&&(n=o.ask&&o.ask[e],(o.ask||(o.ask={}))[e]=o.$.get(e)._,o.on("in",{get:e,put:{"#":o.soul,".":e,":":o.put[e],">":g(i.graph[o.soul],e)}}),n))return}else{if(n=o.ask&&o.ask[""],(o.ask||(o.ask={}))[""]=o,h!==o.put&&(o.on("in",o),n))return;t.$=o.$}return i.ask(a,t),i.on("in",t)}if(e["."])return r.get?(t={get:{".":r.get},$:r.$},(o.ask||(o.ask={}))[r.get]=t.$._):t={get:r.lex?t.get:{},$:r.$},o.on("out",t);if(((r.ask||(r.ask={}))[""]=r).get)return e["."]=r.get,(o.ask||(o.ask={}))[r.get]=t.$._,o.on("out",t)}return o.on("out",t)}r.on("in",{put:r.put=h,$:r.$})},i.on.in=function(e,n){var r,t,o=(n=n||this.as).root,i=((r=e.$||(e.$=n.$))||"")._||d,a=e.put||"",s=a["#"],u=a["."],c=h!==a["="]?a["="]:a[":"],f=a[">"]||-1/0;if(h!==e.put&&(h===a["#"]||h===a["."]||h===a[":"]&&h===a["="]||h===a[">"]))return y(a)?void n.on("in",{$:i.back.$,put:{"#":s=i.back.soul,".":u=i.has||i.get,"=":a,">":g(i.back.put,u)},via:e}):(s=((a||"")._||"")["#"])?(r=n.root.$.get(s),setTimeout.each(Object.keys(a).sort(),function(t){"_"!=t&&h!==(f=g(a,t))&&n.on("in",{$:r,put:{"#":s,".":t,"=":a[t],">":f},VIA:e})})):void console.log("chain not yet supported for",a,"...",e,n);(e.seen||"")[n.id]||(((e.seen||(e.seen=function(){}))[n.id]=n)!==i&&(Object.keys(e).forEach(function(t){a[t]=e[t]},a={}),a.get=n.get||a.get,n.soul||n.has?i.soul&&(a.$=n.$,a.$$=a.$$||i.$):a.$$$=a.$$$||n.$,e=a),l(e,n),(n.soul||e.$$)&&f>=g(o.graph[s],u)&&((a=o.$.get(s)._).put=v(a.put,u,f,c,s)),!i.soul&&f>=g(o.graph[s],u)&&(t=(o.$.get(s)._.next||"")[u])&&(t.put=c,"string"==typeof(a=y(c))&&(t.put=o.$.get(a)._.put||c)),this.to&&this.to.next(e),n.any&&setTimeout.each(Object.keys(n.any),function(t){(t=n.any[t])&&t(e)},0,99),n.echo&&setTimeout.each(Object.keys(n.echo),function(t){(t=n.echo[t])&&t.on("in",e)},0,99),((e.$$||"")._||i).soul&&(t=n.next)&&(t=t[u])&&(a={},Object.keys(e).forEach(function(t){a[t]=e[t]}),a.$=(e.$$||e.$).get(a.get=u),delete a.$$,delete a.$$$,t.on("in",a)),p(e,n))},i.on.link=p,i.on.unlink=l;var h,d={},s=String.random,y=i.valid,u=function(t,e){return t&&Object.prototype.hasOwnProperty.call(t,e)},e=i.state,g=e.is,v=e.ify})(S,"./chain"),S(function(t){var y=S("./root");function i(t){var e=this.at||this.on;if(!t||e.soul||e.has)return this.off();if(t=(t=(t=t.$||t)._||t).id){e.map;if((e=this.seen||(this.seen={}))[t])return!0;e[t]=!0}}y.chain.get=function(t,e,n){var r;if("string"==typeof t){if(0==t.length)return(o=this.chain())._.err={err:y.log("0 length key",t)},e&&e.call(o,o._.err),o;var o=(o=!(o=((f=this._).next||a)[t])?t&&function(t,e){var n=e._,r=n.next,o=e.chain()._;r=r||(n.next={});r[o.get=t]=o,e===n.root.$?o.soul=t:(n.soul||n.has)&&(o.has=t);return o}(t,this):o)&&o.$}else{if("function"==typeof t){if(!0===e)return function(t,e,n){var a,s=t._,u=0;if(a=s.soul||s.link)return e(a,n,s);if(s.jam)return s.jam.push([e,n]);s.jam=[[e,n]],t.get(function(t,e){if(!(g===t.put&&!s.root.opt.super&&(a=Object.keys(s.root.opt.peers).length)&&++u<=a)){e.rid(t);var n=(n=t.$)&&n._||{},r=0;for(a=s.jam,delete s.jam;i=a[r++];){var o=i[0],i=i[1];o&&o(n.link||n.soul||y.valid(t.put)||((t.put||{})._||{})["#"],i,t,e)}}},{out:{get:{".":!0}}})}(this,t,n),this;var c,f=(o=this)._,p=e||{},l=f.root;p.at=f,p.ok=t;var h={};function d(e,t,n){if(!d.stun&&(!(r=l.pass)||r[c])){var r,o=e.$._,i=(e.$$||"")._,a=(i||o).put,s=!o.has&&!o.soul,u={};if(!s&&g!==a||(a=g===((r=e.put)||"")["="]?g===(r||"")[":"]?r:r[":"]:r["="]),"string"==typeof(r=y.valid(a))&&(a=g===(r=l.$.get(r)._.put)?p.not?g:a:r),!p.not||g!==a){if(g===p.stun){if((r=l.stun)&&r.on&&(f.$.back(function(t){if(r.on(""+t.id,u={}),(u.run||0)<d.id)return u}),u.run||r.on(""+o.id,u={}),!u.run&&i&&r.on(""+i.id,u={}),d.id>u.run&&(u.stun&&!u.stun.end||(u.stun=r.on("stun"),u.stun=u.stun&&u.stun.last),u.stun&&!u.stun.end)))return void((u.stun.add||(u.stun.add={}))[c]=function(){d(e,t,1)});if(g===a&&(n=0),(r=l.hatch)&&!r.end&&g===p.hatch&&!n)return h[o.$._.id]?void 0:(h[o.$._.id]=1,void r.push(function(){d(e,t,1)}));h={}}if(l.pass){if(l.pass[c+o.id])return;l.pass[c+o.id]=1}p.on?p.ok.call(o.$,a,o.get,e,t||d):p.v2020?p.ok(e,t||d):(Object.keys(e).forEach(function(t){r[t]=e[t]},r={}),(e=r).put=a,p.ok.call(p.as,e,t||d))}}}return(((d.at=f).any||(f.any={}))[c=String.random(7)]=d).off=function(){d.stun=1,f.any&&delete f.any[c]},d.rid=i,d.id=p.run||++l.once,r=l.pass,(l.pass={})[c]=1,p.out=p.out||{get:{}},f.on("out",p.out),l.pass=r,o}if("number"==typeof t)return this.get(""+t,e,n);if("string"==typeof(r=s(t)))return this.get(r,e,n);(r=this.get.next)&&(o=r(this,t))}return o?e&&"function"==typeof e&&o.get(e,n):((o=this.chain())._.err={err:y.log("Invalid get request",t)},e&&e.call(o,o._.err)),o};var g,a={},s=y.valid})(S,"./get"),S(function(t){var v=S("./root");function b(e,t){var n,r,o;t&&(t=(t._||"").id||t,n=e.root.stun||(e.root.stun={on:v.on}),r={},e.stun||(e.stun=n.on("stun",function(){})),(o=n.on(""+t))&&o.the.last.next(r),r.run>=e.run||n.on(""+t,function(t){return e.stun.end?(this.off(),void this.to.next(t)):(t.run=t.run||e.run,void(t.stun=t.stun||e.stun))}))}function w(e){var n,t,r,o,i;e.err?w.end(e.stun,e.root):e.todo.length||e.end||!Object.empty(e.wait)||(e.end=1,i=e.$.back(-1)._,n=i.root,t=i.ask(function(t){n.on("ack",t),t.err&&!t.lack&&v.log(t),++r>(e.acks||0)&&this.off(),e.ack&&e.ack(t,this)},e.opt),r=0,o=e.stun,(i=function(){o&&(w.end(o,n),setTimeout.each(Object.keys(o=o.add||""),function(t){(t=o[t])&&t()}))}).hatch=i,e.ack&&!e.ok&&(e.ok=e.acks||9),e.via._.on("out",{put:e.out=e.graph,ok:e.ok&&{"@":e.ok+1},opt:e.opt,"#":t,_:i}))}v.chain.put=function(t,e,y){var n=this,r=n._,o=r.root;(y=y||{}).root=r.root,y.run||(y.run=o.once),b(y,r.id),y.ack=y.ack||e,y.via=y.via||n,y.data=y.data||t,y.soul||(y.soul=r.soul||"string"==typeof e&&e);var g=y.state=y.state||v.state();return"function"==typeof t?t(function(t){y.data=t,n.put(void 0,void 0,y)}):y.soul?(y.$=o.$.get(y.soul),y.todo=[{it:y.data,ref:y.$}],y.turn=y.turn||i,y.ran=y.ran||w,function t(){var e,n,o,i,a,r,s,u=y.todo,c=u.pop(),f=c.it;c.ref&&c.ref._.id;if(b(y,c.ref),(i=c.todo)&&(f=f[n=i.pop()],i.length&&u.push(c)),n&&(u.path||(u.path=[])).push(n),!(e=m(f))&&!(a=v.is(f))){if(!Object.plain(f))return void w.err(y,"Invalid data: "+((r=f)&&(s=r.constructor)&&s.name||typeof r)+" at "+(y.via.back(function(t){t.get&&i.push(t.get)},i=[])||i.join("."))+"."+(u.path||[]).join("."));for(var p=y.seen||(y.seen=[]),l=p.length;l--;)if(f===(i=p[l]).it){e=f=i.link;break}}if(n&&e)c.node=k(c.node,n,g,f);else{if(!y.seen)return void w.err(y,"Data at root of graph must be a node (an object).");y.seen.push(o={it:f,link:{},todo:a?[]:Object.keys(f).sort().reverse(),path:(u.path||[]).slice(),up:c}),c.node=k(c.node,n,g,o.link),!a&&o.todo.length&&u.push(o);var h=y.seen.length;function d(t,e){var n=o.link["#"];e&&(e.off(),e.rid(t));var r=n||t.soul||(i=(t.$$||t.$)._||"").soul||i.link||((i=i.put||"")._||"")["#"]||i["#"]||((i=t.put||"")&&t.$$?i:i["="]||i[":"]||"")["#"];n||b(y,t.$),r||c.link["#"]?(r||(r=[],(t.$$||t.$).back(function(t){return(i=t.soul||t.link)?r.push(i):void r.push(t.get)}),r=r.reverse().join("/")),o.link["#"]=r,a||(((y.graph||(y.graph={}))[r]=o.node||(o.node={_:{}}))._["#"]=r),delete y.wait[h],o.wait&&setTimeout.each(o.wait,function(t){t&&t()}),y.ran(y)):(c.wait||(c.wait=[])).push(function(){d(t,e)})}(y.wait||(y.wait={}))[h]="",i=(o.ref=a?f:n?c.ref.get(n):c.ref)._,(i=f&&(f._||"")["#"]||i.soul||i.link)?d({soul:i}):o.ref.get(d,{run:y.run,v2020:1,out:{get:{".":" "}}})}if(!u.length)return y.ran(y);y.turn(t)}()):function(e){var n,t=e.via._;e.via=e.via.back(function(t){return t.soul||!t.get?t.$:(n=e.data,void((e.data={})[t.get]=n))}),e.via&&e.via._.soul||(e.via=t.root.$.get(((e.data||"")._||"")["#"]||t.$.back("opt.uuid")()));e.via.put(e.data,e.ack,e)}(y),n},w.end=function(t,e){t.end=n,t.the.to===t&&t===t.the.last&&delete e.stun,t.off()},w.err=function(t,e){(t.ack||n).call(t,t.out={err:t.err=v.log(e)}),t.ran(t)};var n=function(){},i=setTimeout.turn,m=v.valid,k=v.state.ify})(S,"./put"),S(function(t){var e=S("./root");S("./chain"),S("./back"),S("./put"),S("./get"),t.exports=e})(S,"./index"),S(function(t){var y=S("./index");y.chain.on=function(t,e,n,r){var o=this._;o.root;if("string"==typeof t)return e?(r=o.on(t,e,n||o,r),n&&n.$&&(n.subs||(n.subs=[])).push(r),this):o.on(t);(e=!0===e?{change:!0}:e||{}).not=1,e.on=1;return this.get(t,e),this},y.chain.once=function(c,f){if(f=f||{},!c)return(n=(t=this).chain())._.nix=t.once(function(t,e){n._.on("in",this._)}),n._.lex=t._.lex,n;var t,n,p,l=this._,h=l.root,d=(l.put,String.random(7));return this.get(function(e,n,r,o){var i=this,a=i._,s=a.one||(a.one={});function u(t){a.has||a.soul||(a={put:e,get:n}),void 0===(p=a.put)&&(p=((r.$$||"")._||"").put),"string"!=typeof y.valid(p)||void 0!==(p=h.$.get(p)._.put)||t?o.stun||""!==s[d]&&(s[d]="",(l.soul||l.has)&&o.off(),c.call(i,p,a.get),clearTimeout(s[d])):s[d]=setTimeout(function(){u(1)},f.wait||99)}o.stun||""!==s[d]&&(!0!==(p=y.valid(e))?"string"!=typeof p&&(clearTimeout((l.one||"")[d]),clearTimeout(s[d]),s[d]=setTimeout(u,f.wait||99)):u())},{on:1}),this},y.chain.off=function(){var n,t=this._,r=t.back;if(r)return t.ack=0,(n=r.next)&&n[t.get]&&delete n[t.get],(n=r.ask)&&delete n[t.get],(n=r.put)&&delete n[t.get],(n=t.soul)&&delete r.root.graph[n],(n=t.map)&&Object.keys(n).forEach(function(t,e){(e=n[t]).link&&r.root.$.get(e.link).off()}),(n=t.next)&&Object.keys(n).forEach(function(t,e){n[t].$.off()}),t.on("off",{}),this}})(S,"./on"),S(function(t){var s=S("./index"),r=s.chain.get.next;function u(t){this.to.next(t);var e=this.as,n=t.$._,r=t.put;(n.soul||t.$$)&&((n=e.lex)&&!String.match(t.get||(r||"")["."],n["."]||n["#"]||n)||s.on.link(t,e))}s.chain.get.next=function(t,e){var n;return Object.plain(e)?(n=((n=e["#"])||"")["="]||n)?t.get(n):((n=t.chain()._).lex=e,t.on("in",function(t){String.match(t.get||(t.put||"")["."],e["."]||e["#"]||e)&&n.on("in",t),this.to.next(t)}),n.$):(r||c)(t,e)},s.chain.map=function(i,t,e){var n,a,r=this,o=r._;return Object.plain(i)&&(n=i["."]?i:{".":i},i=void 0),i?(a=r.chain(),r.map().on(function(t,e,n,r){r=(i||c).call(this,t,e,n,r);if(void 0!==r){if(t===r)return a._.on("in",n);if(s.is(r))return a._.on("in",r._);var o={};Object.keys(n.put).forEach(function(t){o[t]=n.put[t]},o),o["="]=r,a._.on("in",{get:e,put:o})}})):(a=o.each)||((o.each=a=r.chain())._.lex=n||a._.lex||o.lex,a._.nix=r.back("nix"),r.on("in",u,a._)),a};var c=function(){}})(S,"./map"),S(function(t){var s=S("./index");s.chain.set=function(t,o,e){var n,i,a=this,r=a.back(-1);return o=o||function(){},(e=e||{}).item=e.item||t,(n=((t||"")._||"")["#"])&&((t={})["#"]=n),"string"==typeof(i=s.valid(t))?a.get(n=i).put(t,o,e):s.is(t)?(a.put(function(r){t.get(function(t,e,n){return t?((i={})[t]={"#":t},void r(i)):o.call(a,{err:s.log('Only a node can be linked. Not "'+n.put+'"!')})},!0)}),t):(Object.plain(t)&&(t=r.get(n=a.back("opt.uuid")()).put(t)),a.get(n||r.back("opt.uuid")(7)).put(t,o,e))}})(S,"./set"),S(function(t){S("./shim");function e(){}var i=JSON.parseAsync||function(t,e,n){var r=+new Date;try{e(void 0,JSON.parse(t,n),_.sucks(+new Date-r))}catch(t){e(t)}},_=JSON.stringifyAsync||function(t,e,n,r){var o=+new Date;try{e(void 0,JSON.stringify(t,n,r),_.sucks(+new Date-o))}catch(t){e(t)}};function n(u){var d=function(){},y=u.opt||{};y.log=y.log||console.log,y.gap=y.gap||y.wait||0,y.max=y.max||.3*(y.memory?999*y.memory*999:3e8),y.pack=y.pack||.01*y.max*.01,y.puff=y.puff||9;var g=setTimeout.turn||setTimeout,v=u.dup,b=v.check,w=v.track,o=(new Date,d.hear=function(t,a){if(t){if(y.max<=t.length)return d.say({dam:"!",err:"Message too big"},a);d===this&&(o.d+=t.length||0,++o.c);var e,n=a.SH=+new Date,r=t[0];if("["===r)return i(t,function(t,o){if(t||!o)return d.say({dam:"!",err:"JSON parse error"},a);console.STAT&&console.STAT(+new Date,o.length,"# on hear batch");var i=y.puff;!function t(){for(var e,n=+new Date,r=0;r<i&&(e=o[r++]);)d.hear(e,a);o=o.slice(r),console.STAT&&console.STAT(n,+new Date-n,"hear loop"),m(a),o.length&&g(t,0)}()}),void(t="");if("{"===r||(t["#"]||Object.plain(t))&&(e=t)){if(e)return o.one(e,a,n);i(t,function(t,e){return t||!e?d.say({dam:"!",err:"JSON parse error"},a):void o.one(e,a,n)})}}});o.one=function(t,e,n){var r,o,i,a,s;if(t.DBG&&(t.DBG=s={DBG:t.DBG}),s&&(s.h=n),s&&(s.hp=+new Date),(r=t["#"])||(r=t["#"]=String.random(9)),!((i=b(r))||(o=t["##"])&&(i=t["@"]||t.get&&r)&&v.check(a=i+o))){if((t._=function(){}).via=d.leap=e,(i=t["><"])&&"string"==typeof i&&i.slice(0,99).split(",").forEach(function(t){this[t]=1},t._.yo={}),i=t.dam)return(i=d.hear[i])&&i(t,e,u),void w(r);(i=t.ok)&&(t._.near=i["/"]);n=+new Date;s&&(s.is=n),e.SI=r,u.on("in",d.last=t),s&&(s.hd=+new Date),console.STAT&&console.STAT(n,+new Date-n,t.get?"msg get":t.put?"msg put":"msg"),(i=w(r)).via=e,t.get&&(i.it=t),a&&w(a),d.leap=d.last=null}};function m(t){var e=t.batch,n="string"==typeof e;if(n&&(e+="]"),t.batch=t.tail=null,e&&(n?!(e.length<3):e.length)){if(!n)try{e=1===e.length?e[0]:JSON.stringify(e)}catch(t){return y.log("JSON stringify error",t)}e&&k(e,t)}}function k(e,n){try{var t=n.wire;n.say?n.say(e):t.send&&t.send(e),d.say.d+=e.length||0,++d.say.c}catch(t){(n.queue=n.queue||[]).push(e)}}o.c=o.d=0,function(){var l,h=0;function t(t,e){var n;return e instanceof Object?(Object.keys(e).sort().forEach(r,{to:n={},on:e}),n):e}function r(t){this.to[t]=this.on[t]}d.hash=function(r,o){var i,a,s,u=+new Date;_(r.put,function t(e,n){n=(a=a||(s=n||"")).slice(0,32768);i=String.hash(n,i),(a=a.slice(32768))?g(t,0):(console.STAT&&console.STAT(u,+new Date-u,"say json+hash"),r._.$put=s,r["##"]=i,d.say(r,o),delete r._.$put)},t)};d.say=function(i,t){var e;if((e=this)&&(e=e.to)&&e.next&&e.next(i),!i)return!1;var n,a,s=i["@"],u=i._||(i._=function(){}),r=i.DBG,o=+new Date;if(u.y=u.y||o,t||r&&(r.y=o),(n=i["#"])||(n=i["#"]=String.random(9)),l||w(n),i["##"]||x===i.put||u.via||!s){if(!(t=!t&&s?(e=v.s[s])&&(e.via||(e=e.it)&&(e=e._)&&e.via)||(e=d.last)&&s===e["#"]&&d.leap:t)&&s)return v.s[s]?void 0:(console.STAT&&console.STAT(+new Date,++h,"total no peer to ack to"),!1);if(!t&&d.way)return d.way(i);if(r&&(r.yh=+new Date),a=u.raw){if(r&&(r.yr=+new Date),!t||!t.id){if(!Object.plain(t||y.peers))return!1;var o=+new Date,c=(y.puff,y.peers),f=Object.keys(t||y.peers||{});return console.STAT&&console.STAT(o,+new Date-o,"peer keys"),void function t(){var e=+new Date;l=1;var n=u.raw;u.raw=a;for(var r,o=0;o<9&&(r=(f||"")[o++]);)(r=c[r])&&d.say(i,r);u.raw=n,l=0,f=f.slice(o),console.STAT&&console.STAT(e,+new Date-e,"say loop"),f.length&&(g(t,0),s&&w(s))}()}if(!t.wire&&d.wire&&d.wire(t),n!==t.last){if(t.last=n,t===u.via)return!1;if((e=u.yo)&&(e[t.url]||e[t.pid]||e[t.id]))return!1;if(console.STAT&&console.STAT(o,((r||u).yp=+new Date)-(u.y||o),"say prep"),!l&&s&&w(s),t.batch){if(t.tail=(e=t.tail||0)+a.length,t.tail<=y.pack)return void(t.batch+=(e?",":"")+a);m(t)}t.batch="[";var p=+new Date;setTimeout(function(){console.STAT&&console.STAT(p,+new Date-p,"0ms TO"),m(t)},y.gap),k(a,t),console.STAT&&s===t.SI&&console.STAT(o,+new Date-t.SH,"say ack")}}else d.raw(i,t)}else d.hash(i,t)};d.say.c=d.say.d=0,d.raw=function(n,r){if(!n)return"";var o,i=n._||{};if(s=i.raw)return s;if("string"==typeof n)return n;var t=n["##"],e=n["@"];if(t&&e){if(!i.via&&b(e+t))return!1;if((s=(v.s[e]||"").it)||(s=d.last)&&e===s["#"]){if(t===s["##"])return!1;s["##"]||(s["##"]=t)}}if(!n.dam&&!n["@"]){var a,s,u=0,c=[];for(a in s=y.peers){var f=s[a];if(c.push(f.url||f.pid||f.id),6<++u)break}1<u&&(n["><"]=c.join())}if(n.put&&(s=n.ok)&&(n.ok={"@":(s["@"]||1)-1,"/":s["/"]==n._.near?d.near:s["/"]}),o=i.$put)return s={},Object.keys(n).forEach(function(t){s[t]=n[t]}),s.put=":])([:",void _(s,function(t,e){t||(t=+new Date,s=e.indexOf('"put":":])([:"'),p(x,e=e.slice(0,s+6)+o+e.slice(s+14)),console.STAT&&console.STAT(t,+new Date-t,"say slice"))});function p(t,e){t||(i.raw=e,d.say(n,r))}_(n,p)}}(),d.near=0,d.hi=function(e){var t;e.wire?(e.id?y.peers[e.url||e.id]=e:(t=e.id=e.id||String.random(9),d.say({dam:"?",pid:u.opt.pid},y.peers[t]=e),delete v.s[e.last]),e.met||(d.near++,e.met=+new Date,u.on("hi",e)),t=e.queue,e.queue=[],setTimeout.each(t||[],function(t){k(t,e)},0,9)):d.wire(e.length?{url:e,id:e}:e)},d.bye=function(t){t.met&&--d.near,delete t.met,u.on("bye",t);var e=+new Date;e-=t.met||e,d.bye.time=((d.bye.time||e)+e)/2},d.hear["!"]=function(t,e){y.log("Error:",t.err)},d.hear["?"]=function(t,e){t.pid&&(e.pid||(e.pid=t.pid),t["@"])||(d.say({dam:"?",pid:y.pid,"@":t["#"]},e),delete v.s[e.last])},d.hear.mob=function(t,e){!t.peers||(t=(t=Object.keys(t.peers))[Math.floor(Math.random()*t.length)])&&(d.bye(e),d.hi(t))},u.on("create",function(t){t.opt.pid=t.opt.pid||String.random(9),this.to.next(t),t.on("out",d.say)}),u.on("bye",function(t,e){t=y.peers[t.id||t]||t,this.to.next(t),t.bye?t.bye():(e=t.wire)&&e.close&&e.close(),delete y.peers[t.id],t.wire=null});var r={};return u.on("bye",function(t,e){this.to.next(t),(e=console.STAT)&&(e.peers=d.near),(e=t.url)&&(r[e]=!0,setTimeout(function(){delete r[e]},y.lack||9e3))}),u.on("hi",function(e,n){this.to.next(e),(n=console.STAT)&&(n.peers=d.near),(n=e.url)&&r[n]&&(delete r[n],y.super||setTimeout.each(Object.keys(u.next),function(t){u.next[t];(n={})[t]=u.graph[t],n=String.hash(n),d.say({"##":n,get:{"#":t}},e)}))}),d}_.sucks=function(t){99<t&&(console.log("JSON blocking CPU detected"),_.sucks=e)};var x;try{t.exports=n}catch(t){}})(S,"./mesh"),S(function(t){var s=S("./index");s.Mesh=S("./mesh"),s.on("opt",function(t){var r,e,n,o;function i(e){try{if(!e||!e.url)return n&&n(e);var t=e.url.replace(/^http/,"ws"),n=e.wire=new r.WebSocket(t);return n.onclose=function(){r.mesh.bye(e),a(e)},n.onerror=function(t){a(e)},n.onopen=function(){r.mesh.hi(e)},n.onmessage=function(t){t&&r.mesh.hear(t.data||t,e)},n}catch(t){}}function a(e){clearTimeout(e.defer),r.peers[e.url]&&(o&&e.retry<=0||(e.retry=(e.retry||r.retry+1||60)-(-e.tried+(e.tried=+new Date)<4*n?1:0),e.defer=setTimeout(function t(){return o&&o.hidden?setTimeout(t,n):void i(e)},n)))}this.to.next(t),t.once||!1!==(r=t.opt).WebSocket&&(e=s.window||{},(e=r.WebSocket||e.WebSocket||e.webkitWebSocket||e.mozWebSocket)&&(r.WebSocket=e,(e=r.mesh=r.mesh||s.Mesh(t)).wire||r.wire,e.wire=r.wire=i,setTimeout(function(){r.super||t.on("out",{dam:"hi"})},1),n=1998,o=""+void 0!=typeof document&&document))})})(S,"./websocket"),S(function(t){if("undefined"!=typeof Database){var o;try{o=(Database.window||function(){}).localStorage}catch(t){}o||(Database.log("No localStorage exists to persist data to"),o={setItem:function(t,e){this[t]=e},removeItem:function(t){delete this[t]},getItem:function(t){return this[t]}});JSON.parseAsync;var i=JSON.stringifyAsync||function(t,e,n,r){try{e(void 0,JSON.stringify(t,n,r))}catch(t){e(t)}};Database.on("create",function e(a){this.to.next(a);var s,u,c,f,r=a.opt,p=(a.graph,[]);if(!1!==r.localStorage){r.prefix=r.file||"db/";try{s=e[r.prefix]=e[r.prefix]||JSON.parse(c=o.getItem(r.prefix))||{}}catch(t){s=e[r.prefix]={}}c=(c||"").length,a.on("get",function(t){this.to.next(t);var e,n,r,o=t.get;o&&(e=o["#"])&&((n=s[e]||void 0)&&(r=o["."])&&!Object.plain(r)&&(n=Database.state.ify({},r,Database.state.is(n,r),n[r],e)),Database.on.get.ack(t,n))}),a.on("put",function(t){this.to.next(t);var e=t.put,n=e["#"],r=e["."],o=t["#"],i=t.ok||"";s[n]=Database.state.ify(s[n],r,e[">"],e[":"],n),f&&4999880<c?a.on("in",{"@":o,err:"localStorage max"}):(t["@"]||t._.via&&!(Math.random()<i["@"]/i["/"])||p.push(o),u=u||setTimeout(l,9+c/333))})}function l(){var n;p.length||!((setTimeout.turn||"").s||"").length?(n=p,clearTimeout(u),u=!1,p=[],i(s,function(e,t){try{e||o.setItem(r.prefix,t)}catch(t){e=f=t||"localStorage failure"}e&&a.on("localStorage:error",{err:e,get:r.prefix,put:s}),c=t.length,setTimeout.each(n,function(t){a.on("in",{"@":t,err:e,ok:0})},0,99)})):setTimeout(l,99)}})}})(S,"./localStorage")}(),function(){var p,e,l,h,s,n,r,o,u,i,a,c,f,d,y,g,t,v,b,w,m,k,_,x,S;function j(t,e){w(this,e)&&void 0!==this[e]||(this[e]=t)}function A(t,e){var n=this.n;if(!n||!(e===n||v(n)&&w(n,e)))return void 0!==e||void 0}function $(t,e){if(2===arguments.length)return $.r=$.r||{},void($.r[t]=e);$.r=$.r||[],$.r.push(t)}function T(t,e){return!this.id&&e==n&&o(t)?void(this.id=t):this.id=!1}function D(t,e){if(e!==u._)return!s.is(t)||void(this.cb&&this.cb.call(this.as,t,e,this.n,this.s))}function O(t,e){var n,r=this.o;r.map?void 0===(n=r.map.call(this.as,t,""+e,r.node))?b(r.node,e):r.node&&(r.node[e]=n):s.is(t)&&(r.node[e]=t)}function E(t,e){d!==e&&c.ify(this.o,e,this.s)}function B(t,e){if(!t||e!==u.soul(t)||!u.is(t,this.fn,this.as))return!0;this.cb&&(N.n=t,N.as=this.as,this.cb.call(N.as,t,e,N))}function N(t){t&&u.is(N.n,t,N.as)}function C(t,e){var n;return(n=function(t,e){var n,r=t.seen,o=r.length;for(;o--;)if(n=r[o],e.obj===n.obj)return n;r.push(e)}(t,e))?n:(e.env=t,e.soul=U,u.ify(e.obj,J,e)&&(e.link=e.link||s.link.ify(u.soul(e.node)),e.obj!==t.shell&&(t.graph[s.link.is(e.link)]=e.node)),e)}function J(t,e,n){var r,o,i=this,a=i.env;if(u._===e&&w(t,s.link._))return n._;if(r=I(t,e,n,i,a)){if(e||(i.node=i.node||n||{},w(t,u._)&&u.soul(t)&&(i.node._=x(t._)),i.node=u.soul.ify(i.node,s.link.is(i.link)),i.link=i.link||s.link.ify(u.soul(i.node))),(o=a.map)&&(o.call(a.as||{},t,e,n,i),w(n,e))){if(t=n[e],S===t)return void b(n,e);if(!(r=I(t,e,n,i,a)))return}return e?!0===r?t:(o=C(a,{obj:t,path:i.path.concat(e)})).node?o.link:void 0:i.node}}function U(t){var e=this,n=s.link.is(e.link),r=e.env.graph;e.link=e.link||s.link.ify(t),e.link[s.link._]=t,e.node&&e.node[u._]&&(e.node[u._][s.link._]=t),w(r,n)&&(r[t]=r[n],b(r,n))}function I(t,e,n,r,o){var i;return!!s.is(t)||(v(t)?1:(i=o.invalid)?I(t=i.call(o.as||{},t,e,n),e,n,r,o):(o.err="Invalid value at '"+r.path.concat(e).join(".")+"'",void(p.list.is(t)&&o.err)))}function P(t,e){var n,r;if(u._===e)return m(t,s.link._)?void 0:void(this.obj[e]=x(t));(n=s.link.is(t))?(r=this.opt.seen[n])?this.obj[e]=r:this.obj[e]=this.opt.seen[n]=y.to(this.graph,n,this.opt):this.obj[e]=t}""+S!=typeof Database&&((p=Database).fn=p.fn||{is:function(t){return!!t&&"function"==typeof t}},p.bi=p.bi||{is:function(t){return t instanceof Boolean||"boolean"==typeof t}},p.num=p.num||{is:function(t){return!h(t)&&(0<=t-parseFloat(t)+1||1/0===t||-1/0===t)}},p.text=p.text||{is:function(t){return"string"==typeof t}},p.text.ify=p.text.ify||function(t){return p.text.is(t)?t:"undefined"!=typeof JSON?JSON.stringify(t):t&&t.toString?t.toString():t},p.text.random=p.text.random||function(t,e){var n="";for(t=t||24,e=e||"0123456789ABCDEFGHIJKLMNOPQRSTUVWXZabcdefghijklmnopqrstuvwxyz";0<t;)n+=e.charAt(Math.floor(Math.random()*e.length)),t--;return n},p.text.match=p.text.match||function(t,e){var n,r;return"string"==typeof t&&(t===((e=(e="string"==typeof e?{"=":e}:e)||{})["="]||e["*"]||e[">"]||e["<"])||r===e["="]&&(n=e["*"]||e[">"]||e["<"],t.slice(0,(n||"").length)===n||r===e["*"]&&(r!==e[">"]&&r!==e["<"]?t>=e[">"]&&t<=e["<"]:r!==e[">"]&&t>=e[">"]||r!==e["<"]&&t<=e["<"])))},p.text.hash=p.text.hash||function(t,e){if("string"==typeof t){if(e=e||0,!t.length)return e;for(var n=0,r=t.length;n<r;++n)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}},p.list=p.list||{is:function(t){return t instanceof Array}},p.list.slit=p.list.slit||Array.prototype.slice,p.list.sort=p.list.sort||function(n){return function(t,e){return t&&e?(t=t[n])<(e=e[n])?-1:e<t?1:0:0}},p.list.map=p.list.map||function(t,e,n){return _(t,e,n)},p.list.index=1,p.obj=p.boj||{is:function(t){return!!t&&(t instanceof Object&&t.constructor===Object||"Object"===Object.prototype.toString.call(t).match(/^\[object (\w+)\]$/)[1])}},p.obj.put=p.obj.put||function(t,e,n){return(t||{})[e]=n,t},p.obj.has=p.obj.has||function(t,e){return t&&Object.prototype.hasOwnProperty.call(t,e)},p.obj.del=p.obj.del||function(t,e){if(t)return t[e]=null,delete t[e],t},p.obj.as=p.obj.as||function(t,e,n,r){return t[e]=t[e]||(r===n?{}:n)},p.obj.ify=p.obj.ify||function(e){if(v(e))return e;try{e=JSON.parse(e)}catch(t){e={}}return e},p.obj.to=p.obj.to||function(t,e){return _(t,j,e=e||{}),e},p.obj.copy=p.obj.copy||function(t){return t&&JSON.parse(JSON.stringify(t))},p.obj.empty=p.obj.empty||function(t,e){return!t||!_(t,A,{n:e})},l=Object.keys,Object.keys=Object.keys||function(t){return e(t,function(t,e,n){n(e)})},p.obj.map=e=p.obj.map||function(t,e,n){var r,o,i,a,s,u=0,c="function"==typeof e;if($.r=r,l&&v(t)&&(a=l(t),s=!0),n=n||{},h(t)||a)for(o=(a||t).length;u<o;u++){var f=u+p.list.index;if(c){if((i=s?e.call(n,t[a[u]],a[u],$):e.call(n,t[u],f,$))!==r)return i}else if(e===t[s?a[u]:u])return a?a[u]:f}else for(u in t)if(c){if(w(t,u)&&(i=n?e.call(n,t[u],u,$):e(t[u],u,$))!==r)return i}else if(e===t[u])return u;return c?$.r:p.list.index?0:-1},p.time=p.time||{},p.time.is=p.time.is||function(t){return t?t instanceof Date:+(new Date).getTime()},g=p.fn.is,h=p.list.is,t=p.obj,v=t.is,w=t.has,_=t.map,(s={is:function(t){return t!==S&&(null===t||t!==1/0&&(!!(o(t)||r(t)||f(t))||(s.link.is(t)||!1)))}}).link=s.rel={_:"#"},s.link.is=function(t){if(t&&t[n]&&!t._&&v(t)){var e={};if(_(t,T,e),e.id)return e.id}return!1},s.link.ify=function(t){return k({},n,t)},p.obj.has._=".",n=s.link._,r=p.bi.is,f=p.num.is,o=p.text.is,v=(t=p.obj).is,k=t.put,_=t.map,p.val=p.val||s,(u={_:"_",soul:function(t,e){return t&&t._&&t._[e||a]}}).soul.ify=function(t,e){return e="string"==typeof e?{soul:e}:e||{},(t=t||{})._=t._||{},t._[a]=e.soul||t._[a]||i(),t},u.soul._=s.link._,u.is=function(t,e,n){var r;return!!v(t)&&(!!(r=u.soul(t))&&!_(t,D,{as:n,cb:e,s:r,n:t}))},u.ify=function(t,e,n){return e?"string"==typeof e?e={soul:e}:"function"==typeof e&&(e={map:e}):e={},e.map&&(e.node=e.map.call(n,t,S,e.node||{})),(e.node=u.soul.ify(e.node||{},e))&&_(t,O,{o:e,as:n}),e.node},v=(t=p.obj).is,b=t.del,_=t.map,i=p.text.random,a=u.soul._,p.node=p.node||u,(c=p.state).lex=function(){return c().toString(36).replace(".","")},c.to=function(t,e,n){var r=(t||{})[e];return v(r)&&(r=x(r)),c.ify(n,e,c.is(t,e),r,u.soul(t))},c.map=function(o,i,a){var t=v(t=o||i)?t:null;return o=g(o=o||i)?o:null,t&&!o?(i=f(i)?i:c(),t[d]=t[d]||{},_(t,E,{o:t,s:i}),t):(a=a||v(i)?i:void 0,i=f(i)?i:c(),function(t,e,n,r){if(!o)return E.call({o:n,s:i},t,e),t;o.call(a||this||{},t,e,n,r),w(n,e)&&void 0===n[e]||E.call({o:n,s:i},t,e)})},(t=p.obj).as,w=t.has,v=t.is,_=t.map,x=t.copy,f=p.num.is,g=p.fn.is,d=u._,y={is:function(t,e,n,r){return!(!t||!v(t)||m(t))&&!_(t,B,{cb:e,fn:n,as:r})},ify:function(t,e,n){t={path:[],obj:t};return e?"string"==typeof e?e={soul:e}:"function"==typeof e&&(e.map=e):e={},"string"==typeof n&&(e.soul=e.soul||n,n=S),e.soul&&(t.link=s.link.ify(e.soul)),e.shell=(n||{}).shell,e.graph=e.graph||{},e.seen=e.seen||[],e.as=e.as||n,C(e,t),e.root=t.node,e.graph},node:function(t){var e=u.soul(t);if(e)return k({},e,t)},to:function(t,e,n){if(t){var r={};return _(t[e],P,{obj:r,graph:t,opt:n=n||{seen:{}}}),r}}},g=p.fn.is,v=(t=p.obj).is,b=t.del,w=t.has,m=t.empty,k=t.put,_=t.map,x=t.copy,p.graph=p.graph||y)}(),function(){function o(n,t){return t?require(n):n.slice?o[r(n)]:function(t,e){n(t={exports:{}}),o[r(e)]=t.exports};function r(t){return t.split("/").slice(-1).toString().replace(".js","")}}var n;"undefined"!=typeof module&&(n=module),o(function(t){"undefined"!=typeof window&&(t.window=window);var e=(t.window||t).Connection||function(){};(e.window=t.window)&&(e.window.Connection=e);try{void 0!==n&&(n.exports=e)}catch(t){}t.exports=e})(o,"./root"),o(function(t){var e=o("./root"),u=(e.window||"").Database||o("./database",1);if(!((u.Connection=e).Database=u).window)try{o("./lib/connection",1)}catch(t){}u.on("opt",function(t){var n,r,e,o,i,a,s;(n=t).connection||(r=n.opt,e=r.peers,!1!==r.connection&&("undefined"!=typeof process&&"false"==""+(process.env||"").Connection||u.window&&(n.connection={},a=JSON.parse((localStorage||"")[(r.file||"")+"connection/"]||null)||{},Object.keys(a.peers||"").forEach(function(t){(o=e[i=t]=e[i]||{}).id=o.url=i}),(o=e[i="https://gun-rs.iris.to/gun"]=e[i]||{}).id=o.url=i,(s=r.mesh=r.mesh||u.Mesh(n)).way=function(t){if(n.$===t.$||(t._||"").via)s.say(t,r.peers);else{var e=(t.$||"")._;if(e){if(t.get){if(e.connection)return;e.connection={}}s.say(t,r.peers)}else s.say(t,r.peers)}}))),this.to.next(t)});t.exports=e})(o,"./connection")}(),function(){function w(n,t){return t?require(n):n.slice?w[r(n)]:function(t,e){n(t={exports:{}}),w[r(e)]=t.exports};function r(t){return t.split("/").slice(-1).toString().replace(".js","")}}var s;"undefined"!=typeof module&&(s=module),w(function(t){"undefined"!=typeof window&&(t.window=window);var e=(t.window||t).Encryption||{};(e.window=t.window)&&(e.window.Encryption=e);try{void 0+""!=typeof s&&(s.exports=e)}catch(t){}t.exports=e})(w,"./root"),w(function(t){var e=w("./root");try{e.window&&location.protocol.indexOf("s")<0&&location.host.indexOf("localhost")<0&&!/^127\.\d+\.\d+\.\d+$/.test(location.hostname)&&location.protocol.indexOf("file:")<0&&(location.protocol="https:")}catch(t){}})(w,"./https"),w(function(t){if(void 0+""==typeof btoa){if(void 0+""==typeof Buffer)try{global.Buffer=w("buffer",1).Buffer}catch(t){}global.btoa=function(t){return Buffer.from(t,"binary").toString("base64")},global.atob=function(t){return Buffer.from(t,"base64").toString("binary")}}})(w,"./base64"),w(function(t){function e(){}w("./base64"),Object.assign(e,{from:Array.from}),(e.prototype=Object.create(Array.prototype)).toString=function(t,n,e){n=n||0;var r=this.length;if("hex"!==(t=t||"utf8"))return"utf8"===t?Array.from({length:(e||r)-n},(t,e)=>String.fromCharCode(this[e+n])).join(""):"base64"===t?btoa(this):void 0;{const o=new Uint8Array(this);return[...Array((e&&e+1||r)-n).keys()].map(t=>o[t+n].toString(16).padStart(2,"0")).join("")}},t.exports=e})(w,"./array"),w(function(t){w("./base64");var u=w("./array");function e(...t){return e.from(...t)}e.prototype=Object.create(Array.prototype),Object.assign(e,{from(){if(!Object.keys(arguments).length||null==arguments[0])throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");const n=arguments[0];let t;if("string"==typeof n){var e=arguments[1]||"utf8";if("hex"===e){var r=n.match(/([\da-fA-F]{2})/g).map(t=>parseInt(t,16));if(!r||!r.length)throw new TypeError("Invalid first argument for type 'hex'.");t=u.from(r)}else if("utf8"===e||"binary"===e){const o=n.length,i=new Uint16Array(o);Array.from({length:o},(t,e)=>i[e]=n.charCodeAt(e)),t=u.from(i)}else if("base64"===e){const a=atob(n),o=a.length,s=new Uint8Array(o);Array.from({length:o},(t,e)=>s[e]=a.charCodeAt(e)),t=u.from(s)}else"binary"===e?t=u.from(n):console.info("Unknown encoding: "+e);return t}n.byteLength;const o=n.byteLength||n.length;if(o){let t;return n instanceof ArrayBuffer&&(t=new Uint8Array(n)),u.from(t||n)}},alloc(t,e=0){return u.from(new Uint8Array(Array.from({length:t},()=>e)))},allocUnsafe(t){return u.from(new Uint8Array(Array.from({length:t})))},concat(t){if(!Array.isArray(t))throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.");return u.from(t.reduce((t,e)=>t.concat(Array.from(e)),[]))}}),e.prototype.from=e.from,e.prototype.toString=u.prototype.toString,t.exports=e})(w,"./buffer"),w(function(t){var e=w("./root");const n={Buffer:w("./buffer")};var r={};if(JSON.parseAsync=JSON.parseAsync||function(t,e,n){try{e(void 0,JSON.parse(t,n))}catch(t){e(t)}},JSON.stringifyAsync=JSON.stringifyAsync||function(t,e,n,r){try{e(void 0,JSON.stringify(t,n,r))}catch(t){e(t)}},n.parse=function(t,e){return new Promise(function(n,r){JSON.parseAsync(t,function(t,e){t?r(t):n(e)},e)})},n.stringify=function(t,e,o){return new Promise(function(n,r){JSON.stringifyAsync(t,function(t,e){t?r(t):n(e)},e,o)})},e.window&&(n.crypto=window.crypto||window.msCrypto,n.subtle=(n.crypto||r).subtle||(n.crypto||r).webkitSubtle,n.TextEncoder=window.TextEncoder,n.TextDecoder=window.TextDecoder,n.random=t=>n.Buffer.from(n.crypto.getRandomValues(new Uint8Array(n.Buffer.alloc(t))))),n.TextDecoder||({TextEncoder:e,TextDecoder:r}=w((void 0+""==typeof s?".":"")+"./lib/text-encoding",1),n.TextDecoder=r,n.TextEncoder=e),!n.crypto)try{var o=w("crypto",1);Object.assign(n,{crypto:o,random:t=>n.Buffer.from(o.randomBytes(t))});const i=w("@peculiar/webcrypto",1)["Crypto"];n.ossl=n.subtle=new i({directory:"ossl"}).subtle}catch(t){}t.exports=n})(w,"./shim"),w(function(t){var e=w("./root"),n=w("./shim"),r={pbkdf2:{hash:{name:"SHA-256"},iter:1e5,ks:64},ecdsa:{pair:{name:"ECDSA",namedCurve:"P-256"},sign:{name:"ECDSA",hash:{name:"SHA-256"}}},ecdh:{name:"ECDH",namedCurve:"P-256"},jwk:function(t,e){t={kty:"EC",crv:"P-256",x:(t=t.split("."))[0],y:t[1],ext:!0};return t.key_ops=e?["sign"]:["verify"],e&&(t.d=e),t},keyToJwk:function(t){const e=t.toString("base64");return{kty:"oct",k:e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"}},recall:{validity:43200,hook:function(t){return t}},check:function(t){return"string"==typeof t&&"SEA{"===t.slice(0,4)},parse:async function(t){try{var e="string"==typeof t;return e&&"SEA{"===t.slice(0,4)&&(t=t.slice(3)),e?await n.parse(t):t}catch(t){}return t}};e.opt=r,t.exports=r})(w,"./settings"),w(function(t){var n=w("./shim");t.exports=async function(t,e){t="string"==typeof t?t:await n.stringify(t),t=await n.subtle.digest({name:e||"SHA-256"},(new n.TextEncoder).encode(t));return n.Buffer.from(t)}})(w,"./sha256"),w(function(t){var e=w("./shim"),n=e.subtle;const r=e.ossl||n;t.exports=t=>r.digest({name:"SHA-1"},new ArrayBuffer(t))})(w,"./sha1"),w(function(t){var c=w("./root"),f=w("./shim"),p=w("./settings"),l=w("./sha256");c.work=c.work||(async(t,e,n,r)=>{try{var o=(e||{}).epub||e;if(r=r||{},o instanceof Function&&(n=o,o=void 0),t="string"==typeof t?t:await f.stringify(t),"sha"===(r.name||"").toLowerCase().slice(0,3)){var i=f.Buffer.from(await l(t,r.name),"binary").toString(r.encode||"base64");if(n)try{n(i)}catch(t){console.log(t)}return i}var o=o||f.random(9),a=await(f.ossl||f.subtle).importKey("raw",(new f.TextEncoder).encode(t),{name:r.name||"PBKDF2"},!1,["deriveBits"]),s=await(f.ossl||f.subtle).deriveBits({name:r.name||"PBKDF2",iterations:r.iterations||p.pbkdf2.iter,salt:(new f.TextEncoder).encode(r.salt||o),hash:r.hash||p.pbkdf2.hash},a,r.length||8*p.pbkdf2.ks);t=f.random(t.length);var u=f.Buffer.from(s,"binary").toString(r.encode||"base64");if(n)try{n(u)}catch(t){console.log(t)}return u}catch(t){if(console.log(t),c.err=t,c.throw)throw t;return void(n&&n())}}),t.exports=c.work})(w,"./work"),w(function(t){var a=w("./root"),s=w("./shim");w("./settings");a.name=a.name||(async(e,t)=>{try{if(e)try{e()}catch(t){console.log(t)}return}catch(t){if(console.log(t),a.err=t,a.throw)throw t;return void(e&&e())}}),a.pair=a.pair||(async(e,t)=>{try{var n=s.ossl||s.subtle,r=await s.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async t=>{var e={};e.priv=(await s.subtle.exportKey("jwk",t.privateKey)).d;t=await s.subtle.exportKey("jwk",t.publicKey);return e.pub=t.x+"."+t.y,e});try{var o=await n.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async t=>{var e={};e.epriv=(await n.exportKey("jwk",t.privateKey)).d;t=await n.exportKey("jwk",t.publicKey);return e.epub=t.x+"."+t.y,e})}catch(t){if(a.window)throw t;if("Error: ECDH is not a supported algorithm"!=t)throw t;console.log("Ignoring ECDH...")}var o=o||{},i={pub:r.pub,priv:r.priv,epub:o.epub,epriv:o.epriv};if(e)try{e(i)}catch(t){console.log(t)}return i}catch(t){if(console.log(t),a.err=t,a.throw)throw t;return void(e&&e())}}),t.exports=a.pair})(w,"./pair"),w(function(t){var l=w("./root"),h=w("./shim"),d=w("./settings"),y=w("./sha256");l.sign=l.sign||(async(t,e,n,r)=>{try{if(r=r||{},!(e||r).priv){if(!l.I)throw"No signing key";e=await l.I(null,{what:t,how:"sign",why:r.why})}if(void 0===t)throw"`undefined` not allowed";var o=await d.parse(t),i=r.check=r.check||o;if(l.verify&&(l.opt.check(i)||i&&i.s&&i.m)&&void 0!==await l.verify(i,e)){var a=await d.parse(i);if(r.raw||(a="SEA"+await h.stringify(a)),n)try{n(a)}catch(t){console.log(t)}return a}var s=e.pub,u=e.priv,c=d.jwk(s,u),f=await y(o),p=await(h.ossl||h.subtle).importKey("jwk",c,{name:"ECDSA",namedCurve:"P-256"},!1,["sign"]).then(t=>(h.ossl||h.subtle).sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new Uint8Array(f))),a={m:o,s:h.Buffer.from(p,"binary").toString(r.encode||"base64")};if(r.raw||(a="SEA"+await h.stringify(a)),n)try{n(a)}catch(t){console.log(t)}return a}catch(t){if(console.log(t),l.err=t,l.throw)throw t;return void(n&&n())}}),t.exports=l.sign})(w,"./sign"),w(function(t){var h=w("./root"),d=w("./shim"),y=w("./settings"),g=w("./sha256");h.verify=h.verify||(async(e,n,r,o)=>{try{var t=await y.parse(e);if(!1===n){var i=await y.parse(t.m);if(r)try{r(i)}catch(t){console.log(t)}return i}o=o||{};var a,s,u,c=n.pub||n,f=h.opt.slow_leak?await h.opt.slow_leak(c):await(d.ossl||d.subtle).importKey("jwk",y.jwk(c),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),p=await g(t.m);try{if(a=d.Buffer.from(t.s,o.encode||"base64"),s=new Uint8Array(a),!(u=await(d.ossl||d.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},f,s,new Uint8Array(p))))throw"Signature did not match"}catch(t){if(h.opt.fallback)return h.opt.fall_verify(e,n,r,o)}var l=u?await y.parse(t.m):void 0;if(r)try{r(l)}catch(t){console.log(t)}return l}catch(t){if(console.log(t),h.err=t,h.throw)throw t;return void(r&&r())}}),t.exports=h.verify;var n={},f=(h.opt.slow_leak=t=>{if(n[t])return n[t];var e=y.jwk(t);return n[t]=(d.ossl||d.subtle).importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),n[t]},h.opt);h.opt.fall_verify=async function(t,e,n,r,o){if(o===h.opt.fallback)throw"Signature did not match";o=o||1;var i=t||"";t=h.opt.unpack(t)||t;var a,s,u,c=await y.parse(t),e=e.pub||e,e=await h.opt.slow_leak(e),o=o<=h.opt.fallback?d.Buffer.from(await d.subtle.digest({name:"SHA-256"},(new d.TextEncoder).encode(await y.parse(c.m)))):await g(c.m);try{if(a=d.Buffer.from(c.s,r.encode||"base64"),s=new Uint8Array(a),!(u=await(d.ossl||d.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},e,s,new Uint8Array(o))))throw"Signature did not match"}catch(t){try{a=d.Buffer.from(c.s,"utf8"),s=new Uint8Array(a),u=await(d.ossl||d.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},e,s,new Uint8Array(o))}catch(t){if(!u)throw"Signature did not match"}}c=u?await y.parse(c.m):void 0;if(f.fall_soul=i["#"],f.fall_key=i["."],f.fall_val=t,f.fall_state=i[">"],n)try{n(c)}catch(t){console.log(t)}return c},h.opt.fallback=2})(w,"./verify"),w(function(t){var r=w("./shim"),o=w("./settings"),i=w("./sha256");t.exports=async(t,e,n)=>{e=t+(e||r.random(8)).toString("utf8"),e=r.Buffer.from(await i(e),"binary"),e=o.keyToJwk(e);return r.subtle.importKey("jwk",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])}})(w,"./aeskey"),w(function(t){var c=w("./root"),f=w("./shim"),p=(w("./settings"),w("./aeskey"));c.encrypt=c.encrypt||(async(t,e,n,r)=>{try{r=r||{};var o=(e||r).epriv||e;if(void 0===t)throw"`undefined` not allowed";if(!o){if(!c.I)throw"No encryption key";o=(e=await c.I(null,{what:t,how:"encrypt",why:r.why})).epriv||e}var i="string"==typeof t?t:await f.stringify(t),a={s:f.random(9),iv:f.random(15)},s=await p(o,a.s,r).then(t=>f.subtle.encrypt({name:r.name||"AES-GCM",iv:new Uint8Array(a.iv)},t,(new f.TextEncoder).encode(i))),u={ct:f.Buffer.from(s,"binary").toString(r.encode||"base64"),iv:a.iv.toString(r.encode||"base64"),s:a.s.toString(r.encode||"base64")};if(r.raw||(u="SEA"+await f.stringify(u)),n)try{n(u)}catch(t){console.log(t)}return u}catch(t){if(console.log(t),c.err=t,c.throw)throw t;return void(n&&n())}}),t.exports=c.encrypt})(w,"./encrypt"),w(function(t){var p=w("./root"),l=w("./shim"),h=w("./settings"),d=w("./aeskey");p.decrypt=p.decrypt||(async(e,n,r,o)=>{try{o=o||{};var t=(n||o).epriv||n;if(!t){if(!p.I)throw"No decryption key.";t=(n=await p.I(null,{what:e,how:"decrypt",why:o.why})).epriv||n}var i=await h.parse(e);try{var a=l.Buffer.from(i.s,o.encode||"base64"),s=l.Buffer.from(i.iv,o.encode||"base64"),u=l.Buffer.from(i.ct,o.encode||"base64"),c=await d(t,a,o).then(t=>l.subtle.decrypt({name:o.name||"AES-GCM",iv:new Uint8Array(s),tagLength:128},t,new Uint8Array(u)))}catch(t){if("utf8"===o.encode)throw"Could not decrypt";if(p.opt.fallback)return o.encode="utf8",p.decrypt(e,n,r,o)}var f=await h.parse(new l.TextDecoder("utf8").decode(c));if(r)try{r(f)}catch(t){console.log(t)}return f}catch(t){if(console.log(t),p.err=t,p.throw)throw t;return void(r&&r())}}),t.exports=p.decrypt})(w,"./decrypt"),w(function(t){var l=w("./root"),h=w("./shim");w("./settings");l.secret=l.secret||(async(t,e,n,r)=>{try{if(r=r||{},!e||!e.epriv||!e.epub){if(!l.I)throw"No secret mix";e=await l.I(null,{what:t,how:"secret",why:r.why})}var o=t.epub||t,i=e.epub,a=e.epriv,s=h.ossl||h.subtle,u=d(o),c=Object.assign({public:await s.importKey(...u,!0,[])},{name:"ECDH",namedCurve:"P-256"}),f=d(i,a),p=await s.importKey(...f,!1,["deriveBits"]).then(async t=>{t=await s.deriveBits(c,t,256),t=new Uint8Array(t),t=await s.importKey("raw",t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return s.exportKey("jwk",t).then(({k:t})=>t)});if(n)try{n(p)}catch(t){console.log(t)}return p}catch(t){if(console.log(t),l.err=t,l.throw)throw t;return void(n&&n())}});var d=(t,e)=>{var[n,t]=t.split(".");return["jwk",Object.assign(e?{d:e}:{},{x:n,y:t,kty:"EC",crv:"P-256",ext:!0}),{name:"ECDH",namedCurve:"P-256"}]};t.exports=l.secret})(w,"./secret"),w(function(t){var h=w("./root");h.certify=h.certify||(async(t,e={},n,r,o={})=>{try{if(!(t=(()=>{var e=[];if(t){if(("string"==typeof t||Array.isArray(t))&&-1<t.indexOf("*"))return"*";if("string"==typeof t)return t;if(Array.isArray(t)){if(1===t.length&&t[0])return"object"==typeof t[0]&&t[0].pub?t[0].pub:"string"==typeof t[0]?t[0]:null;t.map(t=>{"string"==typeof t?e.push(t):"object"==typeof t&&t.pub&&e.push(t.pub)})}return"object"==typeof t&&t.pub?t.pub:0<e.length?e:null}})()))return console.log("No certificant found");var i=!o.expiry||"number"!=typeof o.expiry&&"string"!=typeof o.expiry?null:parseFloat(o.expiry),a=(e||{}).read?e.read:null,s=(e||{}).write?e.write:"string"==typeof e||Array.isArray(e)||e["+"]||e["#"]||e["."]||e["="]||e["*"]||e[">"]||e["<"]?e:null,u=(o||{}).block||(o||{}).blacklist||(o||{}).ban||{},c=u.read&&("string"==typeof u.read||(u.read||{})["#"])?u.read:null,f="string"==typeof u?u:u.write&&("string"==typeof u.write||u.write["#"])?u.write:null;if(!a&&!s)return console.log("No policy found");var p=JSON.stringify({c:t,...i?{e:i}:{},...a?{r:a}:{},...s?{w:s}:{},...c?{rb:c}:{},...f?{wb:f}:{}}),l=await h.sign(p,n,null,{raw:1});if(o.raw||(l="SEA"+JSON.stringify(l)),r)try{r(l)}catch(t){console.log(t)}return l}catch(t){if(h.err=t,h.throw)throw t;return void(r&&r())}}),t.exports=h.certify})(w,"./certify"),w(function(t){var i=w("./shim"),e=w("./root");e.work=w("./work"),e.sign=w("./sign"),e.verify=w("./verify"),e.encrypt=w("./encrypt"),e.decrypt=w("./decrypt"),e.certify=w("./certify"),e.random=e.random||i.random,e.Buffer=e.Buffer||w("./buffer"),e.keyid=e.keyid||(async t=>{try{var e=i.Buffer.concat(t.replace(/-/g,"+").replace(/_/g,"/").split(".").map(t=>i.Buffer.from(t,"base64"))),n=i.Buffer.concat([i.Buffer.from([153,e.length/256,e.length%256]),e]),r=await sha1hash(n);const o=i.Buffer.from(r,"binary");return o.toString("hex",o.length-8)}catch(t){throw console.log(t),t}}),((e.window||{}).Database||{}).Encryption=e,t.exports=e})(w,"./encryption"),w(function(t){var e,n=w("./encryption");function i(t){this._={$:this}}function r(){}function a(){return e.state().toString(36).replace(".","")}e=n.window?n.window.Database||{chain:{}}:w((void 0+""==typeof s?".":"")+"./database",1),n.Database=e,(i.prototype=(r.prototype=e.chain,new r)).constructor=i,e.chain.user=function(t){var e,r=this.back(-1);if(t)return t=n.opt.pub((t._||"")["#"])||t,r.get("~"+t);if(e=r.back("user"))return e;var t=r=r._,o=t.opt.uuid||a;return(t=(e=t.user=this.chain(new i))._).opt={},t.opt.uuid=function(t){var e=o(),n=r.user;return(n=n&&n.is)&&(n=n.pub)&&(e="~"+n+"/"+e,t&&t.call&&t(null,e)),e},e},(e.User=i).Database=e,i.Encryption=e.Encryption=n,t.exports=i})(w,"./user"),w(function(t){(""+void 0!=typeof window?window.Database||{chain:{}}:w((""+void 0==typeof s?".":"")+"./database",1)).chain.then=function(t,n){var r=this,e=new Promise(function(t,e){r.once(t,n)});return t?e.then(t):e}})(w,"./then"),w(function(t){var e=w("./user"),p=e.Encryption,l=e.Database,h=function(){};e.prototype.create=function(...t){var e,o="object"==typeof t[0]&&(t[0].pub||t[0].epub)?t[0]:"object"==typeof t[1]&&(t[1].pub||t[1].epub)?t[1]:null,i=o&&(o.pub||o.epub)?o.pub:"string"==typeof t[0]?t[0]:null,a=o&&(o.pub||o.epub)?o:i&&"string"==typeof t[1]?t[1]:null,s=t.filter(t=>"function"==typeof t)[0]||null,n=t&&1<t.length&&"object"==typeof t[t.length-1]?t[t.length-1]:{},u=this,c=u._,r=u.back(-1),s=s||h,n=n||{};if(!1!==n.check&&(i||(e="No user."),e=(a||"").length<8?"Password too short":e))return s({err:l.log(e)}),u;if(c.ing)return(s||h)({err:l.log("User is already being created or authenticated"),wait:!0}),u;c.ing=!0;var f={a:function(t){if((f.pubs=t)&&!n.already){t={err:l.log("User already created")};return c.ing=!1,(s||h)(t),void u.leave()}f.salt=String.random(64),p.work(a,f.salt,f.b)},b:function(t){f.proof=t,o?f.c(o):p.pair(f.c)},c:function(t){var e;f.pair=t||{},(e=c.root.user)&&(e._.encryption=t,e.is={pub:t.pub,epub:t.epub,alias:i}),f.data={pub:t.pub},f.d()},d:function(){f.data.alias=i,f.e()},e:function(){f.data.epub=f.pair.epub,p.encrypt({priv:f.pair.priv,epriv:f.pair.epriv},f.proof,f.f,{raw:1})},f:function(t){f.data.auth=JSON.stringify({ek:t,s:f.salt}),f.g(f.data.auth)},g:function(t){var e;f.data.auth=f.data.auth||t,r.get(e="~"+f.pair.pub).put(f.data).on(f.h);t={};t[e]={"#":e},r.get("~@"+i).put(t).get(e).on(f.i)},h:function(t,e,n,r){r.off(),f.h.ok=1,f.i()},i:function(t,e,n,r){r&&(f.i.ok=1,r.off()),f.h.ok&&f.i.ok&&(c.ing=!1,s({ok:0,pub:f.pair.pub}),h===s&&(o?u.auth(o):u.auth(i,a)))}};return r.get("~@"+i).once(f.a),u},e.prototype.leave=function(t,e){var n=this.back(-1)._.user;if(n&&(delete n.is,delete n._.is,delete n._.encryption),p.window)try{var r={};delete(r=window.sessionStorage).recall,delete r.pair}catch(t){}return this}})(w,"./create"),w(function(t){var e=w("./user"),d=e.Encryption,n=e.Database,y=function(){};function g(e){if("string"!=typeof e)return e;try{e=JSON.parse(e)}catch(t){e={}}return e}e.prototype.auth=function(...t){var e="object"==typeof t[0]&&(t[0].pub||t[0].epub)?t[0]:"object"==typeof t[1]&&(t[1].pub||t[1].epub)?t[1]:null,i=e||"string"!=typeof t[0]?null:t[0],a=!i&&(!e||e.priv&&e.epriv)||"string"!=typeof t[1]?null:t[1],s=t.filter(t=>"function"==typeof t)[0]||null,u=t&&1<t.length&&"object"==typeof t[t.length-1]?t[t.length-1]:{},c=this,f=c._,p=c.back(-1);if(f.ing)return(s||y)({err:n.log("User is already being created or authenticated"),wait:!0}),c;f.ing=!0;var l,h={a:function(e){if(!e)return h.b();if(!e.pub){var n=[];return Object.keys(e).forEach(function(t){"_"!=t&&n.push(e[t])}),h.b(n)}if(h.name)return h.f(e);h.c((h.data=e).auth)},b:function(t){t=(h.list=(h.list||[]).concat(t||[])).shift();if(l===t)return h.name?h.err("User account is not published for dApps to access"):h.err("Wrong user or password");p.get(t).once(h.a)},c:function(t){return l===t?h.b():"string"==typeof t?h.c(g(t)):void d.work(a,(h.auth=t).s,h.d,h.enc)},d:function(t){d.decrypt(h.auth.ek,t,h.e,h.enc)},e:function(t){if(l===t)return h.enc?(h.enc=null,h.b()):(h.enc={encode:"utf8"},h.c(h.auth));h.half=t,h.f(h.data)},f:function(t){var e=h.half||{},n=h.data||{};h.g(h.lol={pub:t.pub||n.pub,epub:t.epub||n.epub,priv:t.priv||e.priv,epriv:t.epriv||e.epriv})},g:function(t){if(!t||!t.pub||!t.epub)return h.b();h.pair=t;var e=p._.user,n=e._,r=(n.tag,n.opt);(n=e._=p.get("~"+t.pub)._).opt=r,e.is={pub:t.pub,epub:t.epub,alias:i||t.pub},n.encryption=h.pair,f.ing=!1;try{a&&l==(g(f.root.graph["~"+t.pub].auth)||"")[":"]&&(u.shuffle=u.change=a)}catch(t){}if(u.change?h.z():(s||y)(n),d.window&&(c.back("user")._.opt||u).remember)try{var o={};(o=window.sessionStorage).recall=!0,o.pair=JSON.stringify(t)}catch(t){}try{p._.tag.auth?p._.on("auth",n):setTimeout(function(){p._.on("auth",n)},1)}catch(t){}},h:function(t){return t?(i=(i=t.alias)||(t.alias="~"+e.pub),t.auth?(e=null,void h.c((h.data=t).auth)):h.g(e)):h.b()},z:function(){h.salt=String.random(64),d.work(u.change,h.salt,h.y)},y:function(t){d.encrypt({priv:h.pair.priv,epriv:h.pair.epriv},t,h.x,{raw:1})},x:function(t){h.w(JSON.stringify({ek:t,s:h.salt}))},w:function(t){var e;u.shuffle&&(e={},Object.keys(h.data).forEach(function(t){e[t]=h.data[t]}),delete e._,e.auth=t,p.get("~"+h.pair.pub).put(e)),p.get("~"+h.pair.pub).get("auth").put(t,s||y)},err:function(t){t={err:n.log(t||"User cannot be found")};f.ing=!1,(s||y)(t)},plugin:function(t){if(!(h.name=t))return h.err();var e=[t];"~"!==t[0]&&(e[1]="~"+t,e[2]="~@"+t),h.b(e)}};return e?e.priv&&e.epriv?h.g(e):p.get("~"+e.pub).once(h.h):i?p.get("~@"+i).once(h.a):a||d.name(h.plugin),c}})(w,"./auth"),w(function(t){var e=w("./user"),o=e.Encryption;e.Database;e.prototype.recall=function(t,e){var n=this.back(-1);if((t=t||{})&&t.sessionStorage){if(o.window)try{var r={};(r=window.sessionStorage)&&(n._.opt.remember=!0,(this.back("user")._.opt||t).remember=!0,(r.recall||r.pair)&&n.user().auth(JSON.parse(r.pair),e))}catch(t){}return this}return this}})(w,"./recall"),w(function(t){var e=w("./user"),c=e.Encryption,n=e.Database;e.prototype.pair=function(){var t,r=this;try{t=new Proxy({DANGER:""},{get:function(t,e,n){if(r.is&&(r._||"").encryption)return r._.encryption[e]}})}catch(t){}return t},e.prototype.delete=async function(t,e,n){this.back(-1);var r=this.back("user");try{r.auth(t,e,function(t){(r.is||{}).pub;r.map().once(function(){this.put(null)}),r.leave(),(n||function(){})({ok:0})})}catch(t){}return this},e.prototype.alive=async function(){var e=this.back(-1);try{return await authRecall(e),e._.user._}catch(t){e="No session!";throw n.log(e),{err:e}}},e.prototype.trust=async function(t){n.is(t)&&t.get("pub").get((t,e)=>{console.log(t,e)}),t.get("trust").get(path).put(theirPubkey)},e.prototype.grant=function(o,i){var a=this.back(-1).user(),s=a._.encryption,u="";return this.back(function(t){t.is||(u+=t.get||"")}),async function(){var t=await a.get("grant").get(s.pub).get(u).then();(t=await c.decrypt(t,s))||(t=c.random(16).toString(),r=await c.encrypt(t,s),a.get("grant").get(s.pub).get(u).put(r));var e=o.get("pub").then(),n=o.get("epub").then(),e=await e,n=await n,n=await c.secret(n,s),r=await c.encrypt(t,n);a.get("grant").get(e).get(u).put(r,i)}(),this},e.prototype.secret=function(n,r){var o=this,i=o.back(-1).user(),a=i.pair(),s="";return o.back(function(t){t.is||(s+=t.get||"")}),async function(){var t,e=await i.get("trust").get(a.pub).get(s).then();(e=await c.decrypt(e,a))||(e=c.random(16).toString(),t=await c.encrypt(e,a),i.get("trust").get(a.pub).get(s).put(t)),t=await c.encrypt(n,e),o.put(t,r)}(),o},t.exports=e})(w,"./share"),w(function(t){var d,y=w("./encryption"),g=w("./settings"),v=""+d!=typeof window?window.Database||{on:function(){}}:w((""+d==typeof s?".":"")+"./database",1);function p(e){var t,n,r=this,o=r.as,i=e.put,a=i["#"],s=i["."],u=i[":"],c=i[">"],f=e["#"];a&&s&&((e._||"").faith&&(o.opt||"").faith&&"function"==typeof e._?y.opt.pack(i,function(t){y.verify(t,!1,function(t){i["="]=y.opt.unpack(t),r.to.next(e)})}):(n=function(t){o.on("in",{"@":f,err:e.err=t})},(e._||"").DBG&&((e._||"").DBG.c=+new Date),0<=a.indexOf("<?")&&(t=parseFloat(a.split("<?")[1]||""))&&c<v.state()-1e3*t?(t=e._)&&t.stun&&t.stun--:"~@"!==a?"~@"!==a.slice(0,2)?(t=y.opt.pub(a))?p.pub(r,e,u,s,a,o,n,o.user||"",t):0<=a.indexOf("#")?p.hash(r,e,u,s,a,o,n):p.any(r,e,u,s,a,o,n,o.user||""):p.pubs(r,e,u,s,a,o,n):p.alias(r,e,u,s,a,o,n)))}v.on("opt",function(t){t.encryption||(t.encryption={own:{}},t.on("put",p,t)),this.to.next(t)}),p.hash=function(e,n,t,r,o,i,a){y.work(t,null,function(t){return t&&t===r.split("#").slice(-1)[0]?e.to.next(n):void a("Data hash not same as hash")},{name:"SHA-256"})},p.alias=function(t,e,n,r,o,i,a){return n?"~@"+r===b(n)?t.to.next(e):void a("Alias not same"):a("Data must exist")},p.pubs=function(t,e,n,r,o,i,a){return n?r===b(n)?t.to.next(e):void a("Alias not same"):a("Alias must exist")},p.pub=async function(a,s,n,u,c,r,f,o,p){var i;const l=await g.parse(n)||{},h=(t,o,i)=>{if(t.m&&t.s&&o&&p)return y.verify(t,p,e=>{if(d!==e&&d!==e.e&&s.put[">"]&&s.put[">"]>parseFloat(e.e))return f("Certificate expired.");if(d!==e&&e.c&&e.w&&(e.c===o||-1<e.c.indexOf("*"))){let t=-1<c.indexOf("/")?c.replace(c.substring(0,c.indexOf("/")+1),""):"";String.match=String.match||v.text.match;for(const r of Array.isArray(e.w)?e.w:"object"==typeof e.w||"string"==typeof e.w?[e.w]:[])if(String.match(t,r["#"])&&String.match(u,r["."])||!r["."]&&String.match(t,r["#"])||!r["#"]&&String.match(u,r["."])||String.match(t?t+"/"+u:u,r["#"]||r)){if(r["+"]&&-1<r["+"].indexOf("*")&&t&&-1==t.indexOf(o)&&-1==u.indexOf(o))return f(`Path "${t}" or key "${u}" must contain string "${o}"`);if(!e.wb||"string"!=typeof e.wb&&!(e.wb||{})["#"])return i(e);var n=a.as.root.$.back(-1);return(n="string"==typeof e.wb&&"~"!==e.wb.slice(0,1)?n.get("~"+p):n).get(e.wb).get(o).once(t=>!t||1!==t&&!0!==t?i(e):f(`Certificant ${o} blocked`))}return f("Certificate verification fail.")}})};if("pub"===u&&"~"+p===c)return n===p?a.to.next(s):f("Account not same");(i=o.is)&&i.pub&&!l["*"]&&!l["+"]&&(p===i.pub||p!==i.pub&&((s._.msg||{}).opt||{}).cert)?y.opt.pack(s.put,t=>{y.sign(t,o._.encryption,async function(t){if(d===t)return f(y.err||"Signature fail");if(s.put[":"]={":":i=y.opt.unpack(t.m),"~":t.s},s.put["="]=i,p===o.is.pub)return(i=b(n))&&((r.encryption.own[i]=r.encryption.own[i]||{})[p]=1),void JSON.stringifyAsync(s.put[":"],function(t,e){return t?f(t||"Stringify error"):(s.put[":"]=e,a.to.next(s))});if(p!==o.is.pub&&((s._.msg||{}).opt||{}).cert){const e=await g.parse(s._.msg.opt.cert);e&&e.m&&e.s&&h(e,o.is.pub,t=>{s.put[":"]["+"]=e,s.put[":"]["*"]=o.is.pub,JSON.stringifyAsync(s.put[":"],function(t,e){return t?f(t||"Stringify error"):(s.put[":"]=e,a.to.next(s))})})}},{raw:1})}):y.opt.pack(s.put,t=>{y.verify(t,l["*"]||p,function(e){var t;return e=y.opt.unpack(e),d===e?f("Unverified data"):((t=b(e))&&p===y.opt.pub(t)&&((r.encryption.own[t]=r.encryption.own[t]||{})[p]=1),l["+"]&&l["+"].m&&l["+"].s&&l["*"]?void h(l["+"],l["*"],t=>(s.put["="]=e,a.to.next(s))):(s.put["="]=e,a.to.next(s)))})})},p.any=function(e,t,n,r,o,i,a,s){if(i.opt.secure)return a("Soul missing public key at '"+r+"'");i.on("secure",function(t){return this.off(),i.opt.secure?void a("Data cannot be changed"):e.to.next(t)}).on.on("secure",t)};var n=v.valid,b=function(t,e){return"string"==typeof(e=n(t))&&e},e=((v.state||"").ify,/[^\w_-]/);y.opt.pub=function(t){if((t=t&&((t=t.split("~"))&&t[1]))&&(t=t.split(e).slice(0,2))&&2==t.length&&"@"!==(t[0]||"")[0])return t=t.slice(0,2).join(".")},y.opt.stringy=function(t){},y.opt.pack=function(r,o,i,a,s){var t,e;if(y.opt.check(r))return o(r);r&&r["#"]&&r["."]&&r[">"]&&(t=r[":"],e=1),JSON.parseAsync(e?t:r,function(t,e){var n=d!==(e||"")[":"]&&(e||"")["~"];o(n?{m:{"#":s||r["#"],".":i||r["."],":":(e||"")[":"],">":r[">"]||v.state.is(a,i)},s:n}:r)})};var o=y.opt;y.opt.unpack=function(t,e,n){if(d!==t){if(t&&d!==(r=t[":"]))return r;if(e=e||o.fall_key,!n&&o.fall_val&&((n={})[e]=o.fall_val),e&&n){if(t===n[e])return t;if(!y.opt.check(n[e]))return t;var r=n&&n._&&n._["#"]||o.fall_soul,n=v.state.is(n,e)||o.fall_state;return t&&4===t.length&&r===t[0]&&e===t[1]&&i(n)===i(t[3])?t[2]:n<y.opt.shuffle_attack?t:void 0}}},y.opt.shuffle_attack=15463296e5;var i=Math.floor})(w,"./index")}();