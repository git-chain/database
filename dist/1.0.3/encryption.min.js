!function(){function v(r,t){return t?require(r):r.slice?v[n(r)]:function(t,e){r(t={exports:{}}),v[n(e)]=t.exports};function n(t){return t.split("/").slice(-1).toString().replace(".js","")}}var c;"undefined"!=typeof module&&(c=module),v(function(t){"undefined"!=typeof window&&(t.window=window);var e=(t.window||t).Encryption||{};(e.window=t.window)&&(e.window.Encryption=e);try{void 0+""!=typeof c&&(c.exports=e)}catch(t){}t.exports=e})(v,"./root"),v(function(t){var e=v("./root");try{e.window&&location.protocol.indexOf("s")<0&&location.host.indexOf("localhost")<0&&!/^127\.\d+\.\d+\.\d+$/.test(location.hostname)&&location.protocol.indexOf("file:")<0&&(location.protocol="https:")}catch(t){}})(v,"./https"),v(function(t){var e;if(e+""==typeof btoa){if(e+""==typeof Buffer)try{global.Buffer=v("buffer",1).Buffer}catch(t){}global.btoa=function(t){return Buffer.from(t,"binary").toString("base64")},global.atob=function(t){return Buffer.from(t,"base64").toString("binary")}}})(v,"./base64"),v(function(t){function e(){}v("./base64"),Object.assign(e,{from:Array.from}),(e.prototype=Object.create(Array.prototype)).toString=function(t,r,e){r=r||0;var n=this.length;if("hex"!==(t=t||"utf8"))return"utf8"===t?Array.from({length:(e||n)-r},(t,e)=>String.fromCharCode(this[e+r])).join(""):"base64"===t?btoa(this):void 0;{const o=new Uint8Array(this);return[...Array((e&&e+1||n)-r).keys()].map(t=>o[t+r].toString(16).padStart(2,"0")).join("")}},t.exports=e})(v,"./array"),v(function(t){v("./base64");var s=v("./array");function e(...t){return e.from(...t)}e.prototype=Object.create(Array.prototype),Object.assign(e,{from(){if(!Object.keys(arguments).length||null==arguments[0])throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.");const r=arguments[0];let t;if("string"==typeof r){var e=arguments[1]||"utf8";if("hex"===e){var n=r.match(/([\da-fA-F]{2})/g).map(t=>parseInt(t,16));if(!n||!n.length)throw new TypeError("Invalid first argument for type 'hex'.");t=s.from(n)}else if("utf8"===e||"binary"===e){const o=r.length,a=new Uint16Array(o);Array.from({length:o},(t,e)=>a[e]=r.charCodeAt(e)),t=s.from(a)}else if("base64"===e){const i=atob(r),o=i.length,c=new Uint8Array(o);Array.from({length:o},(t,e)=>c[e]=i.charCodeAt(e)),t=s.from(c)}else"binary"===e?t=s.from(r):console.info("Unknown encoding: "+e);return t}r.byteLength;const o=r.byteLength||r.length;if(o){let t;return r instanceof ArrayBuffer&&(t=new Uint8Array(r)),s.from(t||r)}},alloc(t,e=0){return s.from(new Uint8Array(Array.from({length:t},()=>e)))},allocUnsafe(t){return s.from(new Uint8Array(Array.from({length:t})))},concat(t){if(Array.isArray(t))return s.from(t.reduce((t,e)=>t.concat(Array.from(e)),[]));throw new TypeError("First argument must be Array containing ArrayBuffer or Uint8Array instances.")}}),e.prototype.from=e.from,e.prototype.toString=s.prototype.toString,t.exports=e})(v,"./buffer"),v(function(t){var e=v("./root");const r={Buffer:v("./buffer")};var n={};if(JSON.parseAsync=JSON.parseAsync||function(t,e,r){try{e(void 0,JSON.parse(t,r))}catch(t){e(t)}},JSON.stringifyAsync=JSON.stringifyAsync||function(t,e,r,n){try{e(void 0,JSON.stringify(t,r,n))}catch(t){e(t)}},r.parse=function(t,e){return new Promise(function(r,n){JSON.parseAsync(t,function(t,e){t?n(t):r(e)},e)})},r.stringify=function(t,e,o){return new Promise(function(r,n){JSON.stringifyAsync(t,function(t,e){t?n(t):r(e)},e,o)})},e.window&&(r.crypto=window.crypto||window.msCrypto,r.subtle=(r.crypto||n).subtle||(r.crypto||n).webkitSubtle,r.TextEncoder=window.TextEncoder,r.TextDecoder=window.TextDecoder,r.random=t=>r.Buffer.from(r.crypto.getRandomValues(new Uint8Array(r.Buffer.alloc(t))))),r.TextDecoder||({TextEncoder:e,TextDecoder:n}=v((void 0+""==typeof c?".":"")+"./lib/text-encoding",1),r.TextDecoder=n,r.TextEncoder=e),!r.crypto)try{var o=v("crypto",1);Object.assign(r,{crypto:o,random:t=>r.Buffer.from(o.randomBytes(t))});const a=v("@peculiar/webcrypto",1)["Crypto"];r.ossl=r.subtle=new a({directory:"ossl"}).subtle}catch(t){}t.exports=r})(v,"./shim"),v(function(t){var e=v("./root"),r=v("./shim"),n={pbkdf2:{hash:{name:"SHA-256"},iter:1e5,ks:64},ecdsa:{pair:{name:"ECDSA",namedCurve:"P-256"},sign:{name:"ECDSA",hash:{name:"SHA-256"}}},ecdh:{name:"ECDH",namedCurve:"P-256"},jwk:function(t,e){t={kty:"EC",crv:"P-256",x:(t=t.split("."))[0],y:t[1],ext:!0};return t.key_ops=e?["sign"]:["verify"],e&&(t.d=e),t},keyToJwk:function(t){const e=t.toString("base64");return{kty:"oct",k:e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,""),ext:!1,alg:"A256GCM"}},recall:{validity:43200,hook:function(t){return t}},check:function(t){return"string"==typeof t&&"SEA{"===t.slice(0,4)},parse:async function(t){try{var e="string"==typeof t;return e&&"SEA{"===t.slice(0,4)&&(t=t.slice(3)),e?await r.parse(t):t}catch(t){}return t}};e.opt=n,t.exports=n})(v,"./settings"),v(function(t){var r=v("./shim");t.exports=async function(t,e){t="string"==typeof t?t:await r.stringify(t),e=await r.subtle.digest({name:e||"SHA-256"},(new r.TextEncoder).encode(t));return r.Buffer.from(e)}})(v,"./sha256"),v(function(t){var e=v("./shim"),r=e.subtle;const n=e.ossl||r;t.exports=t=>n.digest({name:"SHA-1"},new ArrayBuffer(t))})(v,"./sha1"),v(function(t){var u=v("./root"),f=v("./shim"),p=v("./settings"),y=v("./sha256");u.work=u.work||(async(t,e,r,n)=>{try{var o=(e||{}).epub||e;if(n=n||{},o instanceof Function&&(r=o,o=void 0),t="string"==typeof t?t:await f.stringify(t),"sha"===(n.name||"").toLowerCase().slice(0,3)){var a=f.Buffer.from(await y(t,n.name),"binary").toString(n.encode||"base64");if(r)try{r(a)}catch(t){console.log(t)}return a}var o=o||f.random(9),i=await(f.ossl||f.subtle).importKey("raw",(new f.TextEncoder).encode(t),{name:n.name||"PBKDF2"},!1,["deriveBits"]),c=await(f.ossl||f.subtle).deriveBits({name:n.name||"PBKDF2",iterations:n.iterations||p.pbkdf2.iter,salt:(new f.TextEncoder).encode(n.salt||o),hash:n.hash||p.pbkdf2.hash},i,n.length||8*p.pbkdf2.ks),s=(t=f.random(t.length),f.Buffer.from(c,"binary").toString(n.encode||"base64"));if(r)try{r(s)}catch(t){console.log(t)}return s}catch(t){if(console.log(t),u.err=t,u.throw)throw t;return void(r&&r())}}),t.exports=u.work})(v,"./work"),v(function(t){var i=v("./root"),c=v("./shim");v("./settings");i.name=i.name||(async(e,t)=>{try{if(e)try{e()}catch(t){console.log(t)}return}catch(t){if(console.log(t),i.err=t,i.throw)throw t;return void(e&&e())}}),i.pair=i.pair||(async(e,t)=>{try{var r=c.ossl||c.subtle,n=await c.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]).then(async t=>{var e={},t=(e.priv=(await c.subtle.exportKey("jwk",t.privateKey)).d,await c.subtle.exportKey("jwk",t.publicKey));return e.pub=t.x+"."+t.y,e});try{var o=await r.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey"]).then(async t=>{var e={},t=(e.epriv=(await r.exportKey("jwk",t.privateKey)).d,await r.exportKey("jwk",t.publicKey));return e.epub=t.x+"."+t.y,e})}catch(t){if(i.window)throw t;if("Error: ECDH is not a supported algorithm"!=t)throw t;console.log("Ignoring ECDH...")}var o=o||{},a={pub:n.pub,priv:n.priv,epub:o.epub,epriv:o.epriv};if(e)try{e(a)}catch(t){console.log(t)}return a}catch(t){if(console.log(t),i.err=t,i.throw)throw t;return void(e&&e())}}),t.exports=i.pair})(v,"./pair"),v(function(t){var y=v("./root"),l=v("./shim"),h=v("./settings"),w=v("./sha256");y.sign=y.sign||(async(t,e,r,n)=>{try{if(n=n||{},!(e||n).priv){if(!y.I)throw"No signing key";e=await y.I(null,{what:t,how:"sign",why:n.why})}if(void 0===t)throw"`undefined` not allowed";var o=await h.parse(t),a=n.check=n.check||o;if(y.verify&&(y.opt.check(a)||a&&a.s&&a.m)&&void 0!==await y.verify(a,e)){var i=await h.parse(a);if(n.raw||(i="SEA"+await l.stringify(i)),r)try{r(i)}catch(t){console.log(t)}}else{var c=e.pub,s=e.priv,u=h.jwk(c,s),f=await w(o),p=await(l.ossl||l.subtle).importKey("jwk",u,{name:"ECDSA",namedCurve:"P-256"},!1,["sign"]).then(t=>(l.ossl||l.subtle).sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new Uint8Array(f))),i={m:o,s:l.Buffer.from(p,"binary").toString(n.encode||"base64")};if(n.raw||(i="SEA"+await l.stringify(i)),r)try{r(i)}catch(t){console.log(t)}}return i}catch(t){if(console.log(t),y.err=t,y.throw)throw t;return void(r&&r())}}),t.exports=y.sign})(v,"./sign"),v(function(t){var l=v("./root"),h=v("./shim"),w=v("./settings"),g=v("./sha256"),r=(l.verify=l.verify||(async(e,r,n,o)=>{try{var t=await w.parse(e);if(!1===r){var a=await w.parse(t.m);if(n)try{n(a)}catch(t){console.log(t)}return a}o=o||{};var i,c,s,u=r.pub||r,f=l.opt.slow_leak?await l.opt.slow_leak(u):await(h.ossl||h.subtle).importKey("jwk",w.jwk(u),{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),p=await g(t.m);try{if(i=h.Buffer.from(t.s,o.encode||"base64"),c=new Uint8Array(i),!(s=await(h.ossl||h.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},f,c,new Uint8Array(p))))throw"Signature did not match"}catch(t){if(l.opt.fallback)return await l.opt.fall_verify(e,r,n,o)}var y=s?await w.parse(t.m):void 0;if(n)try{n(y)}catch(t){console.log(t)}return y}catch(t){if(console.log(t),l.err=t,l.throw)throw t;return void(n&&n())}}),t.exports=l.verify,{}),f=(l.opt.slow_leak=t=>{var e;return r[t]||(e=w.jwk(t),r[t]=(h.ossl||h.subtle).importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])),r[t]},l.opt);l.opt.fall_verify=async function(t,e,r,n,o){if(o===l.opt.fallback)throw"Signature did not match";o=o||1;var a,i,c,s=t||"",u=(t=l.opt.unpack(t)||t,await w.parse(t)),e=e.pub||e,e=await l.opt.slow_leak(e),o=o<=l.opt.fallback?h.Buffer.from(await h.subtle.digest({name:"SHA-256"},(new h.TextEncoder).encode(await w.parse(u.m)))):await g(u.m);try{if(a=h.Buffer.from(u.s,n.encode||"base64"),i=new Uint8Array(a),!(c=await(h.ossl||h.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},e,i,new Uint8Array(o))))throw"Signature did not match"}catch(t){try{a=h.Buffer.from(u.s,"utf8"),i=new Uint8Array(a),c=await(h.ossl||h.subtle).verify({name:"ECDSA",hash:{name:"SHA-256"}},e,i,new Uint8Array(o))}catch(t){if(!c)throw"Signature did not match"}}n=c?await w.parse(u.m):void 0;if(f.fall_soul=s["#"],f.fall_key=s["."],f.fall_val=t,f.fall_state=s[">"],r)try{r(n)}catch(t){console.log(t)}return n},l.opt.fallback=2})(v,"./verify"),v(function(t){var n=v("./shim"),o=v("./settings"),a=v("./sha256");t.exports=async(t,e,r)=>{t+=(e||n.random(8)).toString("utf8"),e=n.Buffer.from(await a(t),"binary"),t=o.keyToJwk(e);return n.subtle.importKey("jwk",t,{name:"AES-GCM"},!1,["encrypt","decrypt"])}})(v,"./aeskey"),v(function(t){var u=v("./root"),f=v("./shim"),p=(v("./settings"),v("./aeskey"));u.encrypt=u.encrypt||(async(t,e,r,n)=>{try{n=n||{};var o=(e||n).epriv||e;if(void 0===t)throw"`undefined` not allowed";if(!o){if(!u.I)throw"No encryption key";o=(e=await u.I(null,{what:t,how:"encrypt",why:n.why})).epriv||e}var a="string"==typeof t?t:await f.stringify(t),i={s:f.random(9),iv:f.random(15)},c=await p(o,i.s,n).then(t=>f.subtle.encrypt({name:n.name||"AES-GCM",iv:new Uint8Array(i.iv)},t,(new f.TextEncoder).encode(a))),s={ct:f.Buffer.from(c,"binary").toString(n.encode||"base64"),iv:i.iv.toString(n.encode||"base64"),s:i.s.toString(n.encode||"base64")};if(n.raw||(s="SEA"+await f.stringify(s)),r)try{r(s)}catch(t){console.log(t)}return s}catch(t){if(console.log(t),u.err=t,u.throw)throw t;return void(r&&r())}}),t.exports=u.encrypt})(v,"./encrypt"),v(function(t){var p=v("./root"),y=v("./shim"),l=v("./settings"),h=v("./aeskey");p.decrypt=p.decrypt||(async(e,r,n,o)=>{try{o=o||{};var t=(r||o).epriv||r;if(!t){if(!p.I)throw"No decryption key.";t=(r=await p.I(null,{what:e,how:"decrypt",why:o.why})).epriv||r}var a=await l.parse(e);try{var i=y.Buffer.from(a.s,o.encode||"base64"),c=y.Buffer.from(a.iv,o.encode||"base64"),s=y.Buffer.from(a.ct,o.encode||"base64"),u=await h(t,i,o).then(t=>y.subtle.decrypt({name:o.name||"AES-GCM",iv:new Uint8Array(c),tagLength:128},t,new Uint8Array(s)))}catch(t){if("utf8"===o.encode)throw"Could not decrypt";if(p.opt.fallback)return o.encode="utf8",await p.decrypt(e,r,n,o)}var f=await l.parse(new y.TextDecoder("utf8").decode(u));if(n)try{n(f)}catch(t){console.log(t)}return f}catch(t){if(console.log(t),p.err=t,p.throw)throw t;return void(n&&n())}}),t.exports=p.decrypt})(v,"./decrypt"),v(function(t){var y=v("./root"),l=v("./shim"),h=(v("./settings"),y.secret=y.secret||(async(t,e,r,n)=>{try{if(n=n||{},!e||!e.epriv||!e.epub){if(!y.I)throw"No secret mix";e=await y.I(null,{what:t,how:"secret",why:n.why})}var o=t.epub||t,a=e.epub,i=e.epriv,c=l.ossl||l.subtle,s=h(o),u=Object.assign({public:await c.importKey(...s,!0,[])},{name:"ECDH",namedCurve:"P-256"}),f=h(a,i),p=await c.importKey(...f,!1,["deriveBits"]).then(async t=>{t=await c.deriveBits(u,t,256),t=new Uint8Array(t),t=await c.importKey("raw",t,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]);return c.exportKey("jwk",t).then(({k:t})=>t)});if(r)try{r(p)}catch(t){console.log(t)}return p}catch(t){if(console.log(t),y.err=t,y.throw)throw t;return void(r&&r())}}),(t,e)=>{var[t,r]=t.split(".");return["jwk",Object.assign(e?{d:e}:{},{x:t,y:r,kty:"EC",crv:"P-256",ext:!0}),{name:"ECDH",namedCurve:"P-256"}]});t.exports=y.secret})(v,"./secret"),v(function(t){var l=v("./root");l.certify=l.certify||(async(t,e={},r,n,o={})=>{try{if(!(t=(()=>{var e=[];if(t){if(("string"==typeof t||Array.isArray(t))&&-1<t.indexOf("*"))return"*";if("string"==typeof t)return t;if(Array.isArray(t)){if(1===t.length&&t[0])return"object"==typeof t[0]&&t[0].pub?t[0].pub:"string"==typeof t[0]?t[0]:null;t.map(t=>{"string"==typeof t?e.push(t):"object"==typeof t&&t.pub&&e.push(t.pub)})}return"object"==typeof t&&t.pub?t.pub:0<e.length?e:null}})()))return console.log("No certificant found");var a=!o.expiry||"number"!=typeof o.expiry&&"string"!=typeof o.expiry?null:parseFloat(o.expiry),i=(e||{}).read?e.read:null,c=(e||{}).write?e.write:"string"==typeof e||Array.isArray(e)||e["+"]||e["#"]||e["."]||e["="]||e["*"]||e[">"]||e["<"]?e:null,s=(o||{}).block||(o||{}).blacklist||(o||{}).ban||{},u=s.read&&("string"==typeof s.read||(s.read||{})["#"])?s.read:null,f="string"==typeof s?s:s.write&&("string"==typeof s.write||s.write["#"])?s.write:null;if(!i&&!c)return console.log("No policy found");var p=JSON.stringify({c:t,...a?{e:a}:{},...i?{r:i}:{},...c?{w:c}:{},...u?{rb:u}:{},...f?{wb:f}:{}}),y=await l.sign(p,r,null,{raw:1});if(o.raw||(y="SEA"+JSON.stringify(y)),n)try{n(y)}catch(t){console.log(t)}return y}catch(t){if(l.err=t,l.throw)throw t;return void(n&&n())}}),t.exports=l.certify})(v,"./certify"),v(function(t){var a=v("./shim"),e=v("./root");e.work=v("./work"),e.sign=v("./sign"),e.verify=v("./verify"),e.encrypt=v("./encrypt"),e.decrypt=v("./decrypt"),e.certify=v("./certify"),e.random=e.random||a.random,e.Buffer=e.Buffer||v("./buffer"),e.keyid=e.keyid||(async t=>{try{var e=a.Buffer.concat(t.replace(/-/g,"+").replace(/_/g,"/").split(".").map(t=>a.Buffer.from(t,"base64"))),r=a.Buffer.concat([a.Buffer.from([153,e.length/256,e.length%256]),e]),n=await sha1hash(r);const o=a.Buffer.from(n,"binary");return o.toString("hex",o.length-8)}catch(t){throw console.log(t),t}}),((e.window||{}).Database||{}).Encryption=e,t.exports=e})(v,"./encryption"),v(function(t){var e,r=v("./encryption");function a(t){this._={$:this}}function n(){}function i(){return e.state().toString(36).replace(".","")}e=r.window?r.window.Database||{chain:{}}:v((void 0+""==typeof c?".":"")+"./database",1),r.Database=e,n.prototype=e.chain,(a.prototype=new n).constructor=a,e.chain.user=function(t){var e,n,o=this.back(-1);return t?(t=r.opt.pub((t._||"")["#"])||t,o.get("~"+t)):((t=o.back("user"))||(e=o=o._,n=o.opt.uuid||i,(e=(t=o.user=this.chain(new a))._).opt={},e.opt.uuid=function(t){var e=n(),r=o.user;return(r=r&&r.is)&&(r=r.pub)&&(e="~"+r+"/"+e,t&&t.call&&t(null,e)),e}),t)},(e.User=a).Database=e,a.Encryption=e.Encryption=r,t.exports=a})(v,"./user"),v(function(t){(""+void 0!=typeof window?window.Database||{chain:{}}:v((""+void 0==typeof c?".":"")+"./database",1)).chain.then=function(t,r){var n=this,e=new Promise(function(t,e){n.once(t,r)});return t?e.then(t):e}})(v,"./then"),v(function(t){var e=v("./user"),p=e.Encryption,y=e.Database,l=function(){};e.prototype.create=function(...t){var e,o="object"==typeof t[0]&&(t[0].pub||t[0].epub)?t[0]:"object"==typeof t[1]&&(t[1].pub||t[1].epub)?t[1]:null,a=o&&(o.pub||o.epub)?o.pub:"string"==typeof t[0]?t[0]:null,i=o&&(o.pub||o.epub)?o:a&&"string"==typeof t[1]?t[1]:null,c=t.filter(t=>"function"==typeof t)[0]||null,r=t&&1<t.length&&"object"==typeof t[t.length-1]?t[t.length-1]:{},s=this,u=s._,n=s.back(-1),c=c||l,r=r||{};if(!1!==r.check&&(a||(e="No user."),e=(i||"").length<8?"Password too short":e))return c({err:y.log(e)}),s;if(u.ing)return(c||l)({err:y.log("User is already being created or authenticated"),wait:!0}),s;u.ing=!0;var f={a:function(t){if((f.pubs=t)&&!r.already)return t={err:y.log("User already created")},u.ing=!1,(c||l)(t),void s.leave();f.salt=String.random(64),p.work(i,f.salt,f.b)},b:function(t){f.proof=t,o?f.c(o):p.pair(f.c)},c:function(t){var e;f.pair=t||{},(e=u.root.user)&&(e._.encryption=t,e.is={pub:t.pub,epub:t.epub,alias:a}),f.data={pub:t.pub},f.d()},d:function(){f.data.alias=a,f.e()},e:function(){f.data.epub=f.pair.epub,p.encrypt({priv:f.pair.priv,epriv:f.pair.epriv},f.proof,f.f,{raw:1})},f:function(t){f.data.auth=JSON.stringify({ek:t,s:f.salt}),f.g(f.data.auth)},g:function(t){f.data.auth=f.data.auth||t,n.get(t="~"+f.pair.pub).put(f.data).on(f.h);var e={};e[t]={"#":t},n.get("~@"+a).put(e).get(t).on(f.i)},h:function(t,e,r,n){n.off(),f.h.ok=1,f.i()},i:function(t,e,r,n){n&&(f.i.ok=1,n.off()),f.h.ok&&f.i.ok&&(u.ing=!1,c({ok:0,pub:f.pair.pub}),l===c&&(o?s.auth(o):s.auth(a,i)))}};return n.get("~@"+a).once(f.a),s},e.prototype.leave=function(t,e){var r=this.back(-1)._.user;if(r&&(delete r.is,delete r._.is,delete r._.encryption),p.window)try{var n={};delete(n=window.sessionStorage).recall,delete n.pair}catch(t){}return this}})(v,"./create"),v(function(t){var e=v("./user"),h=e.Encryption,r=e.Database,w=function(){};function g(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}return e}e.prototype.auth=function(...t){var e="object"==typeof t[0]&&(t[0].pub||t[0].epub)?t[0]:"object"==typeof t[1]&&(t[1].pub||t[1].epub)?t[1]:null,a=e||"string"!=typeof t[0]?null:t[0],i=!a&&(!e||e.priv&&e.epriv)||"string"!=typeof t[1]?null:t[1],c=t.filter(t=>"function"==typeof t)[0]||null,s=t&&1<t.length&&"object"==typeof t[t.length-1]?t[t.length-1]:{},u=this,f=u._,p=u.back(-1);if(f.ing)return(c||w)({err:r.log("User is already being created or authenticated"),wait:!0}),u;f.ing=!0;var y,l={a:function(e){return e?e.pub?l.name?l.f(e):void l.c((l.data=e).auth):(r=[],Object.keys(e).forEach(function(t){"_"!=t&&r.push(e[t])}),l.b(r)):l.b();var r},b:function(t){t=(l.list=(l.list||[]).concat(t||[])).shift();if(y===t)return l.name?l.err("User account is not published for dApps to access"):l.err("Wrong user or password");p.get(t).once(l.a)},c:function(t){return y===t?l.b():"string"==typeof t?l.c(g(t)):void h.work(i,(l.auth=t).s,l.d,l.enc)},d:function(t){h.decrypt(l.auth.ek,t,l.e,l.enc)},e:function(t){if(y===t)return l.enc?(l.enc=null,l.b()):(l.enc={encode:"utf8"},l.c(l.auth));l.half=t,l.f(l.data)},f:function(t){var e=l.half||{},r=l.data||{};l.g(l.lol={pub:t.pub||r.pub,epub:t.epub||r.epub,priv:t.priv||e.priv,epriv:t.epriv||e.epriv})},g:function(t){if(!t||!t.pub||!t.epub)return l.b();l.pair=t;var e=p._.user,r=e._,n=(r.tag,r.opt);(r=e._=p.get("~"+t.pub)._).opt=n,e.is={pub:t.pub,epub:t.epub,alias:a||t.pub},r.encryption=l.pair,f.ing=!1;try{i&&y==(g(f.root.graph["~"+t.pub].auth)||"")[":"]&&(s.shuffle=s.change=i)}catch(t){}if(s.change?l.z():(c||w)(r),h.window&&(u.back("user")._.opt||s).remember)try{var o={};(o=window.sessionStorage).recall=!0,o.pair=JSON.stringify(t)}catch(t){}try{p._.tag.auth?p._.on("auth",r):setTimeout(function(){p._.on("auth",r)},1)}catch(t){}},h:function(t){return t?(a=(a=t.alias)||(t.alias="~"+e.pub),t.auth?(e=null,void l.c((l.data=t).auth)):l.g(e)):l.b()},z:function(){l.salt=String.random(64),h.work(s.change,l.salt,l.y)},y:function(t){h.encrypt({priv:l.pair.priv,epriv:l.pair.epriv},t,l.x,{raw:1})},x:function(t){l.w(JSON.stringify({ek:t,s:l.salt}))},w:function(t){var e;s.shuffle&&(e={},Object.keys(l.data).forEach(function(t){e[t]=l.data[t]}),delete e._,e.auth=t,p.get("~"+l.pair.pub).put(e)),p.get("~"+l.pair.pub).get("auth").put(t,c||w)},err:function(t){t={err:r.log(t||"User cannot be found")};f.ing=!1,(c||w)(t)},plugin:function(t){if(!(l.name=t))return l.err();var e=[t];"~"!==t[0]&&(e[1]="~"+t,e[2]="~@"+t),l.b(e)}};return e?e.priv&&e.epriv?l.g(e):p.get("~"+e.pub).once(l.h):a?p.get("~@"+a).once(l.a):i||h.name(l.plugin),u}})(v,"./auth"),v(function(t){var e=v("./user"),o=e.Encryption;e.Database;e.prototype.recall=function(t,e){var r=this.back(-1);if((t=t||{})&&t.sessionStorage&&o.window)try{var n;(n=window.sessionStorage)&&(r._.opt.remember=!0,(this.back("user")._.opt||t).remember=!0,(n.recall||n.pair)&&r.user().auth(JSON.parse(n.pair),e))}catch(t){}return this}})(v,"./recall"),v(function(t){var e=v("./user"),u=e.Encryption,r=e.Database;e.prototype.pair=function(){var t,n=this;try{t=new Proxy({DANGER:"☠"},{get:function(t,e,r){if(n.is&&(n._||"").encryption)return n._.encryption[e]}})}catch(t){}return t},e.prototype.delete=async function(t,e,r){this.back(-1);var n=this.back("user");try{n.auth(t,e,function(t){(n.is||{}).pub;n.map().once(function(){this.put(null)}),n.leave(),(r||function(){})({ok:0})})}catch(t){}return this},e.prototype.alive=async function(){var e=this.back(-1);try{return await authRecall(e),e._.user._}catch(t){e="No session!";throw r.log(e),{err:e}}},e.prototype.trust=async function(t){r.is(t)&&t.get("pub").get((t,e)=>{console.log(t,e)}),t.get("trust").get(path).put(theirPubkey)},e.prototype.grant=function(o,a){var i=this.back(-1).user(),c=i._.encryption,s="";return this.back(function(t){t.is||(s+=t.get||"")}),async function(){var t=await i.get("grant").get(c.pub).get(s).then(),e=((t=await u.decrypt(t,c))||(t=u.random(16).toString(),n=await u.encrypt(t,c),i.get("grant").get(c.pub).get(s).put(n)),o.get("pub").then()),r=o.get("epub").then(),e=await e,r=await r,r=await u.secret(r,c),n=await u.encrypt(t,r);i.get("grant").get(e).get(s).put(n,a)}(),this},e.prototype.secret=function(r,n){var o=this,a=o.back(-1).user(),i=a.pair(),c="";return o.back(function(t){t.is||(c+=t.get||"")}),async function(){var t,e=await a.get("trust").get(i.pub).get(c).then();(e=await u.decrypt(e,i))||(e=u.random(16).toString(),t=await u.encrypt(e,i),a.get("trust").get(i.pub).get(c).put(t)),t=await u.encrypt(r,e),o.put(t,n)}(),o},t.exports=e})(v,"./share"),v(function(t){var h,w=v("./encryption"),g=v("./settings"),d=""+h!=typeof window?window.Database||{on:function(){}}:v((""+h==typeof c?".":"")+"./database",1);function p(e){var t,r,n=this,o=n.as,a=e.put,i=a["#"],c=a["."],s=a[":"],u=a[">"],f=e["#"];i&&c&&((e._||"").faith&&(o.opt||"").faith&&"function"==typeof e._?w.opt.pack(a,function(t){w.verify(t,!1,function(t){a["="]=w.opt.unpack(t),n.to.next(e)})}):(r=function(t){o.on("in",{"@":f,err:e.err=t})},(e._||"").DBG&&((e._||"").DBG.c=+new Date),0<=i.indexOf("<?")&&(t=parseFloat(i.split("<?")[1]||""))&&u<d.state()-1e3*t?(t=e._)&&t.stun&&t.stun--:"~@"===i?p.alias(n,e,s,c,i,o,r):"~@"===i.slice(0,2)?p.pubs(n,e,s,c,i,o,r):(t=w.opt.pub(i))?p.pub(n,e,s,c,i,o,r,o.user||"",t):0<=i.indexOf("#")?p.hash(n,e,s,c,i,o,r):p.any(n,e,s,c,i,o,r,o.user||"")))}d.on("opt",function(t){t.encryption||(t.encryption={own:{}},t.on("put",p,t)),this.to.next(t)}),p.hash=function(e,r,t,n,o,a,i){w.work(t,null,function(t){if(t&&t===n.split("#").slice(-1)[0])return e.to.next(r);i("Data hash not same as hash")},{name:"SHA-256"})},p.alias=function(t,e,r,n,o,a,i){return r?"~@"+n===b(r)?t.to.next(e):void i("Alias not same"):i("Data must exist")},p.pubs=function(t,e,r,n,o,a,i){return r?n===b(r)?t.to.next(e):void i("Alias not same"):i("Alias must exist")},p.pub=async function(i,c,r,s,u,n,f,o,p){var a;const y=await g.parse(r)||{},l=(t,o,a)=>{if(t.m&&t.s&&o&&p)return w.verify(t,p,e=>{if(h!==e&&h!==e.e&&c.put[">"]&&c.put[">"]>parseFloat(e.e))return f("Certificate expired.");if(h!==e&&e.c&&e.w&&(e.c===o||-1<e.c.indexOf("*"))){let t=-1<u.indexOf("/")?u.replace(u.substring(0,u.indexOf("/")+1),""):"";var r;String.match=String.match||d.text.match;for(const n of Array.isArray(e.w)?e.w:"object"==typeof e.w||"string"==typeof e.w?[e.w]:[])if(String.match(t,n["#"])&&String.match(s,n["."])||!n["."]&&String.match(t,n["#"])||!n["#"]&&String.match(s,n["."])||String.match(t?t+"/"+s:s,n["#"]||n))return n["+"]&&-1<n["+"].indexOf("*")&&t&&-1==t.indexOf(o)&&-1==s.indexOf(o)?f(`Path "${t}" or key "${s}" must contain string "${o}"`):e.wb&&("string"==typeof e.wb||(e.wb||{})["#"])?(r=i.as.root.$.back(-1),(r="string"==typeof e.wb&&"~"!==e.wb.slice(0,1)?r.get("~"+p):r).get(e.wb).get(o).once(t=>!t||1!==t&&!0!==t?a(e):f(`Certificant ${o} blocked`))):a(e);return f("Certificate verification fail.")}})};if("pub"===s&&"~"+p===u)return r===p?i.to.next(c):f("Account not same");(a=o.is)&&a.pub&&!y["*"]&&!y["+"]&&(p===a.pub||p!==a.pub&&((c._.msg||{}).opt||{}).cert)?w.opt.pack(c.put,t=>{w.sign(t,o._.encryption,async function(t){if(h===t)return f(w.err||"Signature fail");if(c.put[":"]={":":a=w.opt.unpack(t.m),"~":t.s},c.put["="]=a,p===o.is.pub)return(a=b(r))&&((n.encryption.own[a]=n.encryption.own[a]||{})[p]=1),void JSON.stringifyAsync(c.put[":"],function(t,e){return t?f(t||"Stringify error"):(c.put[":"]=e,i.to.next(c))});if(p!==o.is.pub&&((c._.msg||{}).opt||{}).cert){const e=await g.parse(c._.msg.opt.cert);e&&e.m&&e.s&&l(e,o.is.pub,t=>{c.put[":"]["+"]=e,c.put[":"]["*"]=o.is.pub,JSON.stringifyAsync(c.put[":"],function(t,e){return t?f(t||"Stringify error"):(c.put[":"]=e,i.to.next(c))})})}},{raw:1})}):w.opt.pack(c.put,t=>{w.verify(t,y["*"]||p,function(e){var t;return e=w.opt.unpack(e),h===e?f("Unverified data"):((t=b(e))&&p===w.opt.pub(t)&&((n.encryption.own[t]=n.encryption.own[t]||{})[p]=1),y["+"]&&y["+"].m&&y["+"].s&&y["*"]?void l(y["+"],y["*"],t=>(c.put["="]=e,i.to.next(c))):(c.put["="]=e,i.to.next(c)))})})},p.any=function(e,t,r,n,o,a,i,c){if(a.opt.secure)return i("Soul missing public key at '"+n+"'");a.on("secure",function(t){if(this.off(),!a.opt.secure)return e.to.next(t);i("Data cannot be changed")}).on.on("secure",t)};var r=d.valid,b=function(t,e){return"string"==typeof(e=r(t))&&e},e=((d.state||"").ify,/[^\w_-]/),o=(w.opt.pub=function(t){if((t=t&&((t=t.split("~"))&&t[1]))&&(t=t.split(e).slice(0,2))&&2==t.length&&"@"!==(t[0]||"")[0])return t=t.slice(0,2).join(".")},w.opt.stringy=function(t){},w.opt.pack=function(n,o,a,i,c){var t,e;if(w.opt.check(n))return o(n);n&&n["#"]&&n["."]&&n[">"]&&(t=n[":"],e=1),JSON.parseAsync(e?t:n,function(t,e){var r=h!==(e||"")[":"]&&(e||"")["~"];o(r?{m:{"#":c||n["#"],".":a||n["."],":":(e||"")[":"],">":n[">"]||d.state.is(i,a)},s:r}:n)})},w.opt),a=(w.opt.unpack=function(t,e,r){if(h!==t){if(t&&h!==(n=t[":"]))return n;if(e=e||o.fall_key,!r&&o.fall_val&&((r={})[e]=o.fall_val),e&&r){if(t===r[e])return t;if(!w.opt.check(r[e]))return t;var n=r&&r._&&r._["#"]||o.fall_soul,r=d.state.is(r,e)||o.fall_state;return t&&4===t.length&&n===t[0]&&e===t[1]&&a(r)===a(t[3])?t[2]:r<w.opt.shuffle_attack?t:void 0}}},w.opt.shuffle_attack=15463296e5,Math.floor)})(v,"./index")}();